{
  "schema_version": "x07.x07ast@0.3.0",
  "kind": "module",
  "module_id": "std.msg.amqp.topology",
  "imports": [
    "ext.data_model",
    "ext.json.data_model",
    "std.bytes",
    "std.fs",
    "std.text.ascii",
    "std.text.slices",
    "std.u32",
    "std.vec"
  ],
  "decls": [
    {
      "kind": "export",
      "names": [
        "std.msg.amqp.topology.declare_plan_v1",
        "std.msg.amqp.topology.read_from_arch_v1"
      ]
    },
    {
      "kind": "defn",
      "name": "std.msg.amqp.topology.read_from_arch_v1",
      "params": [
        { "name": "topology_id", "ty": "bytes_view" }
      ],
      "result": "result_bytes",
      "body": [
        "begin",
        ["let", "path", ["bytes.lit", "arch/msg/amqp/index.x07amqp.json"]],
        ["let", "raw", ["std.fs.read", ["bytes.view", "path"]]],
        ["let", "idx_doc", ["ext.json.data_model.parse", ["bytes.view", "raw"]]],
        ["let", "idxv", ["bytes.view", "idx_doc"]],
        ["if", ["=", ["ext.data_model.doc_is_err", "idxv"], 1], ["return", ["result_bytes.err", 9840]], 0],
        ["let", "root", ["ext.data_model.root_offset", "idxv"]],
        ["let", "k_topologies", ["bytes.lit", "topologies"]],
        ["let", "tops_off", ["ext.data_model.map_find", "idxv", "root", ["bytes.view", "k_topologies"]]],
        ["if", ["<", "tops_off", 0], ["return", ["result_bytes.err", 9841]], 0],
        ["let", "count", ["ext.data_model.seq_len", "idxv", "tops_off"]],
        ["if", ["<", "count", 0], ["return", ["result_bytes.err", 9841]], 0],
        ["let", "k_id", ["bytes.lit", "id"]],
        ["let", "k_path", ["bytes.lit", "path"]],
        ["let", "topo_path", ["bytes.alloc", 0]],
        [
          "for",
          "i",
          0,
          "count",
          [
            "begin",
            ["let", "ref_off", ["ext.data_model.seq_get", "idxv", "tops_off", "i"]],
            ["if", ["<", "ref_off", 0], 0, [
              "begin",
              ["let", "id_off", ["ext.data_model.map_find", "idxv", "ref_off", ["bytes.view", "k_id"]]],
              ["if", ["<", "id_off", 0], 0, [
                "begin",
                ["let", "id_b", ["ext.data_model.string_get", "idxv", "id_off"]],
                ["if", ["=", ["std.bytes.eq", ["bytes.view", "id_b"], "topology_id"], 1],
                  ["begin",
                    ["let", "p_off", ["ext.data_model.map_find", "idxv", "ref_off", ["bytes.view", "k_path"]]],
                    ["if", ["<", "p_off", 0], ["return", ["result_bytes.err", 9842]], 0],
                    ["set", "topo_path", ["ext.data_model.string_get", "idxv", "p_off"]],
                    0
                  ],
                  0
                ]
              ]]
            ]],
            0
          ]
        ],
        ["if", ["=", ["bytes.len", "topo_path"], 0], ["return", ["result_bytes.err", 9843]], 0],
        ["let", "raw_topo", ["std.fs.read", ["bytes.view", "topo_path"]]],
        ["let", "topo_doc", ["ext.json.data_model.parse", ["bytes.view", "raw_topo"]]],
        ["if", ["=", ["ext.data_model.doc_is_err", ["bytes.view", "topo_doc"]], 1], ["return", ["result_bytes.err", 9844]], 0],
        ["result_bytes.ok", "topo_doc"]
      ]
    },
    {
      "kind": "defn",
      "name": "std.msg.amqp.topology._append_line_v1",
      "params": [
        { "name": "out", "ty": "vec_u8" },
        { "name": "b", "ty": "bytes_view" }
      ],
      "result": "vec_u8",
      "body": [
        "begin",
        ["set", "out", ["std.vec.extend_bytes", "out", "b"]],
        ["set", "out", ["std.vec.push", "out", 10]],
        "out"
      ]
    },
    {
      "kind": "defn",
      "name": "std.msg.amqp.topology.declare_plan_v1",
      "params": [
        { "name": "topology_doc", "ty": "bytes_view" }
      ],
      "result": "bytes",
      "body": [
        "begin",
        ["if", ["=", ["ext.data_model.doc_is_err", "topology_doc"], 1], ["return", ["bytes.alloc", 0]], 0],
        ["let", "root", ["ext.data_model.root_offset", "topology_doc"]],
        ["let", "k_exchanges", ["bytes.lit", "exchanges"]],
        ["let", "k_queues", ["bytes.lit", "queues"]],
        ["let", "k_bindings", ["bytes.lit", "bindings"]],
        ["let", "ex_off", ["ext.data_model.map_find", "topology_doc", "root", ["bytes.view", "k_exchanges"]]],
        ["let", "q_off", ["ext.data_model.map_find", "topology_doc", "root", ["bytes.view", "k_queues"]]],
        ["let", "b_off", ["ext.data_model.map_find", "topology_doc", "root", ["bytes.view", "k_bindings"]]],
        ["let", "out", ["std.vec.with_capacity", 512]],
        ["let", "k_name", ["bytes.lit", "name"]],
        ["let", "k_type", ["bytes.lit", "type"]],
        ["let", "k_exchange", ["bytes.lit", "exchange"]],
        ["let", "k_queue", ["bytes.lit", "queue"]],
        ["let", "k_routing_key", ["bytes.lit", "routing_key"]],
        [
          "if",
          [">=", "ex_off", 0],
          [
            "begin",
            ["let", "count", ["ext.data_model.seq_len", "topology_doc", "ex_off"]],
            [
              "for",
              "i",
              0,
              "count",
              [
                "begin",
                ["let", "off", ["ext.data_model.seq_get", "topology_doc", "ex_off", "i"]],
                ["if", ["<", "off", 0], 0, [
                  "begin",
                  ["let", "name_off", ["ext.data_model.map_find", "topology_doc", "off", ["bytes.view", "k_name"]]],
                  ["let", "type_off", ["ext.data_model.map_find", "topology_doc", "off", ["bytes.view", "k_type"]]],
                  ["if", ["if", ["<", "name_off", 0], 1, ["<", "type_off", 0]], 0, [
                    "begin",
                    ["let", "name", ["ext.data_model.string_get", "topology_doc", "name_off"]],
                    ["let", "typ", ["ext.data_model.string_get", "topology_doc", "type_off"]],
                    ["set", "out", ["std.msg.amqp.topology._append_line_v1", "out", ["bytes.lit", "exchange:"]]],
                    ["set", "out", ["std.msg.amqp.topology._append_line_v1", "out", ["bytes.view", "typ"]]],
                    ["set", "out", ["std.msg.amqp.topology._append_line_v1", "out", ["bytes.view", "name"]]],
                    0
                  ]],
                  0
                ]],
                0
              ]
            ],
            0
          ],
          0
        ],
        [
          "if",
          [">=", "q_off", 0],
          [
            "begin",
            ["let", "count", ["ext.data_model.seq_len", "topology_doc", "q_off"]],
            [
              "for",
              "i",
              0,
              "count",
              [
                "begin",
                ["let", "off", ["ext.data_model.seq_get", "topology_doc", "q_off", "i"]],
                ["if", ["<", "off", 0], 0, [
                  "begin",
                  ["let", "name_off", ["ext.data_model.map_find", "topology_doc", "off", ["bytes.view", "k_name"]]],
                  ["if", ["<", "name_off", 0], 0, [
                    "begin",
                    ["let", "name", ["ext.data_model.string_get", "topology_doc", "name_off"]],
                    ["set", "out", ["std.msg.amqp.topology._append_line_v1", "out", ["bytes.lit", "queue:"]]],
                    ["set", "out", ["std.msg.amqp.topology._append_line_v1", "out", ["bytes.view", "name"]]],
                    0
                  ]],
                  0
                ]],
                0
              ]
            ],
            0
          ],
          0
        ],
        [
          "if",
          [">=", "b_off", 0],
          [
            "begin",
            ["let", "count", ["ext.data_model.seq_len", "topology_doc", "b_off"]],
            [
              "for",
              "i",
              0,
              "count",
              [
                "begin",
                ["let", "off", ["ext.data_model.seq_get", "topology_doc", "b_off", "i"]],
                ["if", ["<", "off", 0], 0, [
                  "begin",
                  ["let", "ex2_off", ["ext.data_model.map_find", "topology_doc", "off", ["bytes.view", "k_exchange"]]],
                  ["let", "q2_off", ["ext.data_model.map_find", "topology_doc", "off", ["bytes.view", "k_queue"]]],
                  ["let", "rk_off", ["ext.data_model.map_find", "topology_doc", "off", ["bytes.view", "k_routing_key"]]],
                  ["if", ["if", ["<", "ex2_off", 0], 1, ["if", ["<", "q2_off", 0], 1, ["<", "rk_off", 0]]], 0, [
                    "begin",
                    ["let", "ex2", ["ext.data_model.string_get", "topology_doc", "ex2_off"]],
                    ["let", "q2", ["ext.data_model.string_get", "topology_doc", "q2_off"]],
                    ["let", "rk", ["ext.data_model.string_get", "topology_doc", "rk_off"]],
                    ["set", "out", ["std.msg.amqp.topology._append_line_v1", "out", ["bytes.lit", "bind:"]]],
                    ["set", "out", ["std.msg.amqp.topology._append_line_v1", "out", ["bytes.view", "ex2"]]],
                    ["set", "out", ["std.msg.amqp.topology._append_line_v1", "out", ["bytes.view", "q2"]]],
                    ["set", "out", ["std.msg.amqp.topology._append_line_v1", "out", ["bytes.view", "rk"]]],
                    0
                  ]],
                  0
                ]],
                0
              ]
            ],
            0
          ],
          0
        ],
        ["std.vec.as_bytes", "out"]
      ]
    }
  ]
}
