{"decls":[{"kind":"export","names":["ext.zip.code_checksum_mismatch","ext.zip.code_duplicate_name","ext.zip.code_invalid_header","ext.zip.code_invalid_zip","ext.zip.code_not_found","ext.zip.code_output_limit","ext.zip.code_truncated","ext.zip.err_code","ext.zip.extract_file_v1","ext.zip.get_bytes","ext.zip.get_view","ext.zip.is_err","ext.zip.list_names_v1","ext.zip.out_len"]},{"body":["begin",["let","n",["view.len","zip"]],["let","eocd_off",["ext.zip._find_eocd_off","zip"]],["if",["<","eocd_off",0],["return",["ext.zip._info_err",["ext.zip.code_invalid_header"]]],0],["let","disk",["ext.zip._read_u16_le","zip",["+","eocd_off",4]]],["let","disk_cd",["ext.zip._read_u16_le","zip",["+","eocd_off",6]]],["let","entries_disk",["ext.zip._read_u16_le","zip",["+","eocd_off",8]]],["let","entries_total",["ext.zip._read_u16_le","zip",["+","eocd_off",10]]],["if",["=",["=","disk",0],0],["return",["ext.zip._info_err",["ext.zip.code_invalid_header"]]],0],["if",["=",["=","disk_cd",0],0],["return",["ext.zip._info_err",["ext.zip.code_invalid_header"]]],0],["if",["=",["=","entries_disk","entries_total"],0],["return",["ext.zip._info_err",["ext.zip.code_invalid_header"]]],0],["let","cd_size",["codec.read_u32_le","zip",["+","eocd_off",12]]],["let","cd_off",["codec.read_u32_le","zip",["+","eocd_off",16]]],["if",["<","cd_size",0],["return",["ext.zip._info_err",["ext.zip.code_invalid_header"]]],0],["if",["<","cd_off",0],["return",["ext.zip._info_err",["ext.zip.code_invalid_header"]]],0],["if",["<u","n","cd_off"],["return",["ext.zip._info_err",["ext.zip.code_truncated"]]],0],["if",["<u","n",["+","cd_off","cd_size"]],["return",["ext.zip._info_err",["ext.zip.code_truncated"]]],0],["let","out",["vec_u8.with_capacity",16]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le",0]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","cd_off"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","cd_size"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","entries_total"]]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"ext.zip._eocd_info","params":[{"name":"zip","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","a"]],["if",["=",["=","n",["view.len","b"]],0],["return",0],0],["for","i",0,"n",["if",["=",["=",["view.get_u8","a","i"],["view.get_u8","b","i"]],0],["return",0],0]],1],"kind":"defn","name":"ext.zip._eq_view","params":[{"name":"a","ty":"bytes_view"},{"name":"b","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","n",["view.len","zip"]],["let","flags",["ext.zip._read_u16_le","zip",["+","cd_pos",8]]],["let","method",["ext.zip._read_u16_le","zip",["+","cd_pos",10]]],["let","expected_crc",["codec.read_u32_le","zip",["+","cd_pos",16]]],["let","comp_size",["codec.read_u32_le","zip",["+","cd_pos",20]]],["let","uncomp_size",["codec.read_u32_le","zip",["+","cd_pos",24]]],["let","local_off",["codec.read_u32_le","zip",["+","cd_pos",42]]],["if",["<","comp_size",0],["return",["ext.zip._make_err",["ext.zip.code_invalid_header"]]],0],["if",["<","uncomp_size",0],["return",["ext.zip._make_err",["ext.zip.code_invalid_header"]]],0],["if",["<","local_off",0],["return",["ext.zip._make_err",["ext.zip.code_invalid_header"]]],0],["if",["<u","max_out_bytes","uncomp_size"],["return",["ext.zip._make_err",["ext.zip.code_output_limit"]]],0],["if",["=",["=",["&","flags",1],0],0],["return",["ext.zip._make_err",["ext.zip.code_invalid_zip"]]],0],["if",["<u","n",["+","local_off",30]],["return",["ext.zip._make_err",["ext.zip.code_truncated"]]],0],["if",["=",["=",["codec.read_u32_le","zip","local_off"],67324752],0],["return",["ext.zip._make_err",["ext.zip.code_invalid_zip"]]],0],["let","lf_name_len",["ext.zip._read_u16_le","zip",["+","local_off",26]]],["let","lf_extra_len",["ext.zip._read_u16_le","zip",["+","local_off",28]]],["let","data_start",["+","local_off",["+",30,["+","lf_name_len","lf_extra_len"]]]],["if",["<u","n","data_start"],["return",["ext.zip._make_err",["ext.zip.code_truncated"]]],0],["if",["<u","n",["+","data_start","comp_size"]],["return",["ext.zip._make_err",["ext.zip.code_truncated"]]],0],["let","comp",["view.slice","zip","data_start","comp_size"]],["if",["=","method",0],["begin",["if",["=",["=","comp_size","uncomp_size"],0],["return",["ext.zip._make_err",["ext.zip.code_invalid_zip"]]],0],["if",["<u","max_out_bytes","comp_size"],["return",["ext.zip._make_err",["ext.zip.code_output_limit"]]],0],["let","payload",["view.to_bytes","comp"]],["let","actual_crc",["ext.compress.crc32",["bytes.view","payload"]]],["if",["=",["=","actual_crc","expected_crc"],0],["return",["ext.zip._make_err",["ext.zip.code_checksum_mismatch"]]],0],["return",["ext.zip._ok","payload"]]],["if",["=","method",8],["begin",["let","doc",["ext.compress.inflate_raw","comp","max_out_bytes"]],["let","docv",["bytes.view","doc"]],["if",["ext.compress.is_err","docv"],["begin",["let","c",["ext.compress.err_code","docv"]],["if",["=","c",["ext.compress.code_output_limit"]],["return",["ext.zip._make_err",["ext.zip.code_output_limit"]]],0],["if",["=","c",["ext.compress.code_truncated"]],["return",["ext.zip._make_err",["ext.zip.code_truncated"]]],0],["return",["ext.zip._make_err",["ext.zip.code_invalid_zip"]]]],0],["if",["=",["=",["ext.compress.out_len","docv"],"uncomp_size"],0],["return",["ext.zip._make_err",["ext.zip.code_invalid_zip"]]],0],["let","payload",["ext.compress.get_bytes","docv"]],["let","actual_crc",["ext.compress.crc32",["bytes.view","payload"]]],["if",["=",["=","actual_crc","expected_crc"],0],["return",["ext.zip._make_err",["ext.zip.code_checksum_mismatch"]]],0],["return",["ext.zip._ok","payload"]]],["ext.zip._make_err",["ext.zip.code_invalid_zip"]]]]],"kind":"defn","name":"ext.zip._extract_from_cd","params":[{"name":"zip","ty":"bytes_view"},{"name":"max_out_bytes","ty":"i32"},{"name":"cd_pos","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","zip"]],["if",["<u","n",22],["return",-1],0],["let","scan",["+",22,65535]],["let","min_off",["if",["<u","n","scan"],0,["-","n","scan"]]],["let","pos",["-","n",22]],["for","_",0,["+","scan",1],["begin",["if",["=",["codec.read_u32_le","zip","pos"],101010256],["begin",["let","com_len",["ext.zip._read_u16_le","zip",["+","pos",20]]],["if",["=",["+","pos",["+","com_len",22]],"n"],["return","pos"],0]],0],["if",["=","pos","min_off"],["return",-1],0],["set","pos",["-","pos",1]],0]],-1],"kind":"defn","name":"ext.zip._find_eocd_off","params":[{"name":"zip","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","out",["vec_u8.with_capacity",16]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","code"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le",0]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le",0]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le",0]]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"ext.zip._info_err","params":[{"name":"code","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","out",["vec_u8.with_capacity",9]],["set","out",["vec_u8.push","out",0]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le","code"]]],["set","out",["vec_u8.extend_bytes","out",["codec.write_u32_le",0]]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"ext.zip._make_err","params":[{"name":"code","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","n",["bytes.len","payload"]],["let","out",["vec_u8.with_capacity",["+","n",1]]],["set","out",["vec_u8.push","out",1]],["set","out",["vec_u8.extend_bytes","out","payload"]],["vec_u8.into_bytes","out"]],"kind":"defn","name":"ext.zip._ok","params":[{"name":"payload","ty":"bytes"}],"result":"bytes"},{"body":["begin",["let","b0",["view.get_u8","b","off"]],["let","b1",["view.get_u8","b",["+","off",1]]],["|","b0",["<<u","b1",8]]],"kind":"defn","name":"ext.zip._read_u16_le","params":[{"name":"b","ty":"bytes_view"},{"name":"off","ty":"i32"}],"result":"i32"},{"body":4,"kind":"defn","name":"ext.zip.code_checksum_mismatch","params":[],"result":"i32"},{"body":7,"kind":"defn","name":"ext.zip.code_duplicate_name","params":[],"result":"i32"},{"body":2,"kind":"defn","name":"ext.zip.code_invalid_header","params":[],"result":"i32"},{"body":3,"kind":"defn","name":"ext.zip.code_invalid_zip","params":[],"result":"i32"},{"body":6,"kind":"defn","name":"ext.zip.code_not_found","params":[],"result":"i32"},{"body":5,"kind":"defn","name":"ext.zip.code_output_limit","params":[],"result":"i32"},{"body":1,"kind":"defn","name":"ext.zip.code_truncated","params":[],"result":"i32"},{"body":["begin",["if",["<",["view.len","doc"],5],["return",0],0],["if",["=",["=",["view.get_u8","doc",0],0],0],["return",0],0],["codec.read_u32_le","doc",1]],"kind":"defn","name":"ext.zip.err_code","params":[{"name":"doc","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<","max_out_bytes",0],["return",["ext.zip._make_err",["ext.zip.code_output_limit"]]],0],["let","info_b",["ext.zip._eocd_info","zip"]],["let","info",["bytes.view","info_b"]],["let","status",["codec.read_u32_le","info",0]],["if",["=",["=","status",0],0],["return",["ext.zip._make_err","status"]],0],["let","cd_off",["codec.read_u32_le","info",4]],["let","cd_size",["codec.read_u32_le","info",8]],["let","total",["codec.read_u32_le","info",12]],["let","cd_end",["+","cd_off","cd_size"]],["let","pos","cd_off"],["let","target_len",["view.len","name"]],["for","i",0,"total",["begin",["if",["<u","cd_end",["+","pos",46]],["return",["ext.zip._make_err",["ext.zip.code_truncated"]]],0],["if",["=",["=",["codec.read_u32_le","zip","pos"],33639248],0],["return",["ext.zip._make_err",["ext.zip.code_invalid_zip"]]],0],["let","name_len",["ext.zip._read_u16_le","zip",["+","pos",28]]],["let","extra_len",["ext.zip._read_u16_le","zip",["+","pos",30]]],["let","comment_len",["ext.zip._read_u16_le","zip",["+","pos",32]]],["let","rec_len",["+",46,["+","name_len",["+","extra_len","comment_len"]]]],["if",["<u","cd_end",["+","pos","rec_len"]],["return",["ext.zip._make_err",["ext.zip.code_truncated"]]],0],["let","name_off",["+","pos",46]],["let","name_view",["view.slice","zip","name_off","name_len"]],["if",["if",["=",["=","name_len","target_len"],0],0,["ext.zip._eq_view","name_view","name"]],["return",["ext.zip._extract_from_cd","zip","max_out_bytes","pos"]],0],["set","pos",["+","pos","rec_len"]],0]],["ext.zip._make_err",["ext.zip.code_not_found"]]],"kind":"defn","name":"ext.zip.extract_file_v1","params":[{"name":"zip","ty":"bytes_view"},{"name":"name","ty":"bytes_view"},{"name":"max_out_bytes","ty":"i32"}],"result":"bytes"},{"body":["view.to_bytes",["ext.zip.get_view","doc"]],"kind":"defn","name":"ext.zip.get_bytes","params":[{"name":"doc","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","doc"]],["if",["<","n",1],["return",["view.slice","doc",0,0]],0],["if",["=",["=",["view.get_u8","doc",0],1],0],["return",["view.slice","doc",0,0]],0],["view.slice","doc",1,["-","n",1]]],"kind":"defn","name":"ext.zip.get_view","params":[{"name":"doc","ty":"bytes_view"}],"result":"bytes_view"},{"body":["begin",["if",["<",["view.len","doc"],1],["return",1],0],["=",["view.get_u8","doc",0],0]],"kind":"defn","name":"ext.zip.is_err","params":[{"name":"doc","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["<","max_entries",0],["return",["ext.zip._make_err",["ext.zip.code_output_limit"]]],0],["if",["<","max_total_name_bytes",0],["return",["ext.zip._make_err",["ext.zip.code_output_limit"]]],0],["let","info_b",["ext.zip._eocd_info","zip"]],["let","info",["bytes.view","info_b"]],["let","status",["codec.read_u32_le","info",0]],["if",["=",["=","status",0],0],["return",["ext.zip._make_err","status"]],0],["let","cd_off",["codec.read_u32_le","info",4]],["let","cd_size",["codec.read_u32_le","info",8]],["let","total",["codec.read_u32_le","info",12]],["if",["<u","max_entries","total"],["return",["ext.zip._make_err",["ext.zip.code_output_limit"]]],0],["let","cd_end",["+","cd_off","cd_size"]],["let","pos","cd_off"],["let","set",["std.small_set.empty_bytes"]],["let","name_bytes_total",0],["for","i",0,"total",["begin",["if",["<u","cd_end",["+","pos",46]],["return",["ext.zip._make_err",["ext.zip.code_truncated"]]],0],["if",["=",["=",["codec.read_u32_le","zip","pos"],33639248],0],["return",["ext.zip._make_err",["ext.zip.code_invalid_zip"]]],0],["let","name_len",["ext.zip._read_u16_le","zip",["+","pos",28]]],["let","extra_len",["ext.zip._read_u16_le","zip",["+","pos",30]]],["let","comment_len",["ext.zip._read_u16_le","zip",["+","pos",32]]],["let","rec_len",["+",46,["+","name_len",["+","extra_len","comment_len"]]]],["if",["<u","cd_end",["+","pos","rec_len"]],["return",["ext.zip._make_err",["ext.zip.code_truncated"]]],0],["if",["<u","max_total_name_bytes",["+","name_bytes_total","name_len"]],["return",["ext.zip._make_err",["ext.zip.code_output_limit"]]],0],["let","name_off",["+","pos",46]],["let","name_view",["view.slice","zip","name_off","name_len"]],["let","name_b",["view.to_bytes","name_view"]],["begin",["let","before_len",["bytes.len","set"]],["let","new_set",["std.small_set.insert_bytes","set","name_b"]],["let","after_len",["bytes.len","new_set"]],["if",["=","before_len","after_len"],["return",["ext.zip._make_err",["ext.zip.code_duplicate_name"]]],0],["set","set","new_set"],0],0,0,["set","name_bytes_total",["+","name_bytes_total","name_len"]],["set","pos",["+","pos","rec_len"]],0]],["if",["=",["=","pos","cd_end"],0],["return",["ext.zip._make_err",["ext.zip.code_invalid_zip"]]],0],["ext.zip._ok","set"]],"kind":"defn","name":"ext.zip.list_names_v1","params":[{"name":"zip","ty":"bytes_view"},{"name":"max_entries","ty":"i32"},{"name":"max_total_name_bytes","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","doc"]],["if",["<","n",1],["return",0],0],["if",["=",["=",["view.get_u8","doc",0],1],0],["return",0],0],["-","n",1]],"kind":"defn","name":"ext.zip.out_len","params":[{"name":"doc","ty":"bytes_view"}],"result":"i32"}],"imports":["ext.compress","std.small_set"],"kind":"module","module_id":"ext.zip","schema_version":"x07.x07ast@0.1.0"}
