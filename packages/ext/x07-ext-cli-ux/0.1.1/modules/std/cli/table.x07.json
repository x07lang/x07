{
  "schema_version": "x07.x07ast@0.3.0",
  "kind": "module",
  "module_id": "std.cli.table",
  "imports": [
    "ext.data_model",
    "std.bytes",
    "std.cli.profile",
    "std.fmt",
    "std.text.slices",
    "std.u32",
    "std.vec"
  ],
  "decls": [
    {
      "kind": "export",
      "names": [
        "std.cli.table.render_v1"
      ]
    },
    {
      "kind": "defn",
      "name": "std.cli.table._cell_text_v1",
      "params": [
        { "name": "doc", "ty": "bytes_view" },
        { "name": "off", "ty": "i32" }
      ],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "kind", ["ext.data_model.kind_at", "doc", "off"]],
        ["if", ["=", "kind", 3], ["return", ["ext.data_model.string_get", "doc", "off"]], 0],
        ["if", ["=", "kind", 2], ["return", ["ext.data_model.number_get", "doc", "off"]], 0],
        ["bytes.alloc", 0]
      ]
    },
    {
      "kind": "defn",
      "name": "std.cli.table.render_v1",
      "params": [
        { "name": "profile_doc", "ty": "bytes_view" },
        { "name": "table_doc", "ty": "bytes_view" }
      ],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "mlb", ["std.cli.profile.max_line_bytes_v1", "profile_doc"]],
        ["if", ["=", ["ext.data_model.doc_is_err", "table_doc"], 1], ["return", ["bytes.alloc", 0]], 0],
        ["let", "root", ["ext.data_model.root_offset", "table_doc"]],
        ["let", "k_headers", ["bytes.lit", "headers"]],
        ["let", "k_rows", ["bytes.lit", "rows"]],
        ["let", "headers_off", ["ext.data_model.map_find", "table_doc", "root", ["bytes.view", "k_headers"]]],
        ["let", "rows_off", ["ext.data_model.map_find", "table_doc", "root", ["bytes.view", "k_rows"]]],
        ["if", ["if", ["<", "headers_off", 0], 1, ["<", "rows_off", 0]], ["return", ["bytes.alloc", 0]], 0],
        ["let", "cols", ["ext.data_model.seq_len", "table_doc", "headers_off"]],
        ["if", ["<", "cols", 1], ["return", ["bytes.alloc", 0]], 0],
        ["let", "widths", ["bytes.alloc", ["*", "cols", 4]]],
        ["for", "c", 0, "cols", ["begin",
          ["let", "h_off", ["ext.data_model.seq_get", "table_doc", "headers_off", "c"]],
          ["let", "h", ["std.cli.table._cell_text_v1", "table_doc", "h_off"]],
          ["let", "w", ["bytes.len", "h"]],
          ["set", "widths", ["std.u32.write_le_at", "widths", ["*", "c", 4], "w"]],
          0
        ]],
        ["let", "row_count", ["ext.data_model.seq_len", "table_doc", "rows_off"]],
        [
          "for",
          "r",
          0,
          "row_count",
          [
            "begin",
            ["let", "row_off", ["ext.data_model.seq_get", "table_doc", "rows_off", "r"]],
            ["let", "row_cols", ["ext.data_model.seq_len", "table_doc", "row_off"]],
            ["if", ["!=", "row_cols", "cols"], ["return", ["bytes.alloc", 0]], 0],
            ["for", "c", 0, "cols", ["begin",
              ["let", "cell_off", ["ext.data_model.seq_get", "table_doc", "row_off", "c"]],
              ["let", "cell", ["std.cli.table._cell_text_v1", "table_doc", "cell_off"]],
              ["let", "w", ["bytes.len", "cell"]],
              ["let", "prev", ["std.u32.read_le_at", ["bytes.view", "widths"], ["*", "c", 4]]],
              ["if", ["<u", "prev", "w"], ["set", "widths", ["std.u32.write_le_at", "widths", ["*", "c", 4], "w"]], 0],
              0
            ]],
            0
          ]
        ],
        ["let", "out", ["std.vec.with_capacity", 512]],
        ["let", "sep", ["bytes.lit", " | "]],
        ["for", "c", 0, "cols", ["begin",
          ["if", ["=", "c", 0], 0, ["set", "out", ["std.vec.extend_bytes", "out", ["bytes.view", "sep"]]]],
          ["let", "h_off", ["ext.data_model.seq_get", "table_doc", "headers_off", "c"]],
          ["let", "h", ["std.cli.table._cell_text_v1", "table_doc", "h_off"]],
          ["set", "out", ["std.vec.extend_bytes", "out", ["bytes.view", "h"]]],
          ["let", "w", ["bytes.len", "h"]],
          ["let", "need", ["std.u32.read_le_at", ["bytes.view", "widths"], ["*", "c", 4]]],
          ["for", "_", "w", "need", ["set", "out", ["std.vec.push", "out", 32]]],
          0
        ]],
        ["set", "out", ["std.vec.push", "out", 10]],
        [
          "for",
          "r",
          0,
          "row_count",
          [
            "begin",
            ["let", "row_off", ["ext.data_model.seq_get", "table_doc", "rows_off", "r"]],
            ["for", "c", 0, "cols", ["begin",
              ["if", ["=", "c", 0], 0, ["set", "out", ["std.vec.extend_bytes", "out", ["bytes.view", "sep"]]]],
              ["let", "cell_off", ["ext.data_model.seq_get", "table_doc", "row_off", "c"]],
              ["let", "cell", ["std.cli.table._cell_text_v1", "table_doc", "cell_off"]],
              ["set", "out", ["std.vec.extend_bytes", "out", ["bytes.view", "cell"]]],
              ["let", "w", ["bytes.len", "cell"]],
              ["let", "need", ["std.u32.read_le_at", ["bytes.view", "widths"], ["*", "c", 4]]],
              ["for", "_", "w", "need", ["set", "out", ["std.vec.push", "out", 32]]],
              0
            ]],
            ["set", "out", ["std.vec.push", "out", 10]],
            0
          ]
        ],
        ["let", "b", ["std.vec.as_bytes", "out"]],
        ["if", ["<u", "mlb", 1], ["return", "b"], 0],
        ["if", ["<u", ["bytes.len", "b"], "mlb"], ["return", "b"], 0],
        ["std.bytes.slice", ["bytes.view", "b"], 0, "mlb"]
      ]
    }
  ]
}
