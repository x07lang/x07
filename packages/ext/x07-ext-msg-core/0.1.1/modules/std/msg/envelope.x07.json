{
  "schema_version": "x07.x07ast@0.3.0",
  "kind": "module",
  "module_id": "std.msg.envelope",
  "imports": [
    "ext.data_model",
    "ext.unicode",
    "std.bytes",
    "std.msg.spec"
  ],
  "decls": [
    {
      "kind": "export",
      "names": [
        "std.msg.envelope.decode_v1",
        "std.msg.envelope.encode_v1"
      ]
    },
    {
      "kind": "defn",
      "name": "std.msg.envelope._u32_at_or_neg_v1",
      "params": [
        { "name": "b", "ty": "bytes_view" },
        { "name": "off", "ty": "i32" }
      ],
      "result": "i32",
      "body": [
        "begin",
        ["let", "n", ["view.len", "b"]],
        ["if", ["<", "off", 0], ["return", -1], 0],
        ["if", [">=u", ["+", "off", 4], ["+", "n", 1]], ["return", -1], 0],
        ["codec.read_u32_le", "b", "off"]
      ]
    },
    {
      "kind": "defn",
      "name": "std.msg.envelope._is_ascii_v1",
      "params": [
        { "name": "b", "ty": "bytes_view" }
      ],
      "result": "i32",
      "body": [
        "begin",
        ["let", "n", ["view.len", "b"]],
        ["for", "i", 0, "n", [
          "begin",
          ["let", "c", ["view.get_u8", "b", "i"]],
          ["if", [">", "c", 127], ["return", 0], 0],
          0
        ]],
        1
      ]
    },
    {
      "kind": "defn",
      "name": "std.msg.envelope._headers_encode_v1",
      "params": [
        { "name": "headers_doc", "ty": "bytes_view" }
      ],
      "result": "result_bytes",
      "body": [
        "begin",
        [
          "if",
          ["=", ["view.len", "headers_doc"], 0],
          ["result_bytes.ok", ["codec.write_u32_le", 0]],
          [
            "begin",
            ["if", ["=", ["ext.data_model.doc_is_err", "headers_doc"], 1], ["return", ["result_bytes.err", 9503]], 0],
            ["if", ["!=", ["ext.data_model.root_kind", "headers_doc"], 5], ["return", ["result_bytes.err", 9503]], 0],
            ["let", "root", ["ext.data_model.root_offset", "headers_doc"]],
            ["let", "count", ["ext.data_model.map_len", "headers_doc", "root"]],
            ["if", ["<", "count", 0], ["return", ["result_bytes.err", 9503]], 0],
            ["let", "out", ["vec_u8.with_capacity", ["+", 64, ["*", "count", 16]]]],
            ["set", "out", ["vec_u8.extend_bytes", "out", ["codec.write_u32_le", "count"]]],
            ["let", "have_prev", 0],
            ["let", "prev", ["bytes.alloc", 0]],
            [
              "for",
              "i",
              0,
              "count",
              [
                "begin",
                ["let", "k_b", ["ext.data_model.map_key_at", "headers_doc", "root", "i"]],
                ["if", ["=", ["bytes.len", "k_b"], 0], ["return", ["result_bytes.err", 9504]], 0],
                ["if", ["=", ["std.msg.envelope._is_ascii_v1", ["bytes.view", "k_b"]], 0], ["return", ["result_bytes.err", 9504]], 0],
                [
                  "if",
                  ["=", "have_prev", 1],
                  [
                    "begin",
                    ["let", "cmp", ["bytes.cmp_range", "prev", 0, ["bytes.len", "prev"], "k_b", 0, ["bytes.len", "k_b"]]],
                    ["if", [">=", "cmp", 0], ["return", ["result_bytes.err", 9504]], 0],
                    0
                  ],
                  0
                ],
                ["let", "v_off", ["ext.data_model.map_value_at", "headers_doc", "root", "i"]],
                ["if", ["<", "v_off", 0], ["return", ["result_bytes.err", 9503]], 0],
                ["if", ["!=", ["ext.data_model.kind_at", "headers_doc", "v_off"], 3], ["return", ["result_bytes.err", 9503]], 0],
                ["let", "v_b", ["ext.data_model.string_get", "headers_doc", "v_off"]],
                ["let", "v", ["bytes.view", "v_b"]],
                ["if", ["=", ["ext.unicode.unicode_utf8_is_valid", "v"], 0], ["return", ["result_bytes.err", 9505]], 0],
                ["set", "out", ["vec_u8.extend_bytes", "out", ["codec.write_u32_le", ["bytes.len", "k_b"]]]],
                ["set", "out", ["vec_u8.extend_bytes", "out", ["bytes.view", "k_b"]]],
                ["set", "out", ["vec_u8.extend_bytes", "out", ["codec.write_u32_le", ["bytes.len", "v_b"]]]],
                ["set", "out", ["vec_u8.extend_bytes", "out", "v"]],
                ["set", "prev", "k_b"],
                ["set", "have_prev", 1],
                0
              ]
            ],
            ["result_bytes.ok", ["vec_u8.into_bytes", "out"]]
          ]
        ]
      ]
    },
    {
      "kind": "defn",
      "name": "std.msg.envelope.encode_v1",
      "params": [
        { "name": "topic_id", "ty": "bytes_view" },
        { "name": "key_bytes", "ty": "bytes_view" },
        { "name": "value_bytes", "ty": "bytes_view" },
        { "name": "headers_doc", "ty": "bytes_view" }
      ],
      "result": "result_bytes",
      "body": [
        "budget.scope_from_arch_v1",
        ["bytes.lit", "msg_core_v1"],
        [
          "begin",
          ["let", "max_value", ["std.msg.spec.topic_max_value_bytes_from_arch_v1", "topic_id"]],
          ["if", ["<", "max_value", 1], ["return", ["result_bytes.err", 9501]], 0],
          ["let", "vlen", ["view.len", "value_bytes"]],
          ["if", ["if", [">=", "max_value", 1], ["<u", ["+", "max_value", 1], ["+", "vlen", 1]], 0], ["return", ["result_bytes.err", 9502]], 0],
          ["let", "hdr_res", ["std.msg.envelope._headers_encode_v1", "headers_doc"]],
          ["if", ["!=", ["result_bytes.err_code", "hdr_res"], 0], ["return", "hdr_res"], 0],
          ["let", "hdr_b", ["result_bytes.unwrap_or", "hdr_res", ["bytes.alloc", 0]]],
          ["let", "hdr_len", ["bytes.len", "hdr_b"]],
          ["let", "magic", ["bytes.lit", "X7ME"]],
          ["let", "payload", ["vec_u8.with_capacity", ["+", 64, ["+", ["view.len", "topic_id"], ["+", ["view.len", "key_bytes"], ["+", ["view.len", "value_bytes"], "hdr_len"]]]]]],
          ["set", "payload", ["vec_u8.extend_bytes", "payload", ["bytes.view", "magic"]]],
          ["set", "payload", ["vec_u8.extend_bytes", "payload", ["codec.write_u32_le", 1]]],
          ["set", "payload", ["vec_u8.extend_bytes", "payload", ["codec.write_u32_le", ["view.len", "topic_id"]]]],
          ["set", "payload", ["vec_u8.extend_bytes", "payload", "topic_id"]],
          ["set", "payload", ["vec_u8.extend_bytes", "payload", ["codec.write_u32_le", ["view.len", "key_bytes"]]]],
          ["set", "payload", ["vec_u8.extend_bytes", "payload", "key_bytes"]],
          ["set", "payload", ["vec_u8.extend_bytes", "payload", ["codec.write_u32_le", ["view.len", "value_bytes"]]]],
          ["set", "payload", ["vec_u8.extend_bytes", "payload", "value_bytes"]],
          ["set", "payload", ["vec_u8.extend_bytes", "payload", ["codec.write_u32_le", "hdr_len"]]],
          ["set", "payload", ["vec_u8.extend_bytes", "payload", ["bytes.view", "hdr_b"]]],
          ["let", "payload_b", ["vec_u8.into_bytes", "payload"]],
          ["let", "payload_len", ["bytes.len", "payload_b"]],
          ["if", ["<", "payload_len", 0], ["return", ["result_bytes.err", 9506]], 0],
          ["let", "out", ["vec_u8.with_capacity", ["+", "payload_len", 4]]],
          ["set", "out", ["vec_u8.extend_bytes", "out", ["codec.write_u32_le", "payload_len"]]],
          ["set", "out", ["vec_u8.extend_bytes", "out", ["bytes.view", "payload_b"]]],
          ["result_bytes.ok", ["vec_u8.into_bytes", "out"]]
        ]
      ]
    },
    {
      "kind": "defn",
      "name": "std.msg.envelope._headers_decode_v1",
      "params": [
        { "name": "hdr", "ty": "bytes_view" }
      ],
      "result": "result_bytes",
      "body": [
        "begin",
        ["let", "n", ["view.len", "hdr"]],
        ["if", ["<", "n", 4], ["return", ["result_bytes.err", 9509]], 0],
        ["let", "count", ["std.msg.envelope._u32_at_or_neg_v1", "hdr", 0]],
        ["if", ["<", "count", 0], ["return", ["result_bytes.err", 9509]], 0],
        ["let", "pos", 4],
        ["let", "entries", ["vec_u8.with_capacity", ["+", 4, ["*", "count", 16]]]],
        ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", "count"]]],
        ["let", "have_prev", 0],
        ["let", "prev", ["bytes.alloc", 0]],
        [
          "for",
          "i",
          0,
          "count",
          [
            "begin",
            ["let", "k_len", ["std.msg.envelope._u32_at_or_neg_v1", "hdr", "pos"]],
            ["if", ["<", "k_len", 0], ["return", ["result_bytes.err", 9509]], 0],
            ["set", "pos", ["+", "pos", 4]],
            ["if", [">=u", ["+", "pos", "k_len"], ["+", "n", 1]], ["return", ["result_bytes.err", 9509]], 0],
            ["let", "k", ["view.slice", "hdr", "pos", "k_len"]],
            ["if", ["=", ["std.msg.envelope._is_ascii_v1", "k"], 0], ["return", ["result_bytes.err", 9504]], 0],
            [
              "if",
              ["=", "have_prev", 1],
              [
                "begin",
                ["let", "cmp", ["bytes.cmp_range", "prev", 0, ["bytes.len", "prev"], ["view.to_bytes", "k"], 0, "k_len"]],
                ["if", [">=", "cmp", 0], ["return", ["result_bytes.err", 9504]], 0],
                0
              ],
              0
            ],
            ["set", "prev", ["view.to_bytes", "k"]],
            ["set", "have_prev", 1],
            ["set", "pos", ["+", "pos", "k_len"]],
            ["let", "v_len", ["std.msg.envelope._u32_at_or_neg_v1", "hdr", "pos"]],
            ["if", ["<", "v_len", 0], ["return", ["result_bytes.err", 9509]], 0],
            ["set", "pos", ["+", "pos", 4]],
            ["if", [">=u", ["+", "pos", "v_len"], ["+", "n", 1]], ["return", ["result_bytes.err", 9509]], 0],
            ["let", "v", ["view.slice", "hdr", "pos", "v_len"]],
            ["if", ["=", ["ext.unicode.unicode_utf8_is_valid", "v"], 0], ["return", ["result_bytes.err", 9505]], 0],
            ["set", "pos", ["+", "pos", "v_len"]],
            ["let", "k_b", ["view.to_bytes", "k"]],
            ["let", "v_val", ["ext.data_model.value_string", "v"]],
            ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "k_b"]]]],
            ["set", "entries", ["vec_u8.extend_bytes", "entries", ["bytes.view", "k_b"]]],
            ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "v_val"]]]],
            ["set", "entries", ["vec_u8.extend_bytes", "entries", ["bytes.view", "v_val"]]],
            0
          ]
        ],
        ["if", ["!=", "pos", "n"], ["return", ["result_bytes.err", 9509]], 0],
        ["let", "entries_b", ["vec_u8.into_bytes", "entries"]],
        ["let", "map_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "entries_b"]]],
        ["if", ["=", ["bytes.len", "map_val"], 0], ["return", ["result_bytes.err", 9509]], 0],
        ["result_bytes.ok", "map_val"]
      ]
    },
    {
      "kind": "defn",
      "name": "std.msg.envelope.decode_v1",
      "params": [
        { "name": "env", "ty": "bytes_view" }
      ],
      "result": "result_bytes",
      "body": [
        "budget.scope_from_arch_v1",
        ["bytes.lit", "msg_core_v1"],
        [
          "begin",
          ["let", "n", ["view.len", "env"]],
          ["if", ["<", "n", 4], ["return", ["result_bytes.err", 9507]], 0],
          ["let", "payload_len", ["std.msg.envelope._u32_at_or_neg_v1", "env", 0]],
          ["if", ["<", "payload_len", 0], ["return", ["result_bytes.err", 9507]], 0],
          ["if", ["!=", ["+", "payload_len", 4], "n"], ["return", ["result_bytes.err", 9507]], 0],
          ["let", "p", 4],
          ["if", ["<", "payload_len", 8], ["return", ["result_bytes.err", 9507]], 0],
          ["let", "magic", ["bytes.lit", "X7ME"]],
          ["if", ["=", ["std.bytes.eq", ["view.slice", "env", "p", 4], ["bytes.view", "magic"]], 0], ["return", ["result_bytes.err", 9508]], 0],
          ["set", "p", ["+", "p", 4]],
          ["let", "ver", ["std.msg.envelope._u32_at_or_neg_v1", "env", "p"]],
          ["if", ["!=", "ver", 1], ["return", ["result_bytes.err", 9508]], 0],
          ["set", "p", ["+", "p", 4]],
          ["let", "topic_len", ["std.msg.envelope._u32_at_or_neg_v1", "env", "p"]],
          ["if", ["<", "topic_len", 0], ["return", ["result_bytes.err", 9507]], 0],
          ["set", "p", ["+", "p", 4]],
          ["if", [">=u", ["+", "p", "topic_len"], ["+", "n", 1]], ["return", ["result_bytes.err", 9507]], 0],
          ["let", "topic", ["view.slice", "env", "p", "topic_len"]],
          ["set", "p", ["+", "p", "topic_len"]],
          ["let", "key_len", ["std.msg.envelope._u32_at_or_neg_v1", "env", "p"]],
          ["if", ["<", "key_len", 0], ["return", ["result_bytes.err", 9507]], 0],
          ["set", "p", ["+", "p", 4]],
          ["if", [">=u", ["+", "p", "key_len"], ["+", "n", 1]], ["return", ["result_bytes.err", 9507]], 0],
          ["let", "key", ["view.slice", "env", "p", "key_len"]],
          ["set", "p", ["+", "p", "key_len"]],
          ["let", "value_len", ["std.msg.envelope._u32_at_or_neg_v1", "env", "p"]],
          ["if", ["<", "value_len", 0], ["return", ["result_bytes.err", 9507]], 0],
          ["set", "p", ["+", "p", 4]],
          ["if", [">=u", ["+", "p", "value_len"], ["+", "n", 1]], ["return", ["result_bytes.err", 9507]], 0],
          ["let", "value", ["view.slice", "env", "p", "value_len"]],
          ["set", "p", ["+", "p", "value_len"]],
          ["let", "hdr_len", ["std.msg.envelope._u32_at_or_neg_v1", "env", "p"]],
          ["if", ["<", "hdr_len", 0], ["return", ["result_bytes.err", 9507]], 0],
          ["set", "p", ["+", "p", 4]],
          ["if", [">=u", ["+", "p", "hdr_len"], ["+", "n", 1]], ["return", ["result_bytes.err", 9507]], 0],
          ["let", "hdr", ["view.slice", "env", "p", "hdr_len"]],
          ["set", "p", ["+", "p", "hdr_len"]],
          ["if", ["!=", "p", "n"], ["return", ["result_bytes.err", 9507]], 0],
          ["let", "hdr_res", ["std.msg.envelope._headers_decode_v1", "hdr"]],
          ["if", ["!=", ["result_bytes.err_code", "hdr_res"], 0], ["return", "hdr_res"], 0],
          ["let", "hdr_map", ["result_bytes.unwrap_or", "hdr_res", ["bytes.alloc", 0]]],
          ["let", "k_topic", ["bytes.lit", "topic"]],
          ["let", "k_key", ["bytes.lit", "key"]],
          ["let", "k_value", ["bytes.lit", "value"]],
          ["let", "k_headers", ["bytes.lit", "headers"]],
          ["let", "v_topic", ["ext.data_model.value_string", "topic"]],
          ["let", "v_key", ["ext.data_model.value_string", "key"]],
          ["let", "v_value", ["ext.data_model.value_string", "value"]],
          ["let", "entries", ["vec_u8.with_capacity", 256]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", 4]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "k_headers"]]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["bytes.view", "k_headers"]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "hdr_map"]]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["bytes.view", "hdr_map"]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "k_key"]]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["bytes.view", "k_key"]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "v_key"]]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["bytes.view", "v_key"]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "k_topic"]]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["bytes.view", "k_topic"]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "v_topic"]]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["bytes.view", "v_topic"]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "k_value"]]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["bytes.view", "k_value"]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["codec.write_u32_le", ["bytes.len", "v_value"]]]],
          ["set", "entries", ["vec_u8.extend_bytes", "entries", ["bytes.view", "v_value"]]],
          ["let", "entries_b", ["vec_u8.into_bytes", "entries"]],
          ["let", "map_val", ["ext.data_model.value_map_from_entries", ["bytes.view", "entries_b"]]],
          ["if", ["=", ["bytes.len", "map_val"], 0], ["return", ["result_bytes.err", 9507]], 0],
          ["result_bytes.ok", ["ext.data_model.doc_ok", ["bytes.view", "map_val"]]]
        ]
      ]
    }
  ]
}
