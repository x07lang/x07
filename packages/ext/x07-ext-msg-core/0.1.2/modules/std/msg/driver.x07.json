{"decls":[{"kind":"export","names":["std.msg.driver.poll_v1","std.msg.driver.publish_v1","std.msg.driver.replay_handle_v1"]},{"body":["begin",["let","off",["ext.data_model.map_find","doc","root","k"]],["if",["<","off",0],["return",-1],0],["let","n_b",["ext.data_model.number_get","doc","off"]],["std.parse.u32_dec",["bytes.view","n_b"]]],"kind":"defn","name":"std.msg.driver._get_num_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"root","ty":"i32"},{"name":"k","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","off",["ext.data_model.map_find","doc","root","k"]],["if",["<","off",0],["return",["bytes.alloc",0]],0],["ext.data_model.string_get","doc","off"]],"kind":"defn","name":"std.msg.driver._get_str_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"root","ty":"i32"},{"name":"k","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","h",["std.rr.current_v1"]],["if",["<=","h",0],["return",["result_bytes.err",9610]],0],["if",["=",["ext.data_model.doc_is_err","handle_doc"],1],["return",["result_bytes.err",9611]],0],["if",["!=",["ext.data_model.root_kind","handle_doc"],5],["return",["result_bytes.err",9611]],0],["let","root",["ext.data_model.root_offset","handle_doc"]],["let","k_driver_kind",["bytes.lit","driver_kind"]],["let","k_endpoint_hash",["bytes.lit","endpoint_hash"]],["let","k_poll_op",["bytes.lit","poll_op"]],["let","driver_kind",["std.msg.driver._get_num_v1","handle_doc","root",["bytes.view","k_driver_kind"]]],["if",["<","driver_kind",0],["return",["result_bytes.err",9611]],0],["let","endpoint_hash_b",["std.msg.driver._get_str_v1","handle_doc","root",["bytes.view","k_endpoint_hash"]]],["if",["=",["bytes.len","endpoint_hash_b"],0],["return",["result_bytes.err",9611]],0],["let","poll_op_b",["std.msg.driver._get_str_v1","handle_doc","root",["bytes.view","k_poll_op"]]],["if",["=",["bytes.len","poll_op_b"],0],["return",["result_bytes.err",9611]],0],["let","count",["if",["<","max_items",0],0,"max_items"]],["let","kind",["bytes.lit","rr"]],["let","elems",["std.vec.with_capacity",256]],["set","elems",["std.u32.push_le","elems",0]],["let","out_count",0],["let","stop",0],["for","i",0,"count",["begin",["if",["=","stop",1],0,["begin",["let","next",["std.rr.next_v1","h",["bytes.view","kind"],["bytes.view","poll_op_b"],["bytes.view","endpoint_hash_b"]]],["let","err_code",["result_bytes.err_code","next"]],["if",["=","err_code",0],["begin",["let","entry",["result_bytes.unwrap_or","next",["bytes.alloc",0]]],["let","entry_err",["std.rr.entry_err_v1",["bytes.view","entry"]]],["if",["!=","entry_err",0],["return",["result_bytes.err","entry_err"]],0],["let","resp",["std.rr.entry_resp_v1",["bytes.view","entry"]]],["let","parsed",["std.msg.rr.parse_v1",["bytes.view","resp"]]],["if",["!=",["result_bytes.err_code","parsed"],0],["return","parsed"],0],["let","doc",["result_bytes.unwrap_or","parsed",["bytes.alloc",0]]],["let","dv",["bytes.view","doc"]],["let","pr",["ext.data_model.root_offset","dv"]],["let","k_op_tag",["bytes.lit","op_tag"]],["let","op_tag",["std.msg.driver._get_num_v1","dv","pr",["bytes.view","k_op_tag"]]],["if",["!=","op_tag",2],["return",["result_bytes.err",9612]],0],["let","k_dk",["bytes.lit","driver_kind"]],["let","dk2",["std.msg.driver._get_num_v1","dv","pr",["bytes.view","k_dk"]]],["if",["!=","dk2","driver_kind"],["return",["result_bytes.err",9612]],0],["let","k_eh",["bytes.lit","endpoint_hash"]],["let","eh2",["std.msg.driver._get_str_v1","dv","pr",["bytes.view","k_eh"]]],["if",["=",["std.bytes.eq",["bytes.view","eh2"],["bytes.view","endpoint_hash_b"]],0],["return",["result_bytes.err",9612]],0],["let","k_env",["bytes.lit","env"]],["let","env_b",["std.msg.driver._get_str_v1","dv","pr",["bytes.view","k_env"]]],["let","v",["ext.data_model.value_string",["bytes.view","env_b"]]],["set","elems",["std.u32.push_le","elems",["bytes.len","v"]]],["set","elems",["std.vec.extend_bytes","elems",["bytes.view","v"]]],["set","out_count",["+","out_count",1]],0],["if",["=","err_code",2009],["set","stop",1],["return",["result_bytes.err","err_code"]]]],0]],0]],["set","elems",["std.u32.write_le_at_vec_u8","elems",0,"out_count"]],["let","elems_b",["std.vec.as_bytes","elems"]],["let","seq_val",["ext.data_model.value_seq_from_elems",["bytes.view","elems_b"]]],["if",["=",["bytes.len","seq_val"],0],["return",["result_bytes.err",9613]],0],["result_bytes.ok",["ext.data_model.doc_ok",["bytes.view","seq_val"]]]],"kind":"defn","name":"std.msg.driver.poll_v1","params":[{"name":"handle_doc","ty":"bytes_view"},{"name":"max_items","ty":"i32"}],"result":"result_bytes"},{"body":["begin",["let","h",["std.rr.current_v1"]],["if",["<=","h",0],["return",["result_bytes.err",9610]],0],["if",["=",["ext.data_model.doc_is_err","handle_doc"],1],["return",["result_bytes.err",9611]],0],["if",["!=",["ext.data_model.root_kind","handle_doc"],5],["return",["result_bytes.err",9611]],0],["let","root",["ext.data_model.root_offset","handle_doc"]],["let","k_driver_kind",["bytes.lit","driver_kind"]],["let","k_endpoint_hash",["bytes.lit","endpoint_hash"]],["let","k_publish_op",["bytes.lit","publish_op"]],["let","driver_kind",["std.msg.driver._get_num_v1","handle_doc","root",["bytes.view","k_driver_kind"]]],["if",["<","driver_kind",0],["return",["result_bytes.err",9611]],0],["let","endpoint_hash_b",["std.msg.driver._get_str_v1","handle_doc","root",["bytes.view","k_endpoint_hash"]]],["if",["=",["bytes.len","endpoint_hash_b"],0],["return",["result_bytes.err",9611]],0],["let","publish_op_b",["std.msg.driver._get_str_v1","handle_doc","root",["bytes.view","k_publish_op"]]],["if",["=",["bytes.len","publish_op_b"],0],["return",["result_bytes.err",9611]],0],["let","kind",["bytes.lit","rr"]],["let","next",["std.rr.next_v1","h",["bytes.view","kind"],["bytes.view","publish_op_b"],["bytes.view","endpoint_hash_b"]]],["let","next_err",["result_bytes.err_code","next"]],["if",["!=","next_err",0],["return",["result_bytes.err","next_err"]],0],["let","entry",["result_bytes.unwrap_or","next",["bytes.alloc",0]]],["let","entry_err",["std.rr.entry_err_v1",["bytes.view","entry"]]],["if",["!=","entry_err",0],["return",["result_bytes.err","entry_err"]],0],["let","resp",["std.rr.entry_resp_v1",["bytes.view","entry"]]],["let","parsed",["std.msg.rr.parse_v1",["bytes.view","resp"]]],["if",["!=",["result_bytes.err_code","parsed"],0],["return","parsed"],0],["let","doc",["result_bytes.unwrap_or","parsed",["bytes.alloc",0]]],["let","dv",["bytes.view","doc"]],["let","pr",["ext.data_model.root_offset","dv"]],["let","k_op_tag",["bytes.lit","op_tag"]],["let","op_tag",["std.msg.driver._get_num_v1","dv","pr",["bytes.view","k_op_tag"]]],["if",["!=","op_tag",1],["return",["result_bytes.err",9612]],0],["let","k_dk",["bytes.lit","driver_kind"]],["let","dk2",["std.msg.driver._get_num_v1","dv","pr",["bytes.view","k_dk"]]],["if",["!=","dk2","driver_kind"],["return",["result_bytes.err",9612]],0],["let","k_eh",["bytes.lit","endpoint_hash"]],["let","eh2",["std.msg.driver._get_str_v1","dv","pr",["bytes.view","k_eh"]]],["if",["=",["std.bytes.eq",["bytes.view","eh2"],["bytes.view","endpoint_hash_b"]],0],["return",["result_bytes.err",9612]],0],["let","k_ack",["bytes.lit","ack"]],["let","ack_b",["std.msg.driver._get_str_v1","dv","pr",["bytes.view","k_ack"]]],["result_bytes.ok","ack_b"]],"kind":"defn","name":"std.msg.driver.publish_v1","params":[{"name":"handle_doc","ty":"bytes_view"},{"name":"env","ty":"bytes_view"}],"result":"result_bytes"},{"body":["begin",["let","k_driver_kind",["bytes.lit","driver_kind"]],["let","k_endpoint_hash",["bytes.lit","endpoint_hash"]],["let","k_poll_op",["bytes.lit","poll_op"]],["let","k_publish_op",["bytes.lit","publish_op"]],["let","driver_s",["std.fmt.s32_to_dec","driver_kind"]],["let","v_driver_kind",["ext.data_model.value_number",["bytes.view","driver_s"]]],["let","v_endpoint_hash",["ext.data_model.value_string","endpoint_hash"]],["let","v_poll_op",["ext.data_model.value_string","poll_op"]],["let","v_publish_op",["ext.data_model.value_string","publish_op"]],["let","entries",["std.vec.with_capacity",256]],["set","entries",["std.u32.push_le","entries",4]],["set","entries",["std.u32.push_le","entries",["bytes.len","k_driver_kind"]]],["set","entries",["std.vec.extend_bytes","entries",["bytes.view","k_driver_kind"]]],["set","entries",["std.u32.push_le","entries",["bytes.len","v_driver_kind"]]],["set","entries",["std.vec.extend_bytes","entries",["bytes.view","v_driver_kind"]]],["set","entries",["std.u32.push_le","entries",["bytes.len","k_endpoint_hash"]]],["set","entries",["std.vec.extend_bytes","entries",["bytes.view","k_endpoint_hash"]]],["set","entries",["std.u32.push_le","entries",["bytes.len","v_endpoint_hash"]]],["set","entries",["std.vec.extend_bytes","entries",["bytes.view","v_endpoint_hash"]]],["set","entries",["std.u32.push_le","entries",["bytes.len","k_poll_op"]]],["set","entries",["std.vec.extend_bytes","entries",["bytes.view","k_poll_op"]]],["set","entries",["std.u32.push_le","entries",["bytes.len","v_poll_op"]]],["set","entries",["std.vec.extend_bytes","entries",["bytes.view","v_poll_op"]]],["set","entries",["std.u32.push_le","entries",["bytes.len","k_publish_op"]]],["set","entries",["std.vec.extend_bytes","entries",["bytes.view","k_publish_op"]]],["set","entries",["std.u32.push_le","entries",["bytes.len","v_publish_op"]]],["set","entries",["std.vec.extend_bytes","entries",["bytes.view","v_publish_op"]]],["let","entries_b",["std.vec.as_bytes","entries"]],["let","map_val",["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],["if",["=",["bytes.len","map_val"],0],["return",["bytes.alloc",0]],0],["ext.data_model.doc_ok",["bytes.view","map_val"]]],"kind":"defn","name":"std.msg.driver.replay_handle_v1","params":[{"name":"driver_kind","ty":"i32"},{"name":"endpoint_hash","ty":"bytes_view"},{"name":"publish_op","ty":"bytes_view"},{"name":"poll_op","ty":"bytes_view"}],"result":"bytes"}],"imports":["ext.data_model","std.bytes","std.fmt","std.msg.rr","std.parse","std.rr","std.u32","std.vec"],"kind":"module","module_id":"std.msg.driver","schema_version":"x07.x07ast@0.3.0"}
