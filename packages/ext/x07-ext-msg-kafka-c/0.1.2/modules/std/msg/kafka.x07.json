{"decls":[{"kind":"export","names":["std.msg.kafka.connect_from_arch_v1","std.msg.kafka.poll_env_v1","std.msg.kafka.publish_env_v1"]},{"body":["begin",["let","root",["ext.data_model.root_offset","index_doc"]],["let","k_profiles",["bytes.lit","profiles"]],["let","profiles_off",["ext.data_model.map_find","index_doc","root",["bytes.view","k_profiles"]]],["if",["<","profiles_off",0],["return",["bytes.alloc",0]],0],["let","count",["ext.data_model.seq_len","index_doc","profiles_off"]],["if",["<","count",0],["return",["bytes.alloc",0]],0],["let","k_id",["bytes.lit","id"]],["for","i",0,"count",["begin",["let","ref_off",["ext.data_model.seq_get","index_doc","profiles_off","i"]],["if",["<","ref_off",0],0,["begin",["let","id_off",["ext.data_model.map_find","index_doc","ref_off",["bytes.view","k_id"]]],["if",["<","id_off",0],0,["begin",["let","id_b",["ext.data_model.string_get","index_doc","id_off"]],["if",["=",["std.bytes.eq",["bytes.view","id_b"],"profile_id"],1],["begin",["let","val_off",["ext.data_model.map_find","index_doc","ref_off","field"]],["if",["<","val_off",0],["return",["bytes.alloc",0]],0],["return",["ext.data_model.string_get","index_doc","val_off"]]],0]]]]],0]],["bytes.alloc",0]],"kind":"defn","name":"std.msg.kafka._find_profile_ref_field_v1","params":[{"name":"index_doc","ty":"bytes_view"},{"name":"profile_id","ty":"bytes_view"},{"name":"field","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","off",["ext.data_model.map_find","doc","root","k"]],["if",["<","off",0],["return",-1],0],["let","num",["ext.data_model.number_get","doc","off"]],["std.parse.u32_dec",["bytes.view","num"]]],"kind":"defn","name":"std.msg.kafka._get_u32_field_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"root","ty":"i32"},{"name":"k","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","path",["bytes.lit","arch/msg/kafka/index.x07kafka.json"]],["let","raw",["std.fs.read",["bytes.view","path"]]],["ext.json.data_model.parse",["bytes.view","raw"]]],"kind":"defn","name":"std.msg.kafka._read_index_doc_v1","params":[],"result":"bytes"},{"body":["budget.scope_from_arch_v1",["bytes.lit","msg_kafka_v1"],["begin",["let","role_producer",["bytes.lit","producer"]],["let","role_consumer",["bytes.lit","consumer"]],["if",["if",["=",["std.bytes.eq","role",["bytes.view","role_producer"]],1],1,["=",["std.bytes.eq","role",["bytes.view","role_consumer"]],1]],0,["return",["result_bytes.err",9700]]],["let","index_doc",["std.msg.kafka._read_index_doc_v1"]],["let","idxv",["bytes.view","index_doc"]],["if",["=",["ext.data_model.doc_is_err","idxv"],1],["return",["result_bytes.err",9701]],0],["let","k_profile_path",["bytes.lit","profile_path"]],["let","profile_path",["std.msg.kafka._find_profile_ref_field_v1","idxv","profile_id",["bytes.view","k_profile_path"]]],["if",["=",["bytes.len","profile_path"],0],["return",["result_bytes.err",9702]],0],["let","raw_profile",["std.fs.read",["bytes.view","profile_path"]]],["let","profile_doc",["ext.json.data_model.parse",["bytes.view","raw_profile"]]],["let","pv",["bytes.view","profile_doc"]],["if",["=",["ext.data_model.doc_is_err","pv"],1],["return",["result_bytes.err",9703]],0],["let","pr",["ext.data_model.root_offset","pv"]],["let","k_limits",["bytes.lit","limits"]],["let","limits_off",["ext.data_model.map_find","pv","pr",["bytes.view","k_limits"]]],["if",["<","limits_off",0],["return",["result_bytes.err",9704]],0],["let","k_max_message_bytes",["bytes.lit","max_message_bytes"]],["let","k_max_poll_items",["bytes.lit","max_poll_items"]],["let","k_max_poll_wait_ms",["bytes.lit","max_poll_wait_ms"]],["let","max_message_bytes",["std.msg.kafka._get_u32_field_v1","pv","limits_off",["bytes.view","k_max_message_bytes"]]],["let","max_poll_items",["std.msg.kafka._get_u32_field_v1","pv","limits_off",["bytes.view","k_max_poll_items"]]],["let","max_poll_wait_ms",["std.msg.kafka._get_u32_field_v1","pv","limits_off",["bytes.view","k_max_poll_wait_ms"]]],["if",["if",["<","max_message_bytes",0],1,["if",["<","max_poll_items",0],1,["<","max_poll_wait_ms",0]]],["return",["result_bytes.err",9705]],0],["let","handle",["std.msg.kafka.rr.handle_doc_v1","profile_id","max_message_bytes","max_poll_items","max_poll_wait_ms"]],["if",["=",["bytes.len","handle"],0],["return",["result_bytes.err",9706]],0],["result_bytes.ok","handle"]]],"kind":"defn","name":"std.msg.kafka.connect_from_arch_v1","params":[{"name":"profile_id","ty":"bytes_view"},{"name":"role","ty":"bytes_view"}],"result":"result_bytes"},{"body":["budget.scope_from_arch_v1",["bytes.lit","msg_kafka_v1"],["begin",["let","cap",["std.msg.kafka.rr.max_poll_items_v1","handle_doc"]],["if",["<","cap",0],["return",["result_bytes.err",9720]],0],["let","n",["if",["<","max_items",0],0,"max_items"]],["let","n2",["if",[">","n","cap"],"cap","n"]],["std.msg.driver.poll_v1","handle_doc","n2"]]],"kind":"defn","name":"std.msg.kafka.poll_env_v1","params":[{"name":"handle_doc","ty":"bytes_view"},{"name":"max_items","ty":"i32"}],"result":"result_bytes"},{"body":["budget.scope_from_arch_v1",["bytes.lit","msg_kafka_v1"],["begin",["let","max_message_bytes",["std.msg.kafka.rr.max_message_bytes_v1","handle_doc"]],["if",["<","max_message_bytes",0],["return",["result_bytes.err",9710]],0],["if",[">",["view.len","env"],"max_message_bytes"],["return",["result_bytes.err",9711]],0],["std.msg.driver.publish_v1","handle_doc","env"]]],"kind":"defn","name":"std.msg.kafka.publish_env_v1","params":[{"name":"handle_doc","ty":"bytes_view"},{"name":"env","ty":"bytes_view"}],"result":"result_bytes"}],"imports":["ext.data_model","ext.json.data_model","std.bytes","std.fs","std.msg.driver","std.msg.kafka.rr","std.parse"],"kind":"module","module_id":"std.msg.kafka","schema_version":"x07.x07ast@0.3.0"}
