{
  "schema_version": "x07.x07ast@0.3.0",
  "kind": "module",
  "module_id": "std.crawl.fetch",
  "imports": [
    "ext.data_model",
    "std.fmt",
    "std.rr",
    "std.u32",
    "std.vec"
  ],
  "decls": [
    {
      "kind": "export",
      "names": [
        "std.crawl.fetch.replay_rr_v1",
        "std.crawl.fetch.rr_entry_v1"
      ]
    },
    {
      "kind": "defn",
      "name": "std.crawl.fetch.rr_entry_v1",
      "params": [
        { "name": "kind", "ty": "bytes_view" },
        { "name": "op", "ty": "bytes_view" },
        { "name": "key", "ty": "bytes_view" },
        { "name": "req", "ty": "bytes_view" },
        { "name": "resp", "ty": "bytes_view" },
        { "name": "err", "ty": "i32" }
      ],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "k_err", ["bytes.lit", "err"]],
        ["let", "k_key", ["bytes.lit", "key"]],
        ["let", "k_kind", ["bytes.lit", "kind"]],
        ["let", "k_op", ["bytes.lit", "op"]],
        ["let", "k_req", ["bytes.lit", "req"]],
        ["let", "k_resp", ["bytes.lit", "resp"]],
        ["let", "err_s", ["std.fmt.s32_to_dec", "err"]],
        ["let", "v_err", ["ext.data_model.value_number", ["bytes.view", "err_s"]]],
        ["let", "v_key", ["ext.data_model.value_string", "key"]],
        ["let", "v_kind", ["ext.data_model.value_string", "kind"]],
        ["let", "v_op", ["ext.data_model.value_string", "op"]],
        ["let", "v_req", ["ext.data_model.value_string", "req"]],
        ["let", "v_resp", ["ext.data_model.value_string", "resp"]],
        ["let", "entries", ["std.vec.with_capacity", 256]],
        ["set", "entries", ["std.u32.push_le", "entries", 6]],
        ["set", "entries", ["std.u32.push_le", "entries", ["bytes.len", "k_err"]]],
        ["set", "entries", ["std.vec.extend_bytes", "entries", ["bytes.view", "k_err"]]],
        ["set", "entries", ["std.u32.push_le", "entries", ["bytes.len", "v_err"]]],
        ["set", "entries", ["std.vec.extend_bytes", "entries", ["bytes.view", "v_err"]]],
        ["set", "entries", ["std.u32.push_le", "entries", ["bytes.len", "k_key"]]],
        ["set", "entries", ["std.vec.extend_bytes", "entries", ["bytes.view", "k_key"]]],
        ["set", "entries", ["std.u32.push_le", "entries", ["bytes.len", "v_key"]]],
        ["set", "entries", ["std.vec.extend_bytes", "entries", ["bytes.view", "v_key"]]],
        ["set", "entries", ["std.u32.push_le", "entries", ["bytes.len", "k_kind"]]],
        ["set", "entries", ["std.vec.extend_bytes", "entries", ["bytes.view", "k_kind"]]],
        ["set", "entries", ["std.u32.push_le", "entries", ["bytes.len", "v_kind"]]],
        ["set", "entries", ["std.vec.extend_bytes", "entries", ["bytes.view", "v_kind"]]],
        ["set", "entries", ["std.u32.push_le", "entries", ["bytes.len", "k_op"]]],
        ["set", "entries", ["std.vec.extend_bytes", "entries", ["bytes.view", "k_op"]]],
        ["set", "entries", ["std.u32.push_le", "entries", ["bytes.len", "v_op"]]],
        ["set", "entries", ["std.vec.extend_bytes", "entries", ["bytes.view", "v_op"]]],
        ["set", "entries", ["std.u32.push_le", "entries", ["bytes.len", "k_req"]]],
        ["set", "entries", ["std.vec.extend_bytes", "entries", ["bytes.view", "k_req"]]],
        ["set", "entries", ["std.u32.push_le", "entries", ["bytes.len", "v_req"]]],
        ["set", "entries", ["std.vec.extend_bytes", "entries", ["bytes.view", "v_req"]]],
        ["set", "entries", ["std.u32.push_le", "entries", ["bytes.len", "k_resp"]]],
        ["set", "entries", ["std.vec.extend_bytes", "entries", ["bytes.view", "k_resp"]]],
        ["set", "entries", ["std.u32.push_le", "entries", ["bytes.len", "v_resp"]]],
        ["set", "entries", ["std.vec.extend_bytes", "entries", ["bytes.view", "v_resp"]]],
        ["let", "entries_b", ["std.vec.as_bytes", "entries"]],
        ["let", "map", ["ext.data_model.value_map_from_entries", ["bytes.view", "entries_b"]]],
        ["if", ["=", ["bytes.len", "map"], 0], ["return", ["bytes.alloc", 0]], 0],
        ["ext.data_model.doc_ok", ["bytes.view", "map"]]
      ]
    },
    {
      "kind": "defn",
      "name": "std.crawl.fetch._process_plan_v1",
      "params": [
        { "name": "plan_doc", "ty": "bytes_view" },
        { "name": "max_body_bytes", "ty": "i32" }
      ],
      "result": "result_bytes",
      "body": [
        "begin",
        ["let", "h", ["std.rr.current_v1"]],
        ["if", ["<=", "h", 0], ["return", ["result_bytes.err", 9301]], 0],
        ["if", ["=", ["ext.data_model.doc_is_err", "plan_doc"], 1], ["return", ["result_bytes.err", 9302]], 0],
        ["let", "root", ["ext.data_model.root_offset", "plan_doc"]],
        ["let", "count", ["ext.data_model.seq_len", "plan_doc", "root"]],
        ["if", ["<", "count", 0], ["return", ["result_bytes.err", 9303]], 0],
        ["let", "kind", ["bytes.lit", "rr"]],
        ["let", "op", ["bytes.lit", "std.crawl.fetch.http_get_v1"]],
        ["let", "out", ["std.vec.with_capacity", 256]],
        [
          "for",
          "i",
          0,
          "count",
          [
            "begin",
            ["let", "off", ["ext.data_model.seq_get", "plan_doc", "root", "i"]],
            ["let", "url", ["ext.data_model.string_get", "plan_doc", "off"]],
            ["let", "urlv", ["bytes.view", "url"]],
            ["let", "next", ["std.rr.next_v1", "h", ["bytes.view", "kind"], ["bytes.view", "op"], "urlv"]],
            ["let", "err_code", ["result_bytes.err_code", "next"]],
            [
              "if",
              ["=", "err_code", 0],
              [
                "begin",
                ["let", "entry", ["result_bytes.unwrap_or", "next", ["bytes.alloc", 0]]],
                ["let", "resp", ["std.rr.entry_resp_v1", ["bytes.view", "entry"]]],
                ["set", "out", ["std.u32.push_le", "out", ["bytes.len", "resp"]]],
                ["set", "out", ["std.vec.extend_bytes", "out", ["bytes.view", "resp"]]],
                0
              ],
              ["return", ["result_bytes.err", "err_code"]]
            ],
            0
          ]
        ],
        ["result_bytes.ok", ["std.vec.as_bytes", "out"]]
      ]
    },
    {
      "kind": "defn",
      "name": "std.crawl.fetch.replay_rr_v1",
      "params": [
        { "name": "plan_doc", "ty": "bytes_view" }
      ],
      "result": "result_bytes",
      "body": [
        "std.rr.with_policy_v1",
        ["bytes.lit", "crawl_rr_v1"],
        ["bytes.lit", "crawl_v1.rrbin"],
        ["i32.lit", 2],
        ["std.crawl.fetch._process_plan_v1", "plan_doc", 0]
      ]
    }
  ]
}
