{"decls":[{"kind":"export","names":["std.crawl.schedule.plan_v1"]},{"body":["begin",["let","root",["ext.data_model.root_offset","index_doc"]],["let","k_policies",["bytes.lit","policies"]],["let","policies_off",["ext.data_model.map_find","index_doc","root",["bytes.view","k_policies"]]],["if",["<","policies_off",0],["return",["bytes.alloc",0]],0],["let","count",["ext.data_model.seq_len","index_doc","policies_off"]],["if",["<","count",0],["return",["bytes.alloc",0]],0],["let","k_id",["bytes.lit","id"]],["let","k_policy_path",["bytes.lit","policy_path"]],["for","i",0,"count",["begin",["let","ref_off",["ext.data_model.seq_get","index_doc","policies_off","i"]],["if",["<","ref_off",0],0,["begin",["let","id_off",["ext.data_model.map_find","index_doc","ref_off",["bytes.view","k_id"]]],["let","path_off",["ext.data_model.map_find","index_doc","ref_off",["bytes.view","k_policy_path"]]],["if",["if",["<","id_off",0],1,["<","path_off",0]],0,["begin",["let","id_b",["ext.data_model.string_get","index_doc","id_off"]],["if",["=",["std.bytes.eq",["bytes.view","id_b"],"policy_id"],1],["return",["ext.data_model.string_get","index_doc","path_off"]],0],0]],0]],0]],["bytes.alloc",0]],"kind":"defn","name":"std.crawl.schedule._find_policy_path_v1","params":[{"name":"index_doc","ty":"bytes_view"},{"name":"policy_id","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","off",["ext.data_model.map_find","doc","limits_off","k"]],["if",["<","off",0],["return",-1],0],["let","n_b",["ext.data_model.number_get","doc","off"]],["std.parse.u32_dec",["bytes.view","n_b"]]],"kind":"defn","name":"std.crawl.schedule._limit_u32_v1","params":[{"name":"doc","ty":"bytes_view"},{"name":"limits_off","ty":"i32"},{"name":"k","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","path",["bytes.lit","arch/crawl/index.x07crawl.json"]],["let","raw",["std.fs.read",["bytes.view","path"]]],["ext.json.data_model.parse",["bytes.view","raw"]]],"kind":"defn","name":"std.crawl.schedule._read_index_doc_v1","params":[],"result":"bytes"},{"body":["budget.scope_from_arch_v1",["bytes.lit","crawl_default_v1"],["begin",["let","idx_b",["std.crawl.schedule._read_index_doc_v1"]],["let","idxv",["bytes.view","idx_b"]],["if",["=",["ext.data_model.doc_is_err","idxv"],1],["return",["result_bytes.err",9401]],0],["let","path",["std.crawl.schedule._find_policy_path_v1","idxv","policy_id"]],["if",["=",["bytes.len","path"],0],["return",["result_bytes.err",9402]],0],["let","raw",["std.fs.read",["bytes.view","path"]]],["let","policy_b",["ext.json.data_model.parse",["bytes.view","raw"]]],["let","policy",["bytes.view","policy_b"]],["if",["=",["ext.data_model.doc_is_err","policy"],1],["return",["result_bytes.err",9403]],0],["let","policy_root",["ext.data_model.root_offset","policy"]],["let","k_limits",["bytes.lit","limits"]],["let","limits_off",["ext.data_model.map_find","policy","policy_root",["bytes.view","k_limits"]]],["if",["<","limits_off",0],["return",["result_bytes.err",9404]],0],["let","k_max_urls_total",["bytes.lit","max_urls_total"]],["let","k_max_url_bytes",["bytes.lit","max_url_bytes"]],["let","max_urls_total",["std.crawl.schedule._limit_u32_v1","policy","limits_off",["bytes.view","k_max_urls_total"]]],["let","max_url_bytes",["std.crawl.schedule._limit_u32_v1","policy","limits_off",["bytes.view","k_max_url_bytes"]]],["if",["if",["<","max_urls_total",0],1,["<","max_url_bytes",0]],["return",["result_bytes.err",9405]],0],["if",["=",["ext.data_model.doc_is_err","seeds_doc"],1],["return",["result_bytes.err",9406]],0],["let","sr",["ext.data_model.root_offset","seeds_doc"]],["let","seeds_count",["ext.data_model.seq_len","seeds_doc","sr"]],["if",["<","seeds_count",0],["return",["result_bytes.err",9407]],0],["let","entries",["std.vec.with_capacity",256]],["set","entries",["std.u32.push_le","entries",0]],["let","out_count",0],["for","i",0,"seeds_count",["begin",["if",["if",[">=","max_urls_total",1],["<u","out_count","max_urls_total"],1],["begin",["let","seed_off",["ext.data_model.seq_get","seeds_doc","sr","i"]],["let","seed_b",["ext.data_model.string_get","seeds_doc","seed_off"]],["let","norm",["std.crawl.urlnorm.canon_v1",["bytes.view","seed_b"]]],["if",["=",["bytes.len","norm"],0],0,["if",["if",[">=","max_url_bytes",1],["<u",["bytes.len","norm"],["+","max_url_bytes",1]],1],["begin",["let","v",["ext.data_model.value_string",["bytes.view","norm"]]],["set","entries",["std.u32.push_le","entries",["bytes.len","v"]]],["set","entries",["std.vec.extend_bytes","entries",["bytes.view","v"]]],["set","out_count",["+","out_count",1]],0],0]],0],0],0]],["set","entries",["std.u32.write_le_at_vec_u8","entries",0,"out_count"]],["let","entries_b",["std.vec.as_bytes","entries"]],["let","seq",["ext.data_model.value_seq_from_elems",["bytes.view","entries_b"]]],["if",["=",["bytes.len","seq"],0],["return",["result_bytes.err",9408]],0],["result_bytes.ok",["ext.data_model.doc_ok",["bytes.view","seq"]]]]],"kind":"defn","name":"std.crawl.schedule.plan_v1","params":[{"name":"policy_id","ty":"bytes_view"},{"name":"seeds_doc","ty":"bytes_view"}],"result":"result_bytes"}],"imports":["ext.data_model","ext.json.data_model","std.bytes","std.crawl.urlnorm","std.fs","std.parse","std.u32","std.vec"],"kind":"module","module_id":"std.crawl.schedule","schema_version":"x07.x07ast@0.3.0"}
