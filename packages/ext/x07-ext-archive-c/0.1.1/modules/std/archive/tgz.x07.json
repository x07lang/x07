{
  "schema_version": "x07.x07ast@0.3.0",
  "kind": "module",
  "module_id": "std.archive.tgz",
  "imports": ["ext.compress", "std.archive.tar", "std.bytes", "std.codec"],
  "decls": [
    {
      "kind": "export",
      "names": [
        "std.archive.tgz.err_code",
        "std.archive.tgz.extract_tree_from_arch_v1",
        "std.archive.tgz.extract_tree_v1",
        "std.archive.tgz.get_bytes",
        "std.archive.tgz.is_err",
        "std.archive.tgz.list_v1"
      ]
    },
    {
      "kind": "defn",
      "name": "std.archive.tgz._make_err",
      "params": [{ "name": "code", "ty": "i32" }],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "out", ["vec_u8.with_capacity", 9]],
        ["set", "out", ["vec_u8.push", "out", 0]],
        ["set", "out", ["vec_u8.extend_bytes", "out", ["std.codec.write_u32_le", "code"]]],
        ["set", "out", ["vec_u8.extend_bytes", "out", ["std.codec.write_u32_le", 0]]],
        ["vec_u8.into_bytes", "out"]
      ]
    },
    {
      "kind": "defn",
      "name": "std.archive.tgz.err_code",
      "params": [{ "name": "doc", "ty": "bytes_view" }],
      "result": "i32",
      "body": ["std.archive.tar.err_code", "doc"]
    },
    {
      "kind": "defn",
      "name": "std.archive.tgz.is_err",
      "params": [{ "name": "doc", "ty": "bytes_view" }],
      "result": "i32",
      "body": ["std.archive.tar.is_err", "doc"]
    },
    {
      "kind": "defn",
      "name": "std.archive.tgz.get_bytes",
      "params": [{ "name": "doc", "ty": "bytes_view" }],
      "result": "bytes",
      "body": ["std.archive.tar.get_bytes", "doc"]
    },
    {
      "kind": "defn",
      "name": "std.archive.tgz._inflate_v1",
      "params": [{ "name": "tgz", "ty": "bytes_view" }],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "doc", ["ext.compress.gzip_decompress", "tgz", 1073741824]],
        ["let", "dv", ["bytes.view", "doc"]],
        [
          "if",
          ["ext.compress.is_err", "dv"],
          ["return", ["std.archive.tgz._make_err", ["+", 20, ["ext.compress.err_code", "dv"]]]],
          0
        ],
        ["let", "tar", ["ext.compress.get_bytes", "dv"]],
        ["let", "in_len", ["view.len", "tgz"]],
        ["let", "out_len", ["bytes.len", "tar"]],
        [
          "if",
          [
            "if",
            [">", "in_len", 0],
            [">", ["*", "out_len", 100], ["*", "in_len", 20000]],
            0
          ],
          ["return", ["std.archive.tgz._make_err", 21]],
          0
        ],
        [
          "if",
          [">", "out_len", 1073741824],
          ["return", ["std.archive.tgz._make_err", 21]],
          0
        ],
        ["begin", ["let", "out", ["vec_u8.with_capacity", ["+", 1, "out_len"]]], ["set", "out", ["vec_u8.push", "out", 1]], ["set", "out", ["vec_u8.extend_bytes", "out", "tar"]], ["vec_u8.into_bytes", "out"]]
      ]
    },
    {
      "kind": "defn",
      "name": "std.archive.tgz.list_v1",
      "params": [{ "name": "tgz", "ty": "bytes_view" }],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "tar_doc", ["std.archive.tgz._inflate_v1", "tgz"]],
        ["let", "tv", ["bytes.view", "tar_doc"]],
        [
          "if",
          ["std.archive.tgz.is_err", "tv"],
          ["return", "tar_doc"],
          0
        ],
        ["let", "tar", ["std.archive.tgz.get_bytes", "tv"]],
        ["std.archive.tar.list_v1", ["bytes.view", "tar"]]
      ]
    },
    {
      "kind": "defn",
      "name": "std.archive.tgz.extract_tree_v1",
      "params": [{ "name": "tgz", "ty": "bytes_view" }],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "tar_doc", ["std.archive.tgz._inflate_v1", "tgz"]],
        ["let", "tv", ["bytes.view", "tar_doc"]],
        [
          "if",
          ["std.archive.tgz.is_err", "tv"],
          ["return", "tar_doc"],
          0
        ],
        ["let", "tar", ["std.archive.tgz.get_bytes", "tv"]],
        ["std.archive.tar.extract_tree_v1", ["bytes.view", "tar"]]
      ]
    },
    {
      "kind": "defn",
      "name": "std.archive.tgz.extract_tree_from_arch_v1",
      "params": [
        { "name": "profile_id", "ty": "bytes_view" },
        { "name": "tgz", "ty": "bytes_view" }
      ],
      "result": "result_bytes",
      "body": [
        "budget.scope_from_arch_v1",
        ["bytes.lit", "archive_extract_safe_v1"],
        [
          "begin",
          ["let", "k", ["bytes.lit", "tgz_extract_safe_v1"]],
          [
            "if",
            ["view.eq", "profile_id", ["bytes.view", "k"]],
            [
              "begin",
              ["let", "doc", ["std.archive.tgz.extract_tree_v1", "tgz"]],
              ["let", "dv", ["bytes.view", "doc"]],
              [
                "if",
                ["std.archive.tgz.is_err", "dv"],
                ["return", ["result_bytes.err", ["std.archive.tgz.err_code", "dv"]]],
                0
              ],
              ["result_bytes.ok", ["std.archive.tgz.get_bytes", "dv"]]
            ],
            ["result_bytes.err", 10]
          ]
        ]
      ]
    }
  ]
}
