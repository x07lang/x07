{
  "schema_version": "x07.x07ast@0.3.0",
  "kind": "module",
  "module_id": "std.archive.tests",
  "imports": ["ext.json.canon", "std.archive", "std.archive.tar", "std.bytes", "std.test"],
  "decls": [
    {
      "kind": "export",
      "names": [
        "std.archive.tests.test_path_policy_posix_strict_v1",
        "std.archive.tests.test_tar_list_hello_v1"
      ]
    },
    {
      "kind": "defn",
      "name": "std.archive.tests._bytes_set_range_v1",
      "params": [
        { "name": "b", "ty": "bytes" },
        { "name": "off", "ty": "i32" },
        { "name": "src", "ty": "bytes_view" }
      ],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "n", ["view.len", "src"]],
        ["let", "out", "b"],
        [
          "for",
          "i",
          0,
          "n",
          [
            "set",
            "out",
            [
              "bytes.set_u8",
              "out",
              ["+", "off", "i"],
              ["view.get_u8", "src", "i"]
            ]
          ]
        ],
        "out"
      ]
    },
    {
      "kind": "defn",
      "name": "std.archive.tests._tar_make_hello_v1",
      "params": [],
      "result": "bytes",
      "body": [
        "begin",
        ["let", "hdr", ["bytes.alloc", 512]],
        ["set", "hdr", ["std.archive.tests._bytes_set_range_v1", "hdr", 0, ["bytes.lit", "hello.txt"]]],
        ["set", "hdr", ["std.archive.tests._bytes_set_range_v1", "hdr", 100, ["bytes.lit", "0000644"]]],
        ["set", "hdr", ["std.archive.tests._bytes_set_range_v1", "hdr", 124, ["bytes.lit", "00000000005"]]],
        ["set", "hdr", ["bytes.set_u8", "hdr", 156, 48]],
        ["let", "data", ["bytes.lit", "hello"]],
        ["let", "pad", ["bytes.alloc", 507]],
        ["let", "block", ["std.bytes.concat", ["bytes.view", "data"], ["bytes.view", "pad"]]],
        ["let", "z", ["bytes.alloc", 512]],
        [
          "let",
          "v",
          ["vec_u8.with_capacity", 2048]
        ],
        ["set", "v", ["vec_u8.extend_bytes", "v", "hdr"]],
        ["set", "v", ["vec_u8.extend_bytes", "v", "block"]],
        ["set", "v", ["vec_u8.extend_bytes", "v", "z"]],
        ["set", "v", ["vec_u8.extend_bytes", "v", "z"]],
        ["vec_u8.into_bytes", "v"]
      ]
    },
    {
      "kind": "defn",
      "name": "std.archive.tests.test_path_policy_posix_strict_v1",
      "params": [],
      "result": "result_i32",
      "body": [
        "begin",
        ["let", "ok_path", ["bytes.lit", "a/b/c.txt"]],
        ["let", "bad_parent", ["bytes.lit", "a/../c.txt"]],
        ["let", "bad_abs", ["bytes.lit", "/etc/passwd"]],
        [
          "try",
          [
            "std.test.assert_i32_eq",
            [
              "std.archive.path_policy_posix_strict_check_v1",
              ["bytes.view", "ok_path"],
              1,
              1,
              1,
              1,
              4096,
              255
            ],
            0,
            ["std.test.code_assert_i32_eq"]
          ]
        ],
        [
          "try",
          [
            "std.test.assert_true",
            [
              "!=",
              [
                "std.archive.path_policy_posix_strict_check_v1",
                ["bytes.view", "bad_parent"],
                1,
                1,
                1,
                1,
                4096,
                255
              ],
              0
            ],
            ["std.test.code_assert_true"]
          ]
        ],
        [
          "try",
          [
            "std.test.assert_true",
            [
              "!=",
              [
                "std.archive.path_policy_posix_strict_check_v1",
                ["bytes.view", "bad_abs"],
                1,
                1,
                1,
                1,
                4096,
                255
              ],
              0
            ],
            ["std.test.code_assert_true"]
          ]
        ],
        ["std.test.pass"]
      ]
    },
    {
      "kind": "defn",
      "name": "std.archive.tests.test_tar_list_hello_v1",
      "params": [],
      "result": "result_i32",
      "body": [
        "begin",
        ["let", "tar", ["std.archive.tests._tar_make_hello_v1"]],
        ["let", "doc", ["std.archive.tar.list_v1", ["bytes.view", "tar"]]],
        ["let", "dv", ["bytes.view", "doc"]],
        [
          "try",
          [
            "std.test.assert_true",
            ["=", ["std.archive.tar.is_err", "dv"], 0],
            ["std.test.code_assert_true"]
          ]
        ],
        ["let", "out_json", ["std.archive.tar.get_bytes", "dv"]],
        [
          "let",
          "expected_raw",
          [
            "bytes.lit",
            "{\"entries\":[{\"mode\":420,\"path\":\"hello.txt\",\"size\":5}]}"
          ]
        ],
        ["let", "expected", ["ext.json.canon.canonicalize", ["bytes.view", "expected_raw"]]],
        [
          "try",
          [
            "std.test.assert_bytes_eq",
            "out_json",
            "expected",
            ["std.test.code_assert_bytes_eq"]
          ]
        ],
        ["std.test.pass"]
      ]
    }
  ]
}
