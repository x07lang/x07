{
  "schema_version": "x07.x07ast@0.3.0",
  "kind": "module",
  "module_id": "std.archive",
  "imports": ["std.bytes", "std.text.utf8"],
  "decls": [
    {
      "kind": "export",
      "names": ["std.archive.path_policy_posix_strict_check_v1"]
    },
    {
      "kind": "defn",
      "name": "std.archive._is_parent_segment_v1",
      "params": [
        { "name": "path", "ty": "bytes_view" },
        { "name": "seg_start", "ty": "i32" },
        { "name": "seg_len", "ty": "i32" }
      ],
      "result": "i32",
      "body": [
        "begin",
        ["if", ["!=", "seg_len", 2], ["return", 0], 0],
        ["if", ["!=", ["view.get_u8", "path", "seg_start"], 46], ["return", 0], 0],
        ["if", ["!=", ["view.get_u8", "path", ["+", "seg_start", 1]], 46], ["return", 0], 0],
        1
      ]
    },
    {
      "kind": "defn",
      "name": "std.archive._check_segment_v1",
      "params": [
        { "name": "path", "ty": "bytes_view" },
        { "name": "seg_start", "ty": "i32" },
        { "name": "seg_len", "ty": "i32" },
        { "name": "reject_parent", "ty": "i32" },
        { "name": "max_segment_bytes", "ty": "i32" }
      ],
      "result": "i32",
      "body": [
        "begin",
        [
          "let",
          "max_seg",
	        [
	          "if",
            [
              "<",
              "max_segment_bytes",
              0
            ],
            0,
            "max_segment_bytes"
          ]
        ],
        [
          "if",
          [
            "=",
            "seg_len",
            0
          ],
          [
            "return",
            7
          ],
          0
        ],
        [
          "if",
          [
            "<u",
            "max_seg",
            "seg_len"
          ],
          [
            "return",
            6
          ],
          0
        ],
        [
          "if",
          [
            "!=",
            "reject_parent",
            0
          ],
          [
            "if",
            [
              "std.archive._is_parent_segment_v1",
              "path",
              "seg_start",
              "seg_len"
            ],
	            [
	              "return",
	              3
	            ],
	            0
	          ],
	          0
	        ],
	        0
	      ]
	    },
    {
      "kind": "defn",
      "name": "std.archive.path_policy_posix_strict_check_v1",
      "params": [
        { "name": "path", "ty": "bytes_view" },
        { "name": "reject_non_utf8", "ty": "i32" },
        { "name": "reject_absolute", "ty": "i32" },
        { "name": "reject_parent", "ty": "i32" },
        { "name": "reject_backslash", "ty": "i32" },
        { "name": "max_path_bytes", "ty": "i32" },
        { "name": "max_segment_bytes", "ty": "i32" }
      ],
      "result": "i32",
      "body": [
        "begin",
        ["let", "n", ["view.len", "path"]],
        [
          "if",
          [
            "!=",
            "reject_non_utf8",
            0
          ],
          [
            "if",
            [
              "=",
              [
                "std.text.utf8.is_valid",
                "path"
              ],
              0
            ],
	            [
	              "return",
	              1
	            ],
	            0
	          ],
	          0
	        ],
	        [
	          "let",
          "max_path",
	        [
	          "if",
            [
              "<",
              "max_path_bytes",
              0
            ],
            0,
            "max_path_bytes"
          ]
        ],
        [
          "if",
          [
            "<u",
            "max_path",
            "n"
          ],
          [
            "return",
            5
          ],
          0
        ],
        [
          "if",
          [
            "!=",
            "reject_absolute",
            0
          ],
          [
            "if",
            [
              "if",
              [
                ">",
                "n",
                0
              ],
              [
                "=",
                [
                  "view.get_u8",
                  "path",
                  0
                ],
                47
              ],
              0
            ],
	            [
	              "return",
	              2
	            ],
	            0
	          ],
	          0
	        ],
	        [
	          "if",
          [
            "!=",
            "reject_backslash",
            0
          ],
          [
            "if",
            [
              "!=",
              [
                "std.bytes.find_u8",
                "path",
                92
              ],
              -1
            ],
            [
              "return",
              4
            ],
            0
          ],
          0
        ],
        [
          "if",
          [
            "=",
            "n",
            0
          ],
          [
            "return",
            7
          ],
          0
        ],
        ["let", "seg_start", 0],
        [
          "for",
          "i",
          0,
          "n",
          [
            "begin",
            [
              "if",
              [
                "=",
                [
                  "view.get_u8",
                  "path",
                  "i"
                ],
                47
              ],
              [
                "begin",
                ["let", "seg_len", ["-", "i", "seg_start"]],
                [
                  "let",
                  "rc",
                  [
                    "std.archive._check_segment_v1",
                    "path",
                    "seg_start",
                    "seg_len",
                    "reject_parent",
                    "max_segment_bytes"
                  ]
                ],
                [
                  "if",
                  [
                    "!=",
                    "rc",
                    0
                  ],
                  [
                    "return",
                    "rc"
                  ],
                  0
                ],
                ["set", "seg_start", ["+", "i", 1]],
                0
              ],
              0
            ],
            0
          ]
        ],
        ["let", "tail_len", ["-", "n", "seg_start"]],
        [
          "let",
          "tail_rc",
          [
            "std.archive._check_segment_v1",
            "path",
            "seg_start",
            "tail_len",
            "reject_parent",
            "max_segment_bytes"
          ]
        ],
        [
          "if",
          [
            "!=",
            "tail_rc",
            0
          ],
          [
            "return",
            "tail_rc"
          ],
          0
        ],
        0
      ]
    }
  ]
}
