{"decls":[],"imports":["std.net.codec","std.net.err","std.net.io","std.net.tcp","std.net.udp"],"kind":"entry","module_id":"main","schema_version":"x07.x07ast@0.3.0","solve":["begin",["let","caps",["std.net.codec.caps_default_v1"]],["let","caps_v",["bytes.view","caps"]],["let","found_tcp",0],["let","listener_handle",0],["let","bound_addr",["bytes.alloc",0]],["let","base_port",30000],["for","i",0,32,["begin",["if",["!=","found_tcp",0],0,["begin",["let","port",["+","base_port","i"]],["let","addr",["std.net.codec.addr_ipv4_v1",127,0,0,1,"port"]],["let","doc",["std.net.tcp.listen_v1",["bytes.view","addr"],"caps_v"]],["let","dv",["bytes.view","doc"]],["if",["std.net.err.is_err_doc_v1","dv"],["begin",["let","code",["std.net.err.err_code_v1","dv"]],["if",["=","code",["std.net.err.code_connect_v1"]],0,["return",["bytes.lit","err"]]]],["begin",["set","found_tcp",1],["set","listener_handle",["std.net.tcp.listen_listener_handle_v1","dv"]],["set","bound_addr",["std.net.tcp.listen_bound_addr_v1","dv"]],0]],0]]]],["if",["=","found_tcp",0],["return",["bytes.lit","err"]],0],["let","conn_doc",["std.net.tcp.connect_v1",["bytes.view","bound_addr"],"caps_v"]],["let","conn_v",["bytes.view","conn_doc"]],["if",["std.net.err.is_err_doc_v1","conn_v"],["return",["bytes.lit","err"]],0],["let","client_handle",["std.net.tcp.connect_stream_handle_v1","conn_v"]],["if",["<=","client_handle",0],["return",["bytes.lit","err"]],0],["let","acc_doc",["std.net.tcp.accept_v1","listener_handle","caps_v"]],["let","acc_v",["bytes.view","acc_doc"]],["if",["std.net.err.is_err_doc_v1","acc_v"],["return",["bytes.lit","err"]],0],["let","server_handle",["std.net.tcp.accept_stream_handle_v1","acc_v"]],["if",["<=","server_handle",0],["return",["bytes.lit","err"]],0],["let","ping",["bytes.lit","ping"]],["let","wdoc",["std.net.io.write_all_v1","client_handle",["bytes.view","ping"],"caps_v"]],["let","wdoc_v",["bytes.view","wdoc"]],["if",["std.net.err.is_err_doc_v1","wdoc_v"],["return",["bytes.lit","err"]],0],["if",["!=",["std.net.tcp.stream_write_bytes_written_v1","wdoc_v"],["bytes.len","ping"]],["return",["bytes.lit","err"]],0],["let","reader",["std.net.tcp.stream_reader_v1","server_handle","caps_v"]],["let","br",["bufread.new","reader",64]],["let","out",["vec_u8.with_capacity",4]],["let","have",0],["for","_",0,16,["begin",["if",[">=","have",4],0,["begin",["let","v",["bufread.fill","br"]],["let","n",["view.len","v"]],["if",["<=","n",0],["return",["bytes.lit","err"]],0],["let","need",["-",4,"have"]],["let","take",["if",[">","n","need"],"need","n"]],["set","out",["vec_u8.extend_bytes_range","out","v",0,"take"]],["let","_",["bufread.consume","br","take"]],["set","have",["+","have","take"]],0]]]],["if",["!=","have",4],["return",["bytes.lit","err"]],0],["let","got",["vec_u8.into_bytes","out"]],["if",["=",["bytes.eq",["bytes.view","got"],["bytes.view","ping"]],0],["return",["bytes.lit","err"]],0],["std.net.tcp.stream_close_v1","client_handle"],["std.net.tcp.stream_drop_v1","client_handle"],["std.net.tcp.stream_close_v1","server_handle"],["std.net.tcp.stream_drop_v1","server_handle"],["std.net.tcp.listener_close_v1","listener_handle"],["std.net.tcp.listener_drop_v1","listener_handle"],["let","found_rx",0],["let","sock_rx",0],["let","addr_rx",["bytes.alloc",0]],["for","i",0,32,["begin",["if",["!=","found_rx",0],0,["begin",["let","port",["+","base_port","i"]],["let","a",["std.net.codec.addr_ipv4_v1",127,0,0,1,"port"]],["let","doc",["std.net.udp.bind_v1",["bytes.view","a"],"caps_v"]],["let","dv",["bytes.view","doc"]],["if",["std.net.err.is_err_doc_v1","dv"],["begin",["let","code",["std.net.err.err_code_v1","dv"]],["if",["=","code",["std.net.err.code_connect_v1"]],0,["return",["bytes.lit","err"]]]],["begin",["set","found_rx",1],["set","sock_rx",["std.net.udp.bind_sock_handle_v1","dv"]],["set","addr_rx",["std.net.udp.bind_bound_addr_v1","dv"]],0]],0]]]],["if",["=","found_rx",0],["return",["bytes.lit","err"]],0],["let","rx_port",["std.net.codec.addr_port_v1",["bytes.view","addr_rx"]]],["let","found_tx",0],["let","sock_tx",0],["for","i",0,32,["begin",["if",["!=","found_tx",0],0,["begin",["let","port",["+","base_port","i"]],["if",["=","port","rx_port"],0,["begin",["let","a",["std.net.codec.addr_ipv4_v1",127,0,0,1,"port"]],["let","doc",["std.net.udp.bind_v1",["bytes.view","a"],"caps_v"]],["let","dv",["bytes.view","doc"]],["if",["std.net.err.is_err_doc_v1","dv"],["begin",["let","code",["std.net.err.err_code_v1","dv"]],["if",["=","code",["std.net.err.code_connect_v1"]],0,["return",["bytes.lit","err"]]]],["begin",["set","found_tx",1],["set","sock_tx",["std.net.udp.bind_sock_handle_v1","dv"]],0]],0]],0]]]],["if",["=","found_tx",0],["return",["bytes.lit","err"]],0],["let","umsg",["bytes.lit","hello-udp"]],["let","sdoc",["std.net.udp.sendto_v1","sock_tx",["bytes.view","addr_rx"],["bytes.view","umsg"],"caps_v"]],["let","sdoc_v",["bytes.view","sdoc"]],["if",["std.net.err.is_err_doc_v1","sdoc_v"],["return",["bytes.lit","err"]],0],["if",["!=",["std.net.udp.send_bytes_sent_v1","sdoc_v"],["bytes.len","umsg"]],["return",["bytes.lit","err"]],0],["let","ureader",["std.net.udp.recv_doc_reader_v1","sock_rx","caps_v"]],["let","udoc",["io.read","ureader",4096]],["let","udoc_v",["bytes.view","udoc"]],["if",["std.net.err.is_err_doc_v1","udoc_v"],["return",["bytes.lit","err"]],0],["let","upayload",["std.net.udp.recv_payload_v1","udoc_v"]],["if",["=",["bytes.eq",["bytes.view","upayload"],["bytes.view","umsg"]],0],["return",["bytes.lit","err"]],0],["std.net.udp.close_v1","sock_rx"],["std.net.udp.drop_v1","sock_rx"],["std.net.udp.close_v1","sock_tx"],["std.net.udp.drop_v1","sock_tx"],["bytes.lit","ok"]]}
