{"decls":[],"imports":["ext.data_model","ext.hex","std.db","std.db.params","std.db.spec"],"kind":"entry","module_id":"main","schema_version":"x07.x07ast@0.1.0","solve":["begin",["let","caps",["std.db.spec.caps_default_v1"]],["let","uri",["bytes.lit","postgres://x07:x07@127.0.0.1:5432/x07"]],["let","open_resp",["std.db.open_v1","uri","caps"]],["if",["=",["std.db.spec.resp_is_ok_v1","open_resp"],0],["return",["bytes.lit","FAIL_open"]],0],["let","conn",["std.db.open_handle_v1","open_resp"]],["let","sql_create",["begin",["let","hex",["bytes.lit","4352454154452054454d50205441424c452074286e20494e54293b"]],["let","doc",["ext.hex.hex_decode",["bytes.view","hex"]]],["ext.hex.hex_get_bytes",["bytes.view","doc"]]]],["let","resp_create",["std.db.exec_v1","conn","sql_create",["std.db.params.empty_v1"],"caps"]],["if",["=",["std.db.spec.resp_is_ok_v1","resp_create"],0],["return",["bytes.lit","FAIL_create"]],0],["let","sql_ins",["begin",["let","hex",["bytes.lit","494e5345525420494e544f2074286e292056414c55455320283432293b"]],["let","doc",["ext.hex.hex_decode",["bytes.view","hex"]]],["ext.hex.hex_get_bytes",["bytes.view","doc"]]]],["let","resp_ins",["std.db.exec_v1","conn","sql_ins",["std.db.params.empty_v1"],"caps"]],["if",["=",["std.db.spec.resp_is_ok_v1","resp_ins"],0],["return",["bytes.lit","FAIL_insert"]],0],["if",["!=",["std.db.exec_rows_affected_v1","resp_ins"],1],["return",["bytes.lit","FAIL_insert_ra"]],0],["let","sql_query",["begin",["let","hex",["bytes.lit","53454c454354206e2046524f4d2074204f52444552204259206e3b"]],["let","doc",["ext.hex.hex_decode",["bytes.view","hex"]]],["ext.hex.hex_get_bytes",["bytes.view","doc"]]]],["let","resp_q",["std.db.query_v1","conn","sql_query",["std.db.params.empty_v1"],"caps"]],["if",["=",["std.db.spec.resp_is_ok_v1","resp_q"],0],["return",["bytes.lit","FAIL_query"]],0],["let","got_doc",["std.db.spec.resp_ok_payload_v1","resp_q"]],["let","c_n",["begin",["let","s",["bytes.lit","n"]],["ext.data_model.value_string",["bytes.view","s"]]]],["let","cols_elems",["vec_u8.with_capacity",0]],["set","cols_elems",["vec_u8.extend_bytes","cols_elems",["codec.write_u32_le",1]]],["set","cols_elems",["vec_u8.extend_bytes","cols_elems",["codec.write_u32_le",["bytes.len","c_n"]]]],["set","cols_elems",["vec_u8.extend_bytes","cols_elems","c_n"]],["let","cols_elems_b",["vec_u8.into_bytes","cols_elems"]],["let","cols_val",["ext.data_model.value_seq_from_elems",["bytes.view","cols_elems_b"]]],["let","n42",["begin",["let","s",["bytes.lit","42"]],["ext.data_model.value_number",["bytes.view","s"]]]],["let","row1_elems",["vec_u8.with_capacity",0]],["set","row1_elems",["vec_u8.extend_bytes","row1_elems",["codec.write_u32_le",1]]],["set","row1_elems",["vec_u8.extend_bytes","row1_elems",["codec.write_u32_le",["bytes.len","n42"]]]],["set","row1_elems",["vec_u8.extend_bytes","row1_elems","n42"]],["let","row1_elems_b",["vec_u8.into_bytes","row1_elems"]],["let","row1",["ext.data_model.value_seq_from_elems",["bytes.view","row1_elems_b"]]],["let","rows_elems",["vec_u8.with_capacity",0]],["set","rows_elems",["vec_u8.extend_bytes","rows_elems",["codec.write_u32_le",1]]],["set","rows_elems",["vec_u8.extend_bytes","rows_elems",["codec.write_u32_le",["bytes.len","row1"]]]],["set","rows_elems",["vec_u8.extend_bytes","rows_elems","row1"]],["let","rows_elems_b",["vec_u8.into_bytes","rows_elems"]],["let","rows_val",["ext.data_model.value_seq_from_elems",["bytes.view","rows_elems_b"]]],["let","entries",["vec_u8.with_capacity",0]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",2]]],["let","k_cols",["bytes.lit","cols"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","k_cols"]]]],["set","entries",["vec_u8.extend_bytes","entries","k_cols"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","cols_val"]]]],["set","entries",["vec_u8.extend_bytes","entries","cols_val"]],["let","k_rows",["bytes.lit","rows"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","k_rows"]]]],["set","entries",["vec_u8.extend_bytes","entries","k_rows"]],["set","entries",["vec_u8.extend_bytes","entries",["codec.write_u32_le",["bytes.len","rows_val"]]]],["set","entries",["vec_u8.extend_bytes","entries","rows_val"]],["let","entries_b",["vec_u8.into_bytes","entries"]],["let","map_val",["ext.data_model.value_map_from_entries",["bytes.view","entries_b"]]],["let","expected_doc",["ext.data_model.doc_ok",["bytes.view","map_val"]]],["if",["=",["bytes.eq","got_doc","expected_doc"],0],["return",["bytes.lit","FAIL_doc_mismatch"]],0],["let","close_resp",["std.db.close_v1","conn","caps"]],["if",["=",["std.db.spec.resp_is_ok_v1","close_resp"],0],["return",["bytes.lit","FAIL_close"]],0],["bytes.lit","OK"]]}
