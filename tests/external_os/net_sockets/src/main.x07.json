{"decls":[],"imports":["std.net.codec","std.net.dns","std.net.err","std.net.io","std.net.tcp","std.net.udp"],"kind":"entry","module_id":"main","schema_version":"x07.x07ast@0.3.0","solve":["begin",["let","caps",["std.net.codec.caps_default_v1"]],["let","caps_v",["bytes.view","caps"]],["let","name",["bytes.lit","localhost"]],["let","dns_doc",["std.net.dns.lookup_v1",["bytes.view","name"],80,"caps_v"]],["let","dns_v",["bytes.view","dns_doc"]],["if",["std.net.err.is_err_doc_v1","dns_v"],["return",["bytes.lit","err"]],0],["let","dns_count",["std.net.dns.count_v1","dns_v"]],["if",["<=","dns_count",0],["return",["bytes.lit","err"]],0],["let","dns_addr0",["std.net.dns.addr_at_v1","dns_v",0]],["if",["<=",["bytes.len","dns_addr0"],0],["return",["bytes.lit","err"]],0],["let","dns_tag",["std.net.codec.addr_tag_v1",["bytes.view","dns_addr0"]]],["if",["=","dns_tag",0],["return",["bytes.lit","err"]],0],["let","found_tcp",0],["let","listener_handle",0],["let","bound_addr",["bytes.alloc",0]],["let","base_port",30000],["for","i",0,32,["begin",["if",["!=","found_tcp",0],0,["begin",["let","port",["+","base_port","i"]],["let","addr",["std.net.codec.addr_ipv4_v1",127,0,0,1,"port"]],["let","doc",["std.net.tcp.listen_v1",["bytes.view","addr"],"caps_v"]],["let","dv",["bytes.view","doc"]],["if",["std.net.err.is_err_doc_v1","dv"],["begin",["let","code",["std.net.err.err_code_v1","dv"]],["if",["=","code",["std.net.err.code_connect_v1"]],0,["return",["bytes.lit","err"]]]],["begin",["set","found_tcp",1],["set","listener_handle",["std.net.tcp.listen_listener_handle_v1","dv"]],["set","bound_addr",["std.net.tcp.listen_bound_addr_v1","dv"]],0]],0]],0]],["if",["=","found_tcp",0],["return",["bytes.lit","err"]],0],["if",["<=",["bytes.len","bound_addr"],0],["return",["bytes.lit","err"]],0],["let","conn_doc",["std.net.tcp.connect_v1",["bytes.view","bound_addr"],"caps_v"]],["let","conn_v",["bytes.view","conn_doc"]],["if",["std.net.err.is_err_doc_v1","conn_v"],["return",["bytes.lit","err"]],0],["let","client_handle",["std.net.tcp.connect_stream_handle_v1","conn_v"]],["if",["<=","client_handle",0],["return",["bytes.lit","err"]],0],["let","acc_doc",["std.net.tcp.accept_v1","listener_handle","caps_v"]],["let","acc_v",["bytes.view","acc_doc"]],["if",["std.net.err.is_err_doc_v1","acc_v"],["return",["bytes.lit","err"]],0],["let","server_handle",["std.net.tcp.accept_stream_handle_v1","acc_v"]],["if",["<=","server_handle",0],["return",["bytes.lit","err"]],0],["let","wait_doc",["std.net.tcp.stream_wait_v1","client_handle",["std.net.tcp.wait_writable_v1"],0]],["let","wait_v",["bytes.view","wait_doc"]],["if",["std.net.err.is_err_doc_v1","wait_v"],["return",["bytes.lit","err"]],0],["std.net.tcp.stream_wait_events_v1","wait_v"],["let","ping",["bytes.lit","ping"]],["let","wdoc1",["std.net.io.write_all_v1","client_handle",["bytes.view","ping"],"caps_v"]],["let","wdoc1_v",["bytes.view","wdoc1"]],["if",["std.net.err.is_err_doc_v1","wdoc1_v"],["return",["bytes.lit","err"]],0],["if",["!=",["std.net.tcp.stream_write_bytes_written_v1","wdoc1_v"],["bytes.len","ping"]],["return",["bytes.lit","err"]],0],["let","rdoc1",["std.net.tcp.stream_read_v1","server_handle",1024,"caps_v"]],["let","rdoc1_v",["bytes.view","rdoc1"]],["if",["std.net.err.is_err_doc_v1","rdoc1_v"],["return",["bytes.lit","err"]],0],["let","got1",["std.net.tcp.stream_read_payload_v1","rdoc1_v"]],["if",["=",["bytes.eq",["bytes.view","got1"],["bytes.view","ping"]],0],["return",["bytes.lit","err"]],0],["let","pong",["bytes.lit","pong"]],["let","wdoc2",["std.net.io.write_all_v1","server_handle",["bytes.view","pong"],"caps_v"]],["let","wdoc2_v",["bytes.view","wdoc2"]],["if",["std.net.err.is_err_doc_v1","wdoc2_v"],["return",["bytes.lit","err"]],0],["if",["!=",["std.net.tcp.stream_write_bytes_written_v1","wdoc2_v"],["bytes.len","pong"]],["return",["bytes.lit","err"]],0],["let","rdoc2",["std.net.tcp.stream_read_v1","client_handle",1024,"caps_v"]],["let","rdoc2_v",["bytes.view","rdoc2"]],["if",["std.net.err.is_err_doc_v1","rdoc2_v"],["return",["bytes.lit","err"]],0],["let","got2",["std.net.tcp.stream_read_payload_v1","rdoc2_v"]],["if",["=",["bytes.eq",["bytes.view","got2"],["bytes.view","pong"]],0],["return",["bytes.lit","err"]],0],["std.net.tcp.stream_close_v1","client_handle"],["std.net.tcp.stream_drop_v1","client_handle"],["std.net.tcp.stream_close_v1","server_handle"],["std.net.tcp.stream_drop_v1","server_handle"],["std.net.tcp.listener_close_v1","listener_handle"],["std.net.tcp.listener_drop_v1","listener_handle"],["let","found_rx",0],["let","sock_rx",0],["let","addr_rx",["bytes.alloc",0]],["for","i",0,32,["begin",["if",["!=","found_rx",0],0,["begin",["let","port",["+","base_port","i"]],["let","a",["std.net.codec.addr_ipv4_v1",127,0,0,1,"port"]],["let","doc",["std.net.udp.bind_v1",["bytes.view","a"],"caps_v"]],["let","dv",["bytes.view","doc"]],["if",["std.net.err.is_err_doc_v1","dv"],["begin",["let","code",["std.net.err.err_code_v1","dv"]],["if",["=","code",["std.net.err.code_connect_v1"]],0,["return",["bytes.lit","err"]]]],["begin",["set","found_rx",1],["set","sock_rx",["std.net.udp.bind_sock_handle_v1","dv"]],["set","addr_rx",["std.net.udp.bind_bound_addr_v1","dv"]],0]],0]],0]],["if",["=","found_rx",0],["return",["bytes.lit","err"]],0],["if",["<=","sock_rx",0],["return",["bytes.lit","err"]],0],["let","rx_port",["std.net.codec.addr_port_v1",["bytes.view","addr_rx"]]],["let","found_tx",0],["let","sock_tx",0],["for","i",0,32,["begin",["if",["!=","found_tx",0],0,["begin",["let","port",["+","base_port","i"]],["if",["=","port","rx_port"],0,["begin",["let","a",["std.net.codec.addr_ipv4_v1",127,0,0,1,"port"]],["let","doc",["std.net.udp.bind_v1",["bytes.view","a"],"caps_v"]],["let","dv",["bytes.view","doc"]],["if",["std.net.err.is_err_doc_v1","dv"],["begin",["let","code",["std.net.err.err_code_v1","dv"]],["if",["=","code",["std.net.err.code_connect_v1"]],0,["return",["bytes.lit","err"]]]],["begin",["set","found_tx",1],["set","sock_tx",["std.net.udp.bind_sock_handle_v1","dv"]],0]],0]],0]],0]],["if",["=","found_tx",0],["return",["bytes.lit","err"]],0],["if",["<=","sock_tx",0],["return",["bytes.lit","err"]],0],["let","umsg",["bytes.lit","hello-udp"]],["let","sdoc",["std.net.udp.sendto_v1","sock_tx",["bytes.view","addr_rx"],["bytes.view","umsg"],"caps_v"]],["let","sdoc_v",["bytes.view","sdoc"]],["if",["std.net.err.is_err_doc_v1","sdoc_v"],["return",["bytes.lit","err"]],0],["if",["!=",["std.net.udp.send_bytes_sent_v1","sdoc_v"],["bytes.len","umsg"]],["return",["bytes.lit","err"]],0],["let","udoc",["std.net.udp.recvfrom_v1","sock_rx",1024,"caps_v"]],["let","udoc_v",["bytes.view","udoc"]],["if",["std.net.err.is_err_doc_v1","udoc_v"],["return",["bytes.lit","err"]],0],["let","upayload",["std.net.udp.recv_payload_v1","udoc_v"]],["if",["=",["bytes.eq",["bytes.view","upayload"],["bytes.view","umsg"]],0],["return",["bytes.lit","err"]],0],["std.net.udp.close_v1","sock_rx"],["std.net.udp.drop_v1","sock_rx"],["std.net.udp.close_v1","sock_tx"],["std.net.udp.drop_v1","sock_tx"],["bytes.lit","ok"]]}
