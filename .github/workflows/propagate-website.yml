name: Propagate Website

on:
  push:
    branches:
      - fix/propagate-website
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (for example: v0.2.0)"
        required: true
      set_latest:
        description: Update latest_toolchain_version
        required: false
        default: "true"
      published_at_utc:
        description: Optional published_at_utc (ISO8601, UTC)
        required: false

permissions:
  contents: read

jobs:
  propagate:
    name: propagate / website
    runs-on: ubuntu-latest
    env:
      X07_BOT_TOKEN: ${{ secrets.X07_BOT_TOKEN }}
    steps:
      - name: Fail (missing X07_BOT_TOKEN)
        if: ${{ env.X07_BOT_TOKEN == '' }}
        run: |
          echo "X07_BOT_TOKEN is not set"
          exit 2

      - name: Checkout (x07)
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Resolve tag + options
        shell: bash
        run: |
          set -euo pipefail

          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            python3 - <<'PY' >"${RUNNER_TEMP}/propagate_env.txt"
          import json
          import os

          with open(os.environ["GITHUB_EVENT_PATH"], "r", encoding="utf-8") as f:
              payload = json.load(f)

          inputs = payload.get("inputs") or {}
          tag = str(inputs.get("tag") or "").strip()
          set_latest = str(inputs.get("set_latest") or "true").strip()
          published_at_utc = str(inputs.get("published_at_utc") or "").strip()

          if not tag:
              raise SystemExit("ERROR: workflow_dispatch missing inputs.tag")

          print(f"TAG={tag}")
          print(f"SET_LATEST={set_latest}")
          print(f"PUBLISHED_AT_UTC={published_at_utc}")
          PY
            cat "${RUNNER_TEMP}/propagate_env.txt" >> "$GITHUB_ENV"
            exit 0
          fi

          echo "TAG=v0.1.0" >> "$GITHUB_ENV"
          echo "SET_LATEST=true" >> "$GITHUB_ENV"
          echo "PUBLISHED_AT_UTC=" >> "$GITHUB_ENV"

      - name: Build docs bundle
        run: python3 scripts/build_docs_bundle.py --tag "${TAG}"

      - name: Checkout (x07-website)
        uses: actions/checkout@v4
        with:
          repository: x07lang/x07-website
          path: x07-website
          token: ${{ env.X07_BOT_TOKEN }}

      - name: Sync docs+agent into x07-website
        working-directory: x07-website
        run: |
          set -euo pipefail
          tag="${TAG}"
          args=()
          if [ "${SET_LATEST}" = "true" ]; then
            args+=(--set-latest)
          fi
          if [ -n "${PUBLISHED_AT_UTC}" ]; then
            args+=(--published-at-utc "${PUBLISHED_AT_UTC}")
          fi
          python3 ../scripts/open_pr_website_update.py \
            --tag "$tag" \
            --bundle "../dist/x07-docs-${tag}.tar.gz" \
            "${args[@]}"

      - name: Open PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ env.X07_BOT_TOKEN }}
          path: x07-website
          branch: bot/website-sync-${{ github.run_id }}
          commit-message: "release: sync website"
          title: "release: sync website"
          body: Automated website sync.
