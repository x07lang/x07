name: Propagate Website

on:
  release:
    types:
      - published
  workflow_run:
    workflows:
      - Release
    types:
      - completed
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (for example: v0.2.0)"
        required: true
      set_latest:
        description: Update latest_toolchain_version
        required: false
        default: "true"
      published_at_utc:
        description: Optional published_at_utc (ISO8601, UTC)
        required: false

permissions:
  contents: read

jobs:
  propagate:
    name: propagate / website
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    env:
      X07_BOT_TOKEN: ${{ secrets.X07_BOT_TOKEN }}
      X07_BOT_SSH_SIGNING_KEY: ${{ secrets.X07_BOT_SSH_SIGNING_KEY }}
    steps:
      - name: Resolve tag and options
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          case "${GITHUB_EVENT_NAME}" in
            workflow_dispatch)
              tag="$(jq -r '.inputs.tag' "$GITHUB_EVENT_PATH")"
              set_latest="$(jq -r '.inputs.set_latest // "true"' "$GITHUB_EVENT_PATH")"
              published_at_utc="$(jq -r '.inputs.published_at_utc // ""' "$GITHUB_EVENT_PATH")"
              ;;
            workflow_run)
              tag="$(jq -r '.workflow_run.head_branch' "$GITHUB_EVENT_PATH")"
              set_latest="true"
              published_at_utc=""
              ;;
            release)
              tag="$(jq -r '.release.tag_name' "$GITHUB_EVENT_PATH")"
              set_latest="true"
              published_at_utc="$(jq -r '.release.published_at // ""' "$GITHUB_EVENT_PATH")"
              ;;
            *)
              echo "ERROR: unsupported event: ${GITHUB_EVENT_NAME}" >&2
              exit 2
              ;;
          esac
          if [[ -z "$tag" || "$tag" == "null" ]]; then
            echo "ERROR: missing tag" >&2
            exit 2
          fi
          if [[ -z "$set_latest" || "$set_latest" == "null" ]]; then
            set_latest="true"
          fi
          if [[ "$published_at_utc" == "null" ]]; then
            published_at_utc=""
          fi
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "set_latest=$set_latest" >> "$GITHUB_OUTPUT"
          echo "published_at_utc=$published_at_utc" >> "$GITHUB_OUTPUT"

      - name: Fail (missing X07_BOT_TOKEN)
        if: ${{ env.X07_BOT_TOKEN == '' }}
        run: |
          echo "X07_BOT_TOKEN is not set"
          exit 2

      - name: Checkout (x07)
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.vars.outputs.tag }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build docs bundle
        run: python3 scripts/build_docs_bundle.py --tag "${{ steps.vars.outputs.tag }}"

      - name: Download channels manifest (install)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          tag="${{ steps.vars.outputs.tag }}"
          mkdir -p dist
          gh release download "$tag" --pattern "channels.json" --dir dist

      - name: Checkout (x07-website)
        uses: actions/checkout@v4
        with:
          repository: x07lang/x07-website
          path: x07-website
          token: ${{ env.X07_BOT_TOKEN }}

      - name: Sync docs+agent into x07-website
        working-directory: x07-website
        run: |
          set -euo pipefail
          tag="${{ steps.vars.outputs.tag }}"
          args=()
          if [ "${{ steps.vars.outputs.set_latest }}" = "true" ]; then
            args+=(--set-latest)
          fi
          if [ -n "${{ steps.vars.outputs.published_at_utc }}" ]; then
            args+=(--published-at-utc "${{ steps.vars.outputs.published_at_utc }}")
          fi
          python3 ../scripts/open_pr_website_update.py \
            --tag "$tag" \
            --bundle "../dist/x07-docs-${tag}.tar.gz" \
            "${args[@]}"

      - name: Commit + push (x07-website main)
        working-directory: x07-website
        run: |
          set -euo pipefail
          tag="${{ steps.vars.outputs.tag }}"

          if [ -z "$(git status --porcelain)" ]; then
            echo "ok: no website changes to push"
            exit 0
          fi

          git status --porcelain
          git config user.name "x07-bot"
          git config user.email "x07-bot@users.noreply.github.com"
          if [ -n "${X07_BOT_SSH_SIGNING_KEY:-}" ]; then
            key_file="$HOME/.ssh/x07-bot-signing-key"
            mkdir -p "$(dirname "$key_file")"
            printf '%s' "$X07_BOT_SSH_SIGNING_KEY" > "$key_file"
            chmod 600 "$key_file"
            git config gpg.format ssh
            git config user.signingkey "$key_file"
            git config commit.gpgsign true
          fi
          git add -A
          if [ -n "${X07_BOT_SSH_SIGNING_KEY:-}" ]; then
            git commit -S -m "release: sync website for ${tag}"
          else
            git commit -m "release: sync website for ${tag}"
          fi

          git fetch origin main
          git rebase origin/main
          git push origin HEAD:main
