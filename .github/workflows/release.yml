name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-matrix:
    name: release / build-matrix (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - macos-15-intel
          - macos-14
          - windows-latest
    env:
      X07_PYTHON: python
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Rust (rust-toolchain.toml)
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install deps (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang \
            build-essential \
            pkg-config \
            libssl-dev \
            libcurl4-openssl-dev \
            zlib1g-dev \
            libsqlite3-dev

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install openssl@3 pkg-config

      - name: Set up MSYS2 (UCRT64, C toolchain + libs)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-lld
            mingw-w64-ucrt-x86_64-openssl
            mingw-w64-ucrt-x86_64-curl
            mingw-w64-ucrt-x86_64-sqlite3
            mingw-w64-ucrt-x86_64-zlib
            mingw-w64-ucrt-x86_64-pkgconf

      - name: Add MSYS2 UCRT64 to PATH
        if: runner.os == 'Windows'
        shell: bash
        run: echo "${RUNNER_TEMP}\\\\msys64\\\\ucrt64\\\\bin" >> "$GITHUB_PATH"

      - name: Select MSYS2 gcc for builds
        if: runner.os == 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          runner_temp_posix="${RUNNER_TEMP//\\//}"
          gcc_path="${runner_temp_posix}/msys64/ucrt64/bin/gcc.exe"
          if [[ ! -x "$gcc_path" ]]; then
            echo "ERROR: expected MSYS2 gcc at: $gcc_path" >&2
            exit 2
          fi
          echo "X07_CC=$gcc_path" >> "$GITHUB_ENV"
          echo "X07_CC_ARGS=-fuse-ld=lld" >> "$GITHUB_ENV"

      - name: CI gate
        shell: bash
        run: ./scripts/ci/check_all.sh

      - name: Build release binaries
        shell: bash
        run: |
          set -euo pipefail
          cargo build --release -p x07 -p x07c -p x07-host-runner -p x07-os-runner -p x07import-cli -p x07up

      - name: Detect Rust host target triple
        shell: bash
        run: |
          set -euo pipefail
          target="$(rustc -vV | awk -F': ' '/^host:/{print $2}')"
          if [[ -z "$target" ]]; then
            echo "ERROR: failed to detect rustc host triple" >&2
            exit 2
          fi
          echo "X07_TARGET=$target" >> "$GITHUB_ENV"

      - name: Smoke x07-host-runner cache fallback
        shell: bash
        run: |
          set -euo pipefail

          # Simulate an "end-user machine" where the original workspace cache directory
          # is unavailable (the build path is baked into the binary at compile time).
          rm -rf target/x07-native-cache || true
          mkdir -p target
          echo "blocked" > target/x07-native-cache

          tmp="$(mktemp -d)"
          cat >"${tmp}/program.x07.json" <<'JSON'
          {"schema_version":"x07.x07ast@0.2.0","kind":"entry","module_id":"main","imports":[],"decls":[],"solve":["view.to_bytes","input"]}
          JSON
          printf 'hi' >"${tmp}/input.bin"

          exe="target/release/x07-host-runner"
          if [ "${RUNNER_OS}" = "Windows" ]; then
            exe="${exe}.exe"
          fi

          "${exe}" --program "${tmp}/program.x07.json" --world solve-pure --input "${tmp}/input.bin" \
            | python -c 'import base64,json,sys; report=json.load(sys.stdin); expected=base64.b64encode(b"hi").decode("ascii"); exit_code=report.get("exit_code"); out=(report.get("solve") or {}).get("solve_output_b64"); assert exit_code==0, report; assert out==expected, (out, expected); print("ok: relocated host-runner smoke passed")'

      - name: Build and stage native backends (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/build_ext_regex.sh
          ./scripts/build_ext_fs.sh
          ./scripts/build_ext_math.sh
          ./scripts/build_ext_time.sh
          ./scripts/build_ext_db_sqlite.sh
          ./scripts/build_ext_db_pg.sh
          ./scripts/build_ext_db_mysql.sh
          ./scripts/build_ext_db_redis.sh

      - name: Package binaries (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          target="${X07_TARGET}"
          out="dist/x07-${tag}-${target}.tar.gz"
          mkdir -p dist
          scripts/build_toolchain_tarball.sh --tag "$tag" --platform "${{ runner.os }}" --out "$out"

      - name: Package x07up (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          target="${X07_TARGET}"
          out="dist/x07up-${tag}-${target}.tar.gz"
          stage="dist/.tmp_x07up_${tag}_${target}"
          rm -rf "$stage"
          mkdir -p "$stage"
          cp -f "target/release/x07up" "$stage/x07up"
          chmod 0755 "$stage/x07up"
          tar -czf "$out" -C "$stage" x07up

      - name: Package toolchain (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $tag = $env:GITHUB_REF_NAME
          New-Item -ItemType Directory -Force dist | Out-Null
          $target = $env:X07_TARGET
          $stage = "dist/.tmp_toolchain_${tag}_Windows"
          Remove-Item -Recurse -Force $stage -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force "$stage/bin" | Out-Null
          New-Item -ItemType Directory -Force "$stage/deps/x07" | Out-Null
          New-Item -ItemType Directory -Force "$stage/stdlib/os/0.2.0" | Out-Null
          New-Item -ItemType Directory -Force "$stage/docs" | Out-Null
          New-Item -ItemType Directory -Force "$stage/.codex/skills" | Out-Null

          $bins = @("x07","x07c","x07-host-runner","x07-os-runner","x07import-cli")
          foreach ($b in $bins) {
            Copy-Item -Force "target/release/$b.exe" "$stage/bin/$b.exe"
          }

          Copy-Item -Force "deps/x07/native_backends.json" "$stage/deps/x07/native_backends.json"
          Copy-Item -Recurse -Force "stdlib/os/0.2.0/modules" "$stage/stdlib/os/0.2.0"
          Copy-Item -Recurse -Force "docs/*" "$stage/docs"
          Copy-Item -Recurse -Force "skills/pack/.codex/skills/*" "$stage/.codex/skills"

          $out = "dist/x07-$tag-$target.zip"
          Compress-Archive -Path "$stage/*" -DestinationPath $out -Force

      - name: Package x07up (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $tag = $env:GITHUB_REF_NAME
          $target = $env:X07_TARGET
          New-Item -ItemType Directory -Force dist | Out-Null
          $stage = "dist/.tmp_x07up_${tag}_Windows"
          Remove-Item -Recurse -Force $stage -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force $stage | Out-Null
          Copy-Item -Force "target/release/x07up.exe" "$stage/x07up.exe"
          $out = "dist/x07up-$tag-$target.zip"
          Compress-Archive -Path "$stage/*" -DestinationPath $out -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: x07-${{ github.ref_name }}-${{ matrix.os }}
          path: |
            dist/x07-${{ github.ref_name }}-*.tar.gz
            dist/x07-${{ github.ref_name }}-*.zip
            dist/x07up-${{ github.ref_name }}-*.tar.gz
            dist/x07up-${{ github.ref_name }}-*.zip

  build-linux-aarch64:
    name: release / build-linux-aarch64
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    env:
      X07_PYTHON: python3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (arm64)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build and package (aarch64)
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          install: |
            apt-get update
            apt-get install -y --no-install-recommends \
              clang \
              build-essential \
              pkg-config \
              libssl-dev \
              libcurl4-openssl-dev \
              zlib1g-dev \
              libsqlite3-dev \
              python3 \
              ca-certificates \
              curl \
              git
            curl -sSf https://sh.rustup.rs | sh -s -- -y
          run: |
            set -euo pipefail
            git config --global --add safe.directory "$(pwd)"
            source "$HOME/.cargo/env"

            tag="$(git describe --tags --exact-match)"
            target="$(rustc -vV | awk -F': ' '/^host:/{print $2}')"
            if [[ -z "$tag" || -z "$target" ]]; then
              echo "ERROR: failed to detect tag/target (tag=$tag target=$target)" >&2
              exit 2
            fi

            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=clang
            cargo build --release -p x07 -p x07c -p x07-host-runner -p x07-os-runner -p x07import-cli -p x07up

            # Smoke: compile+run a minimal solve-pure program.
            tmp="$(mktemp -d)"
            cat >"${tmp}/program.x07.json" <<'JSON'
            {"schema_version":"x07.x07ast@0.2.0","kind":"entry","module_id":"main","imports":[],"decls":[],"solve":["view.to_bytes","input"]}
            JSON
            printf 'hi' >"${tmp}/input.bin"
            target/release/x07-host-runner --program "${tmp}/program.x07.json" --world solve-pure --input "${tmp}/input.bin" \
              | python3 -c 'import base64,json,sys; report=json.load(sys.stdin); expected=base64.b64encode(b"hi").decode("ascii"); assert report.get("exit_code")==0, report; out=(report.get("solve") or {}).get("solve_output_b64"); assert out==expected, (out, expected)'

            ./scripts/build_ext_regex.sh
            ./scripts/build_ext_fs.sh
            ./scripts/build_ext_math.sh
            ./scripts/build_ext_time.sh
            ./scripts/build_ext_db_sqlite.sh
            ./scripts/build_ext_db_pg.sh
            ./scripts/build_ext_db_mysql.sh
            ./scripts/build_ext_db_redis.sh

            mkdir -p dist
            scripts/build_toolchain_tarball.sh --tag "$tag" --platform Linux --out "dist/x07-${tag}-${target}.tar.gz"

            stage="dist/.tmp_x07up_${tag}_${target}"
            rm -rf "$stage"
            mkdir -p "$stage"
            cp -f "target/release/x07up" "$stage/x07up"
            chmod 0755 "$stage/x07up"
            tar -czf "dist/x07up-${tag}-${target}.tar.gz" -C "$stage" x07up

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: x07-${{ github.ref_name }}-linux-aarch64
          path: |
            dist/x07-${{ github.ref_name }}-*.tar.gz
            dist/x07up-${{ github.ref_name }}-*.tar.gz

  publish:
    name: release / publish
    runs-on: ubuntu-latest
    needs:
      - build-matrix
      - build-linux-aarch64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten toolchain artifacts
        shell: bash
        run: |
          set -euo pipefail
          files=()
          while IFS= read -r -d '' f; do
            files+=("$f")
          done < <(find dist -type f \( -name 'x07-*.tar.gz' -o -name 'x07-*.zip' -o -name 'x07up-*.tar.gz' -o -name 'x07up-*.zip' \) -print0)

          for f in "${files[@]}"; do
            base="$(basename "$f")"
            cp -f "$f" "dist/$base"
          done

      - name: Build release manifest
        run: python3 scripts/build_release_manifest.py --out dist/release-manifest.json

      - name: Build skills pack
        run: python3 scripts/build_skills_pack.py --tag "${{ github.ref_name }}" --out "dist/x07-skills-${{ github.ref_name }}.tar.gz"

      - name: Build docs bundle
        run: python3 scripts/build_docs_bundle.py --tag "${{ github.ref_name }}"

      - name: Build channels manifest (install)
        run: python3 scripts/build_channels_json.py --tag "${{ github.ref_name }}" --out dist/channels.json

      - name: Publish GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          tag="${GITHUB_REF_NAME}"

          if ! gh release view "$tag" >/dev/null 2>&1; then
            gh release create "$tag" --title "$tag" --generate-notes --verify-tag
          fi

          files=()
          while IFS= read -r -d '' f; do
            files+=("$f")
          done < <(find dist -maxdepth 1 -type f \( -name 'x07-*.tar.gz' -o -name 'x07-*.zip' -o -name 'x07up-*.tar.gz' -o -name 'x07up-*.zip' -o -name 'release-manifest.json' -o -name 'channels.json' \) -print0)

          if (( ${#files[@]} == 0 )); then
            echo "ERROR: no release assets found under dist/" >&2
            exit 2
          fi

          gh release upload "$tag" "${files[@]}" --clobber
