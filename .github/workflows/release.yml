name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write

jobs:
  build-matrix:
    name: release / build-matrix (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - macos-15-intel
          - macos-14
    env:
      X07_PYTHON: python
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        shell: bash
        run: ./scripts/ci/install_python_deps.sh

      - name: Set up Rust (rust-toolchain.toml)
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install deps (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang \
            build-essential \
            pkg-config \
            libssl-dev \
            libcurl4-openssl-dev \
            liblzma-dev \
            zlib1g-dev \
            libsqlite3-dev

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install openssl@3 pkg-config

      - name: CI gate
        shell: bash
        run: ./scripts/ci/check_all.sh

      - name: Build release binaries
        shell: bash
        run: |
          set -euo pipefail
          cargo build --release -p x07 -p x07c -p x07-host-runner -p x07-os-runner -p x07-vm-launcher -p x07-vm-reaper -p x07import-cli -p x07up

      - name: Build x07-vz-helper (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: ./scripts/build_vz_helper.sh ./target/release/x07-vz-helper

      - name: Detect Rust host target triple
        shell: bash
        run: |
          set -euo pipefail
          target="$(rustc -vV | awk -F': ' '/^host:/{print $2}')"
          if [[ -z "$target" ]]; then
            echo "ERROR: failed to detect rustc host triple" >&2
            exit 2
          fi
          echo "X07_TARGET=$target" >> "$GITHUB_ENV"

      - name: Smoke x07-host-runner cache fallback
        shell: bash
        run: |
          set -euo pipefail

          # Simulate an "end-user machine" where the original workspace cache directory
          # is unavailable (the build path is baked into the binary at compile time).
          rm -rf target/x07-native-cache || true
          mkdir -p target
          echo "blocked" > target/x07-native-cache

          tmp="$(mktemp -d)"
          cat >"${tmp}/program.x07.json" <<'JSON'
          {"schema_version":"x07.x07ast@0.3.0","kind":"entry","module_id":"main","imports":[],"decls":[],"solve":["view.to_bytes","input"]}
          JSON
          printf 'hi' >"${tmp}/input.bin"

          target/release/x07-host-runner --program "${tmp}/program.x07.json" --world solve-pure --input "${tmp}/input.bin" \
            | python -c 'import base64,json,sys; report=json.load(sys.stdin); expected=base64.b64encode(b"hi").decode("ascii"); exit_code=report.get("exit_code"); out=(report.get("solve") or {}).get("solve_output_b64"); assert exit_code==0, report; assert out==expected, (out, expected); print("ok: relocated host-runner smoke passed")'

      - name: Build and stage native backends
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/build_ext_regex.sh
          ./scripts/build_ext_fs.sh
          ./scripts/build_ext_math.sh
          ./scripts/build_ext_stream_xf.sh
          ./scripts/build_ext_time.sh
          ./scripts/build_ext_db_sqlite.sh
          ./scripts/build_ext_db_pg.sh
          ./scripts/build_ext_db_mysql.sh
          ./scripts/build_ext_db_redis.sh

      - name: Package toolchain
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          target="${X07_TARGET}"
          out="dist/x07-${tag}-${target}.tar.gz"
          mkdir -p dist
          scripts/build_toolchain_tarball.sh --tag "$tag" --platform "${{ runner.os }}" --out "$out"

      - name: Package x07up
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          target="${X07_TARGET}"
          out="dist/x07up-${tag}-${target}.tar.gz"
          stage="dist/.tmp_x07up_${tag}_${target}"
          rm -rf "$stage"
          mkdir -p "$stage"
          cp -f "target/release/x07up" "$stage/x07up"
          chmod 0755 "$stage/x07up"
          tar -czf "$out" -C "$stage" x07up

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: x07-${{ github.ref_name }}-${{ matrix.os }}
          path: |
            dist/x07-${{ github.ref_name }}-*.tar.gz
            dist/x07up-${{ github.ref_name }}-*.tar.gz

  build-linux-aarch64:
    name: release / build-linux-aarch64
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    env:
      X07_PYTHON: python3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust (rust-toolchain.toml)
        uses: dtolnay/rust-toolchain@stable

      - name: Install cross (aarch64)
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Build and package (aarch64)
        shell: bash
        run: |
          set -euo pipefail

          tag="${GITHUB_REF_NAME}"
          target="aarch64-unknown-linux-gnu"

          cross build --release --target "$target" -p x07 -p x07c -p x07-host-runner -p x07-os-runner -p x07-vm-launcher -p x07-vm-reaper -p x07import-cli -p x07up

          export X07_CARGO=cross
          export X07_CARGO_TARGET="$target"

          ./scripts/build_ext_regex.sh
          ./scripts/build_ext_fs.sh
          ./scripts/build_ext_stdio.sh
          ./scripts/build_ext_rand.sh
          ./scripts/build_ext_math.sh
          ./scripts/build_ext_stream_xf.sh
          ./scripts/build_ext_time.sh
          ./scripts/build_ext_db_sqlite.sh
          ./scripts/build_ext_db_pg.sh
          ./scripts/build_ext_db_mysql.sh
          ./scripts/build_ext_db_redis.sh

          mkdir -p dist
          scripts/build_toolchain_tarball.sh --tag "$tag" --platform Linux --target-dir "target/${target}" --out "dist/x07-${tag}-${target}.tar.gz"

          stage="dist/.tmp_x07up_${tag}_${target}"
          rm -rf "$stage"
          mkdir -p "$stage"
          cp -f "target/${target}/release/x07up" "$stage/x07up"
          chmod 0755 "$stage/x07up"
          tar -czf "dist/x07up-${tag}-${target}.tar.gz" -C "$stage" x07up

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: x07-${{ github.ref_name }}-linux-aarch64
          path: |
            dist/x07-${{ github.ref_name }}-*.tar.gz
            dist/x07up-${{ github.ref_name }}-*.tar.gz

  guest-runner-image:
    name: release / guest-runner-image
    runs-on: ubuntu-latest
    timeout-minutes: 120
    needs:
      - build-matrix
      - build-linux-aarch64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push guest runner image
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME#v}"
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -f ci/x07-guest-runner/Dockerfile \
            -t "ghcr.io/x07lang/x07-guest-runner:${tag}" \
            --push \
            .

  publish:
    name: release / publish
    runs-on: ubuntu-latest
    needs:
      - build-matrix
      - build-linux-aarch64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten toolchain artifacts
        shell: bash
        run: |
          set -euo pipefail
          files=()
          while IFS= read -r -d '' f; do
            files+=("$f")
          done < <(find dist -type f \( -name 'x07-*.tar.gz' -o -name 'x07up-*.tar.gz' \) -print0)

          for f in "${files[@]}"; do
            base="$(basename "$f")"
            cp -f "$f" "dist/$base"
          done

      - name: Build release manifest
        run: python3 scripts/build_release_manifest.py --out dist/release-manifest.json

      - name: Build skills pack
        run: python3 scripts/build_skills_pack.py --tag "${{ github.ref_name }}" --out "dist/x07-skills-${{ github.ref_name }}.tar.gz"

      - name: Build docs bundle
        run: python3 scripts/build_docs_bundle.py --tag "${{ github.ref_name }}"

      - name: Build channels manifest (install)
        run: python3 scripts/build_channels_json.py --tag "${{ github.ref_name }}" --out dist/channels.json

      - name: Publish GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          tag="${GITHUB_REF_NAME}"

          if ! gh release view "$tag" >/dev/null 2>&1; then
            gh release create "$tag" --title "$tag" --generate-notes --verify-tag
          fi

          files=()
          while IFS= read -r -d '' f; do
            files+=("$f")
          done < <(find dist -maxdepth 1 -type f \( -name 'x07-*.tar.gz' -o -name 'x07up-*.tar.gz' -o -name 'release-manifest.json' -o -name 'channels.json' \) -print0)

          if (( ${#files[@]} == 0 )); then
            echo "ERROR: no release assets found under dist/" >&2
            exit 2
          fi

          gh release upload "$tag" "${files[@]}" --clobber
