name: adoption-gate

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  linux:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Install deps (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang \
            build-essential \
            pkg-config \
            libssl-dev \
            libcurl4-openssl-dev \
            zlib1g-dev \
            libsqlite3-dev \
            python3 \
            python3-venv
      - name: Canaries
        shell: bash
        run: ./scripts/ci/check_canaries.sh
      - name: Installer smoke
        shell: bash
        run: ./scripts/ci/check_installer_smoke.sh
      - name: Package contracts
        run: python3 scripts/check_pkg_contracts.py --check

  debian:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container:
      image: debian:bookworm
    steps:
      - uses: actions/checkout@v4
      - name: Install deps (Debian)
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            bash \
            build-essential \
            ca-certificates \
            clang \
            curl \
            git \
            libcurl4-openssl-dev \
            libssl-dev \
            openssl \
            pkg-config \
            python3 \
            python3-venv \
            xz-utils \
            zlib1g-dev
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Canaries (Debian)
        shell: bash
        run: ./scripts/ci/check_canaries.sh

  windows:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build (smoke)
        run: cargo build -p x07 -p x07c -p x07-os-runner -p x07-host-runner
      - name: Installer smoke (Windows)
        shell: pwsh
        run: ./scripts/ci/check_installer_smoke_windows.ps1

  macos:
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Canaries (macOS subset)
        shell: bash
        run: ./scripts/ci/check_canaries.sh

  adoption:
    runs-on: ubuntu-latest
    needs: [linux, debian, windows, macos]
    steps:
      - name: Gate
        run: echo "adoption-gate passed"
