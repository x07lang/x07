name: CI (WSL2)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *"

permissions:
  contents: read

jobs:
  wsl2:
    name: wsl2-ubuntu
    runs-on: windows-2022
    timeout-minutes: 105
    defaults:
      run:
        shell: wsl-bash {0}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up WSL2 (Ubuntu-24.04)
        uses: Vampire/setup-wsl@v6
        with:
          distribution: Ubuntu-24.04
          update: "true"
          additional-packages: >-
            bash
            build-essential
            ca-certificates
            clang
            curl
            git
            openssl
            libcurl4-openssl-dev
            libsqlite3-dev
            libssl-dev
            pkg-config
            python3
            python3-venv
            xz-utils
            zlib1g-dev

      - name: Set up Rust (stable, WSL2)
        run: |
          set -euo pipefail
          if ! command -v cargo >/dev/null 2>&1; then
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs \
              | sh -s -- -y --profile minimal --default-toolchain stable
          fi

          . "$HOME/.cargo/env"
          rustup component add rustfmt clippy

      - name: CI gate (WSL2 Ubuntu-24.04)
        run: |
          set -euo pipefail

          workspace="$(pwd)"
          sha="$(git -C "$workspace" rev-parse HEAD)"

          . "$HOME/.cargo/env"

          rm -rf /root/evolang-wsl
          git clone --no-checkout "$workspace" /root/evolang-wsl
          cd /root/evolang-wsl
          git checkout "$sha"

          bash ./scripts/ci/check_all.sh
