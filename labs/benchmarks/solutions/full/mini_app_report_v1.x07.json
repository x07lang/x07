{"decls":[{"kind":"defn","name":"main.rr_fetch_bytes_v1","params":[{"name":"key","ty":"bytes_view"}],"result":"bytes","body":["begin",["let","h",["std.rr.current_v1"]],["let","entry_res",["std.rr.next_v1","h",["bytes.lit","rr"],["bytes.lit","std.rr.fetch_v1"],"key"]],["let","code",["result_bytes.err_code","entry_res"]],["if",["!=","code",0],["bytes.alloc",0],["begin",["let","entry",["result_bytes.unwrap_or","entry_res",["bytes.alloc",0]]],["std.rr.entry_resp_v1",["bytes.view","entry"]]]]]},{"body":["begin",["let","nh",["bytes.len","hay"]],["let","nn",["bytes.len","needle"]],["if",["=","nn",0],["return",0],0],["let","off",0],["let","count",0],["for","_",0,["+","nh",1],["begin",["if",[">=u","off","nh"],["return","count"],0],["let","sub",["bytes.slice","hay","off",["-","nh","off"]]],["let","idx",["std.regex-lite.find_literal","sub","needle"]],["if",["<","idx",0],["return","count"],["begin",["set","count",["+","count",1]],["set","off",["+","off",["+","idx","nn"]]],0]]]],"count"],"kind":"defn","name":"main.count_nonoverlap_literal","params":[{"name":"hay","ty":"bytes_view"},{"name":"needle","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","nk",["bytes.len","key"]],["let","needle",["bytes.alloc",["+","nk",2]]],["set","needle",["bytes.set_u8","needle",0,34]],["for","i",0,"nk",["set","needle",["bytes.set_u8","needle",["+","i",1],["bytes.get_u8","key","i"]]]],["set","needle",["bytes.set_u8","needle",["+","nk",1],34]],["let","idx",["std.regex-lite.find_literal","json","needle"]],["if",["<","idx",0],["bytes.empty"],["begin",["let","after",["+","idx",["+","nk",2]]],["let","colon",["main.find_byte_from","json","after",58]],["if",["<","colon",0],["bytes.empty"],["begin",["let","i0",["main.skip_ws","json",["+","colon",1]]],["let","open",["main.find_byte_from","json","i0",91]],["if",["<","open",0],["bytes.empty"],["begin",["let","n",["bytes.len","json"]],["let","out",["vec_u8.with_capacity",8]],["for","i",["+","open",1],"n",["begin",["let","c",["bytes.get_u8","json","i"]],["if",["=","c",93],["return",["vec_u8.into_bytes","out"]],0],["if",["if",["=","c",34],["<u",["+","i",2],"n"],0],["if",["=",["bytes.get_u8","json",["+","i",2]],34],["begin",["set","out",["vec_u8.push","out",["bytes.get_u8","json",["+","i",1]]]],0],0],0],0]],["vec_u8.into_bytes","out"]]]]]]]],"kind":"defn","name":"main.extract_json_array_1char","params":[{"name":"json","ty":"bytes_view"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","nk",["bytes.len","key"]],["let","needle",["bytes.alloc",["+","nk",2]]],["set","needle",["bytes.set_u8","needle",0,34]],["for","i",0,"nk",["set","needle",["bytes.set_u8","needle",["+","i",1],["bytes.get_u8","key","i"]]]],["set","needle",["bytes.set_u8","needle",["+","nk",1],34]],["let","idx",["std.regex-lite.find_literal","json","needle"]],["if",["<","idx",0],["bytes.empty"],["begin",["let","after",["+","idx",["+","nk",2]]],["let","colon",["main.find_byte_from","json","after",58]],["if",["<","colon",0],["bytes.empty"],["begin",["let","q",["main.skip_ws","json",["+","colon",1]]],["if",[">=u","q",["bytes.len","json"]],["bytes.empty"],["if",["!=",["bytes.get_u8","json","q"],34],["bytes.empty"],["begin",["let","start",["+","q",1]],["let","end",["main.find_byte_from","json","start",34]],["if",["<","end",0],["bytes.empty"],["bytes.slice","json","start",["-","end","start"]]]]]]]]]]],"kind":"defn","name":"main.extract_json_string_unquoted","params":[{"name":"json","ty":"bytes_view"},{"name":"key","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","needle",["bytes.alloc",8]],["set","needle",["bytes.set_u8","needle",0,34]],["set","needle",["bytes.set_u8","needle",1,110]],["set","needle",["bytes.set_u8","needle",2,97]],["set","needle",["bytes.set_u8","needle",3,109]],["set","needle",["bytes.set_u8","needle",4,101]],["set","needle",["bytes.set_u8","needle",5,34]],["set","needle",["bytes.set_u8","needle",6,58]],["set","needle",["bytes.set_u8","needle",7,34]],["let","idx",["std.regex-lite.find_literal","canon","needle"]],["if",["<","idx",0],["bytes.empty"],["begin",["let","start",["+","idx",8]],["let","n",["bytes.len","canon"]],["for","i","start","n",["if",["=",["bytes.get_u8","canon","i"],34],["return",["bytes.slice","canon","start",["-","i","start"]]],0]],["bytes.empty"]]]],"kind":"defn","name":"main.extract_name_or_empty","params":[{"name":"canon","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["bytes.len","b"]],["for","i","start","n",["if",["=",["bytes.get_u8","b","i"],"target"],["return","i"],0]],-1],"kind":"defn","name":"main.find_byte_from","params":[{"name":"b","ty":"bytes_view"},{"name":"start","ty":"i32"},{"name":"target","ty":"i32"}],"result":"i32"},{"body":["if",["=","c",32],1,["if",["=","c",10],1,["if",["=","c",13],1,["if",["=","c",9],1,0]]]],"kind":"defn","name":"main.is_ws","params":[{"name":"c","ty":"i32"}],"result":"i32"},{"body":["begin",["let","n",["bytes.len","b"]],["for","i","start","n",["if",["=",["main.is_ws",["bytes.get_u8","b","i"]],0],["return","i"],0]],"n"],"kind":"defn","name":"main.skip_ws","params":[{"name":"b","ty":"bytes_view"},{"name":"start","ty":"i32"}],"result":"i32"},{"body":["begin",["let","body",["main.rr_fetch_bytes_v1","key"]],["std.kv.set","cache_key","body"],["bytes.empty"]],"kind":"defasync","name":"main.fetch_cache_body","params":[{"name":"key","ty":"bytes"},{"name":"cache_key","ty":"bytes"}],"result":"bytes"},{"kind":"defn","name":"main.solve_bytes_v1","params":[{"name":"input","ty":"bytes_view"}],"result":"bytes","body":["begin",["let","config_json",["std.fs.read",["view.to_bytes","input"]]],["let","report",["main.extract_json_string_unquoted","config_json",["bytes.lit","report"]]],["let","local_scores",["main.extract_json_string_unquoted","config_json",["bytes.lit","local_scores"]]],["let","local_events",["main.extract_json_string_unquoted","config_json",["bytes.lit","local_events"]]],["let","kv_prefix",["main.extract_json_string_unquoted","config_json",["bytes.lit","kv_prefix"]]],["let","keys",["main.extract_json_array_1char","config_json",["bytes.lit","user_keys"]]],["let","seen",["set_u32.new",16]],["let","handles",["map_u32.new",16]],["let","kcount",["bytes.len","keys"]],["for","i",0,"kcount",["begin",["let","key_u8",["bytes.get_u8","keys","i"]],["if",["=",["set_u32.contains","seen","key_u8"],0],["begin",["set_u32.add","seen","key_u8"],["let","key",["bytes.alloc",1]],["set","key",["bytes.set_u8","key",0,"key_u8"]],["let","cache_key",["std.bytes.concat","kv_prefix","key"]],["let","h",["main.fetch_cache_body","key","cache_key"]],["task.spawn","h"],["map_u32.set","handles","key_u8","h"],0],0],0]],["let","joined",["set_u32.new",16]],["for","i",0,"kcount",["begin",["let","key_u8",["bytes.get_u8","keys","i"]],["if",["=",["set_u32.contains","joined","key_u8"],0],["begin",["set_u32.add","joined","key_u8"],["let","h",["map_u32.get","handles","key_u8",0]],["await","h"],0],0],0]],["let","scores_bytes",["std.fs.read","local_scores"]],["let","scores_res",["std.csv.sum_second_col_i32_status_le","scores_bytes"]],["let","score_sum",["if",["if",[">=u",["bytes.len","scores_res"],5],["=",["bytes.get_u8","scores_res",0],1],0],["codec.read_u32_le","scores_res",1],0]],["let","events_bytes",["std.fs.read","local_events"]],["let","needle_err",["bytes.alloc",15]],["set","needle_err",["bytes.set_u8","needle_err",0,34]],["set","needle_err",["bytes.set_u8","needle_err",1,108]],["set","needle_err",["bytes.set_u8","needle_err",2,101]],["set","needle_err",["bytes.set_u8","needle_err",3,118]],["set","needle_err",["bytes.set_u8","needle_err",4,101]],["set","needle_err",["bytes.set_u8","needle_err",5,108]],["set","needle_err",["bytes.set_u8","needle_err",6,34]],["set","needle_err",["bytes.set_u8","needle_err",7,58]],["set","needle_err",["bytes.set_u8","needle_err",8,34]],["set","needle_err",["bytes.set_u8","needle_err",9,101]],["set","needle_err",["bytes.set_u8","needle_err",10,114]],["set","needle_err",["bytes.set_u8","needle_err",11,114]],["set","needle_err",["bytes.set_u8","needle_err",12,111]],["set","needle_err",["bytes.set_u8","needle_err",13,114]],["set","needle_err",["bytes.set_u8","needle_err",14,34]],["let","errors",["main.count_nonoverlap_literal","events_bytes","needle_err"]],["let","out",["vec_u8.with_capacity",128]],["set","out",["vec_u8.push","out",123]],["set","out",["vec_u8.push","out",34]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","errors"]]],["set","out",["vec_u8.push","out",34]],["set","out",["vec_u8.push","out",58]],["set","out",["vec_u8.extend_bytes","out",["fmt.u32_to_dec","errors"]]],["set","out",["vec_u8.push","out",44]],["set","out",["vec_u8.push","out",34]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","names"]]],["set","out",["vec_u8.push","out",34]],["set","out",["vec_u8.push","out",58]],["set","out",["vec_u8.push","out",91]],["for","i",0,"kcount",["begin",["if",["<u",0,"i"],["set","out",["vec_u8.push","out",44]],0],["let","key_u8",["bytes.get_u8","keys","i"]],["let","key",["bytes.alloc",1]],["set","key",["bytes.set_u8","key",0,"key_u8"]],["let","cache_key",["std.bytes.concat","kv_prefix","key"]],["let","canon",["std.kv.get","cache_key"]],["let","name",["main.extract_name_or_empty","canon"]],["set","out",["vec_u8.push","out",34]],["set","out",["vec_u8.extend_bytes","out","name"]],["set","out",["vec_u8.push","out",34]],0]],["set","out",["vec_u8.push","out",93]],["set","out",["vec_u8.push","out",44]],["set","out",["vec_u8.push","out",34]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","report"]]],["set","out",["vec_u8.push","out",34]],["set","out",["vec_u8.push","out",58]],["set","out",["vec_u8.push","out",34]],["set","out",["vec_u8.extend_bytes","out","report"]],["set","out",["vec_u8.push","out",34]],["set","out",["vec_u8.push","out",44]],["set","out",["vec_u8.push","out",34]],["set","out",["vec_u8.extend_bytes","out",["bytes.lit","score_sum"]]],["set","out",["vec_u8.push","out",34]],["set","out",["vec_u8.push","out",58]],["set","out",["vec_u8.extend_bytes","out",["fmt.u32_to_dec","score_sum"]]],["set","out",["vec_u8.push","out",125]],["vec_u8.into_bytes","out"]]},{"kind":"defn","name":"main.solve_result_v1","params":[{"name":"input","ty":"bytes_view"}],"result":"result_bytes","body":["std.rr.with_policy_v1",["bytes.lit","smoke_rr_v1"],["bytes.lit","smoke.rrbin"],["i32.lit",2],["result_bytes.ok",["main.solve_bytes_v1","input"]]]}],"imports":["std.bytes","std.csv","std.fs","std.io","std.json","std.kv","std.regex-lite","std.rr","std.text.ascii"],"kind":"entry","module_id":"main","schema_version":"x07.x07ast@0.3.0","solve":["result_bytes.unwrap_or",["main.solve_result_v1","input"],["bytes.alloc",0]]}
