{"decls":[{"body":["if",["if",[">=u","c",65],["<u","c",91],0],["+","c",32],"c"],"kind":"defn","name":"main._ascii_lower","params":[{"name":"c","ty":"i32"}],"result":"i32"},{"body":["begin",["let","n",["view.len","b"]],["if",["<=","n",0],["return",0],0],["for","i",0,"n",["begin",["let","c",["view.get_u8","b","i"]],["if",["<u","c",48],["return",0],0],["if",[">=u","c",58],["return",0],0],0]],1],"kind":"defn","name":"main._is_dec_u32","params":[{"name":"b","ty":"bytes_view"}],"result":"i32"},{"body":["std.vec.extend_bytes","v","b"],"kind":"defn","name":"main.append_bytes","params":[{"name":"v","ty":"vec_u8"},{"name":"b","ty":"bytes_view"}],"result":"vec_u8"},{"body":["std.vec.push","v",10],"kind":"defn","name":"main.append_newline","params":[{"name":"v","ty":"vec_u8"}],"result":"vec_u8"},{"body":["std.vec.extend_bytes","v",["std.fmt.u32_to_dec","x"]],"kind":"defn","name":"main.append_u32","params":[{"name":"v","ty":"vec_u8"},{"name":"x","ty":"i32"}],"result":"vec_u8"},{"body":["begin",["let","mlen",["view.len","msg"]],["let","out",["vec_u8.with_capacity",["+","mlen",1]]],["set","out",["vec_u8.push","out",0]],["set","out",["vec_u8.extend_bytes","out","msg"]],["std.vec.as_bytes","out"]],"kind":"defn","name":"main.cfg_err_v1","params":[{"name":"msg","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","html"]],["let","out",["vec_u8.with_capacity",1024]],["let","found",0],["let","done",0],["for","i",0,"n",["if",["=","done",0],["begin",["if",["<","max_links",1],["set","done",1],["if",[">=u","found","max_links"],["set","done",1],0]],["if",["=","done",1],0,["begin",["if",[">=u",["+","i",4],["+","n",1]],0,["begin",["let","c0",["main._ascii_lower",["view.get_u8","html","i"]]],["if",["!=","c0",104],0,["begin",["let","c1",["main._ascii_lower",["view.get_u8","html",["+","i",1]]]],["let","c2",["main._ascii_lower",["view.get_u8","html",["+","i",2]]]],["let","c3",["main._ascii_lower",["view.get_u8","html",["+","i",3]]]],["if",["if",["if",["=","c1",114],["=","c2",101],0],["=","c3",102],0],["begin",["let","pos0",["+","i",4]],["let","pos1",["main.skip_ws_v1","html","pos0","n"]],["if",[">=u","pos1","n"],0,["begin",["if",["!=",["view.get_u8","html","pos1"],61],0,["begin",["let","pos2",["main.skip_ws_v1","html",["+","pos1",1],"n"]],["if",[">=u","pos2","n"],0,["begin",["let","q",["view.get_u8","html","pos2"]],["if",["if",["=","q",34],1,["=","q",39]],["begin",["let","start",["+","pos2",1]],["let","end",["main.find_u8_from_v1","html","start","n","q"]],["if",["<","end",0],0,["begin",["let","link",["view.slice","html","start",["-","end","start"]]],["let","norm",["main.normalize_link_v1","link","base_dir","origin","scheme_is_https"]],["if",["=",["bytes.len",["bytes.view","norm"]],0],0,["begin",["set","out",["vec_u8.extend_bytes","out",["bytes.view","norm"]]],["set","out",["vec_u8.push","out",10]],["set","found",["+","found",1]],0]],0]],0],0],0]],0]],0]],0],0],0]],0]],0]],0],0]],["std.vec.as_bytes","out"]],"kind":"defn","name":"main.extract_links_v1","params":[{"name":"html","ty":"bytes_view"},{"name":"base_dir","ty":"bytes_view"},{"name":"origin","ty":"bytes_view"},{"name":"scheme_is_https","ty":"i32"},{"name":"max_links","ty":"i32"}],"result":"bytes"},{"body":["begin",["for","i","start","end",["if",["=",["view.get_u8","b","i"],"target"],["return","i"],0]],-1],"kind":"defn","name":"main.find_u8_from_v1","params":[{"name":"b","ty":"bytes_view"},{"name":"start","ty":"i32"},{"name":"end","ty":"i32"},{"name":"target","ty":"i32"}],"result":"i32"},{"body":["begin",["let","all_b",["std.vec.as_bytes","all"]],["let","sorted",["std.set.unique_lines_sorted",["bytes.view","all_b"]]],["let","caps",["std.os.fs.spec.caps_default_v1"]],["let","w",["std.os.fs.write_all_v1",["std.bytes.copy",["bytes.view","out_path"]],"sorted","caps"]],["let","wcode",["result_i32.err_code","w"]],["if",["!=","wcode",0],["return",["begin",["let","out",["vec_u8.with_capacity",256]],["set","out",["main.append_bytes","out",["bytes.lit","ERROR:write_all_failed_code="]]],["set","out",["main.append_u32","out","wcode"]],["set","out",["main.append_bytes","out",["bytes.lit","_path="]]],["set","out",["main.append_bytes","out",["bytes.view","out_path"]]],["set","out",["main.append_newline","out"]],["std.vec.as_bytes","out"]]],0],["let","logs_b",["std.vec.as_bytes","logs"]],["begin",["let","out",["vec_u8.with_capacity",1024]],["set","out",["main.append_bytes","out",["bytes.lit","===_X07_Web_Crawler_(run-os)_==="]]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","base_url="]]],["set","out",["main.append_bytes","out",["bytes.view","base_url"]]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","origin="]]],["set","out",["main.append_bytes","out",["bytes.view","origin"]]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","max_depth="]]],["set","out",["main.append_u32","out","max_depth"]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","max_pages="]]],["set","out",["main.append_u32","out","max_pages"]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","max_concurrency="]]],["set","out",["main.append_u32","out","max_conc"]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","timeout_s="]]],["set","out",["main.append_u32","out","timeout_s"]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","max_redirects="]]],["set","out",["main.append_u32","out","max_redirects"]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","max_body_bytes="]]],["set","out",["main.append_u32","out","max_body_bytes"]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","max_links_per_page="]]],["set","out",["main.append_u32","out","max_links"]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","page_log_limit="]]],["set","out",["main.append_u32","out","log_limit"]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","pages_fetched="]]],["set","out",["main.append_u32","out","pages_fetched"]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","pages_ok="]]],["set","out",["main.append_u32","out","pages_ok"]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","bytes_downloaded="]]],["set","out",["main.append_u32","out","bytes_downloaded"]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","urls_total="]]],["set","out",["main.append_u32","out","urls_total"]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","output_path="]]],["set","out",["main.append_bytes","out",["bytes.view","out_path"]]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","write_code=0"]]],["set","out",["main.append_newline","out"]],["if",[">",["bytes.len",["bytes.view","logs_b"]],0],["begin",["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.lit","---_Pages_(first_N)_---"]]],["set","out",["main.append_newline","out"]],["set","out",["main.append_bytes","out",["bytes.view","logs_b"]]],0],0],["std.vec.as_bytes","out"]]],"kind":"defn","name":"main.finish_v1","params":[{"name":"base_url","ty":"bytes"},{"name":"origin","ty":"bytes"},{"name":"out_path","ty":"bytes"},{"name":"max_depth","ty":"i32"},{"name":"max_pages","ty":"i32"},{"name":"max_conc","ty":"i32"},{"name":"timeout_s","ty":"i32"},{"name":"max_redirects","ty":"i32"},{"name":"max_body_bytes","ty":"i32"},{"name":"max_links","ty":"i32"},{"name":"log_limit","ty":"i32"},{"name":"pages_fetched","ty":"i32"},{"name":"pages_ok","ty":"i32"},{"name":"bytes_downloaded","ty":"i32"},{"name":"urls_total","ty":"i32"},{"name":"all","ty":"vec_u8"},{"name":"logs","ty":"vec_u8"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","link"]],["if",["<=","n",0],["return",["bytes.alloc",0]],0],["if",["=",["view.get_u8","link",0],35],["return",["bytes.alloc",0]],0],["if",["main.view_starts_with_ascii_nocase_v1","link",["bytes.lit","mailto:"]],["return",["bytes.alloc",0]],0],["if",["main.view_starts_with_ascii_nocase_v1","link",["bytes.lit","javascript:"]],["return",["bytes.alloc",0]],0],["if",["main.view_starts_with_ascii_nocase_v1","link",["bytes.lit","data:"]],["return",["bytes.alloc",0]],0],["let","hash",["std.bytes.find_u8","link",35]],["let","end",["if",["<","hash",0],"n","hash"]],["if",["<=","end",0],["return",["bytes.alloc",0]],0],["let","link2",["view.slice","link",0,"end"]],["if",["std.bytes.starts_with","link2",["bytes.lit","//"]],["begin",["let","scheme",["if",["!=","scheme_is_https",0],["bytes.lit","https:"],["bytes.lit","http:"]]],["let","cap",["+",["bytes.len","scheme"],["view.len","link2"]]],["let","out",["vec_u8.with_capacity","cap"]],["set","out",["vec_u8.extend_bytes","out","scheme"]],["set","out",["vec_u8.extend_bytes","out","link2"]],["let","b",["std.vec.as_bytes","out"]],["if",["std.bytes.starts_with",["bytes.view","b"],"origin"],"b",["bytes.alloc",0]]],["if",["std.bytes.starts_with","link2",["bytes.lit","http://"]],["if",["std.bytes.starts_with","link2","origin"],["view.to_bytes","link2"],["bytes.alloc",0]],["if",["std.bytes.starts_with","link2",["bytes.lit","https://"]],["if",["std.bytes.starts_with","link2","origin"],["view.to_bytes","link2"],["bytes.alloc",0]],["if",["std.bytes.starts_with","link2",["bytes.lit","/"]],["begin",["let","cap",["+",["view.len","origin"],["view.len","link2"]]],["let","out",["vec_u8.with_capacity","cap"]],["set","out",["vec_u8.extend_bytes","out","origin"]],["set","out",["vec_u8.extend_bytes","out","link2"]],["std.vec.as_bytes","out"]],["begin",["if",["main.view_starts_with_ascii_nocase_v1","link2",["bytes.lit","../"]],["return",["bytes.alloc",0]],0],["let","skip",["if",["main.view_starts_with_ascii_nocase_v1","link2",["bytes.lit","./"]],2,0]],["let","rel",["view.slice","link2","skip",["-",["view.len","link2"],"skip"]]],["let","cap",["+",["view.len","base_dir"],["view.len","rel"]]],["let","out",["vec_u8.with_capacity","cap"]],["set","out",["vec_u8.extend_bytes","out","base_dir"]],["set","out",["vec_u8.extend_bytes","out","rel"]],["let","b",["std.vec.as_bytes","out"]],["if",["std.bytes.starts_with",["bytes.view","b"],"origin"],"b",["bytes.alloc",0]]]]]]]],"kind":"defn","name":"main.normalize_link_v1","params":[{"name":"link","ty":"bytes_view"},{"name":"base_dir","ty":"bytes_view"},{"name":"origin","ty":"bytes_view"},{"name":"scheme_is_https","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","base_url",["bytes.alloc",0]],["let","out_path",["bytes.alloc",0]],["let","max_depth",1],["let","max_pages",200],["let","max_conc",8],["let","timeout_s",10],["let","max_redirects",5],["let","max_body_bytes",262144],["let","max_links",200],["let","sl",["std.text.ascii.split_lines_view","src"]],["let","slv",["bytes.view","sl"]],["let","count",["std.text.slices.count_v1","slv"]],["for","i",0,"count",["begin",["let","line0",["std.text.slices.view_at_v1","src","slv","i"]],["let","n0",["view.len","line0"]],["let","line",["if",["if",[">","n0",0],["=",["view.get_u8","line0",["-","n0",1]],13],0],["view.slice","line0",0,["-","n0",1]],"line0"]],["let","n",["view.len","line"]],["let","pos0",["main.skip_ws_v1","line",0,"n"]],["if",[">=u","pos0","n"],0,["if",["=",["view.get_u8","line","pos0"],35],0,["begin",["let","colon",["main.find_u8_from_v1","line","pos0","n",58]],["if",["<","colon",0],0,["begin",["let","key_end",["main.trim_end_ws_v1","line","pos0","colon"]],["if",["<=","key_end","pos0"],0,["begin",["let","key",["view.slice","line","pos0",["-","key_end","pos0"]]],["let","val_start",["main.skip_ws_v1","line",["+","colon",1],"n"]],["let","val_end0",["main.trim_end_ws_v1","line","val_start","n"]],["let","val0",["view.slice","line","val_start",["-","val_end0","val_start"]]],["let","vlen",["view.len","val0"]],["let","val",["if",["if",[">=u","vlen",2],["if",["=",["view.get_u8","val0",0],34],["=",["view.get_u8","val0",["-","vlen",1]],34],0],0],["view.slice","val0",1,["-","vlen",2]],"val0"]],["if",["bytes.eq","key",["bytes.lit","base_url"]],["begin",["set","base_url",["view.to_bytes","val"]],0],["if",["bytes.eq","key",["bytes.lit","output_path"]],["begin",["set","out_path",["view.to_bytes","val"]],0],["if",["bytes.eq","key",["bytes.lit","max_depth"]],["set","max_depth",["main.parse_opt_u32_default","val",1]],["if",["bytes.eq","key",["bytes.lit","max_pages"]],["set","max_pages",["main.parse_opt_u32_default","val",200]],["if",["bytes.eq","key",["bytes.lit","max_concurrency"]],["set","max_conc",["main.parse_opt_u32_default","val",8]],["if",["bytes.eq","key",["bytes.lit","timeout_s"]],["set","timeout_s",["main.parse_opt_u32_default","val",10]],["if",["bytes.eq","key",["bytes.lit","max_redirects"]],["set","max_redirects",["main.parse_opt_u32_default","val",5]],["if",["bytes.eq","key",["bytes.lit","max_body_bytes"]],["set","max_body_bytes",["main.parse_opt_u32_default","val",262144]],["if",["bytes.eq","key",["bytes.lit","max_links_per_page"]],["set","max_links",["main.parse_opt_u32_default","val",200]],0]]]]]]]]],0]]]]]]]]],["if",["=",["bytes.len","base_url"],0],["return",["main.cfg_err_v1",["bytes.lit","ERROR:missing_base_url"]]],0],["if",["=",["bytes.len","out_path"],0],["return",["main.cfg_err_v1",["bytes.lit","ERROR:missing_output_path"]]],0],["if",["<","max_depth",0],["return",["main.cfg_err_v1",["bytes.lit","ERROR:invalid_max_depth"]]],0],["if",["<","max_pages",0],["return",["main.cfg_err_v1",["bytes.lit","ERROR:invalid_max_pages"]]],0],["if",["<","max_conc",0],["return",["main.cfg_err_v1",["bytes.lit","ERROR:invalid_max_concurrency"]]],0],["if",["<","timeout_s",0],["return",["main.cfg_err_v1",["bytes.lit","ERROR:invalid_timeout_s"]]],0],["if",["<","max_redirects",0],["return",["main.cfg_err_v1",["bytes.lit","ERROR:invalid_max_redirects"]]],0],["if",["<","max_body_bytes",0],["return",["main.cfg_err_v1",["bytes.lit","ERROR:invalid_max_body_bytes"]]],0],["if",["<","max_links",0],["return",["main.cfg_err_v1",["bytes.lit","ERROR:invalid_max_links_per_page"]]],0],["if",["<","max_pages",1],["set","max_pages",200],0],["if",["<","max_conc",1],["set","max_conc",8],0],["if",["<","timeout_s",1],["set","timeout_s",10],0],["if",["<","max_body_bytes",1],["set","max_body_bytes",262144],0],["if",["<","max_links",1],["set","max_links",200],0],["let","base_len",["bytes.len","base_url"]],["let","out_len",["bytes.len","out_path"]],["let","cap",["+",["+",37,"base_len"],"out_len"]],["let","out",["vec_u8.with_capacity","cap"]],["set","out",["vec_u8.push","out",1]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le","max_depth"]]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le","max_pages"]]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le","max_conc"]]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le","timeout_s"]]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le","max_redirects"]]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le","max_body_bytes"]]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le","max_links"]]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le","base_len"]]],["set","out",["vec_u8.extend_bytes","out","base_url"]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le","out_len"]]],["set","out",["vec_u8.extend_bytes","out","out_path"]],["std.vec.as_bytes","out"]],"kind":"defn","name":"main.parse_config_simple_yaml_v1","params":[{"name":"src","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["if",["=",["view.len","b"],0],["return","default"],0],["if",["=",["main._is_dec_u32","b"],0],["return",-1],0],["std.parse.u32_dec","b"]],"kind":"defn","name":"main.parse_opt_u32_default","params":[{"name":"b","ty":"bytes_view"},{"name":"default","ty":"i32"}],"result":"i32"},{"body":["begin",["for","i","pos","end",["begin",["let","c",["view.get_u8","b","i"]],["if",["if",["if",["=","c",32],1,["=","c",9]],1,["if",["=","c",10],1,["=","c",13]]],0,["return","i"]],0]],"end"],"kind":"defn","name":"main.skip_ws_v1","params":[{"name":"b","ty":"bytes_view"},{"name":"pos","ty":"i32"},{"name":"end","ty":"i32"}],"result":"i32"},{"body":["begin",["let","key_len",["view.len","key"]],["let","total",["view.len","set"]],["let","off",0],["for","_",0,["+","total",1],["begin",["if",[">=u","off","total"],["return",0],0],["let","klen",["std.codec.read_u32_le","set","off"]],["let","kstart",["+","off",4]],["let","next",["+","kstart","klen"]],["let","cmp",["std.bytes.cmp_range","key",0,"key_len","set","kstart","klen"]],["if",["=","cmp",0],["return",1],["if",["<","cmp",0],["return",0],0]],["set","off","next"],0]],0],"kind":"defn","name":"main.small_set_view_contains","params":[{"name":"set","ty":"bytes_view"},{"name":"key","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["if",["=",["<u","start","end"],0],["return","end"],0],["let","r","end"],["let","i",["-","end",1]],["let","done",0],["for","_","start","end",["if",["=","done",0],["if",["<","i","start"],["set","done",1],["begin",["let","c",["view.get_u8","b","i"]],["if",["if",["if",["=","c",32],1,["=","c",9]],1,["if",["=","c",10],1,["=","c",13]]],["begin",["set","r","i"],["set","i",["-","i",1]]],["set","done",1]]]],0]],"r"],"kind":"defn","name":"main.trim_end_ws_v1","params":[{"name":"b","ty":"bytes_view"},{"name":"start","ty":"i32"},{"name":"end","ty":"i32"}],"result":"i32"},{"body":["begin",["let","origin",["main.url_origin_v1","url"]],["let","origin_v",["bytes.view","origin"]],["let","origin_len",["view.len","origin_v"]],["if",["=","origin_len",0],["return",["bytes.alloc",0]],0],["let","n",["view.len","url"]],["let","last",-1],["for","i","origin_len","n",["if",["=",["view.get_u8","url","i"],47],["set","last","i"],0]],["if",["<","last",0],["begin",["let","out",["vec_u8.with_capacity",["+","origin_len",1]]],["set","out",["vec_u8.extend_bytes","out","origin_v"]],["set","out",["vec_u8.push","out",47]],["std.vec.as_bytes","out"]],["view.to_bytes",["view.slice","url",0,["+","last",1]]]]],"kind":"defn","name":"main.url_base_dir_v1","params":[{"name":"url","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["view.len","url"]],["if",["<u","n",8],["return",["bytes.alloc",0]],0],["let","start",["if",["std.bytes.starts_with","url",["bytes.lit","http://"]],7,["if",["std.bytes.starts_with","url",["bytes.lit","https://"]],8,-1]]],["if",["<","start",0],["return",["bytes.alloc",0]],0],["if",[">=u","start","n"],["return",["bytes.alloc",0]],0],["let","cut","n"],["let","pos","start"],["let","done",0],["for","_",0,"n",["if",["=","done",0],["begin",["if",[">=u","pos","n"],["set","done",1],["begin",["if",["=",["view.get_u8","url","pos"],47],["begin",["set","cut","pos"],["set","done",1]],["set","pos",["+","pos",1]]],0]],0],0]],["if",["=","cut","start"],["return",["bytes.alloc",0]],0],["view.to_bytes",["view.slice","url",0,"cut"]]],"kind":"defn","name":"main.url_origin_v1","params":[{"name":"url","ty":"bytes_view"}],"result":"bytes"},{"body":["view.len","b"],"kind":"defn","name":"main.view_len_v1","params":[{"name":"b","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","nb",["view.len","b"]],["let","np",["view.len","prefix"]],["if",["<u","nb","np"],["return",0],0],["for","i",0,"np",["begin",["let","bc",["main._ascii_lower",["view.get_u8","b","i"]]],["let","pc",["main._ascii_lower",["view.get_u8","prefix","i"]]],["if",["!=","bc","pc"],["return",0],0],0]],1],"kind":"defn","name":"main.view_starts_with_ascii_nocase_v1","params":[{"name":"b","ty":"bytes_view"},{"name":"prefix","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","base_dir",["main.url_base_dir_v1","url"]],["let","caps",["std.net.http.spec.caps_v1",1,"timeout_s","max_redirects",16384,128,"max_body_bytes"]],["let","doc",["std.net.http.client.get_v1","url","caps"]],["let","is_err",["std.net.http.client.resp_is_err_v1","doc"]],["let","status",0],["let","err_code",0],["let","body_len",0],["let","links",["bytes.alloc",0]],["if",["!=","is_err",0],["set","err_code",["std.net.http.client.resp_err_code_v1","doc"]],["begin",["set","status",["std.net.http.client.resp_status_v1","doc"]],["if",["if",[">=u","status",200],["<u","status",300],0],["begin",["let","body",["std.net.http.client.resp_body_v1","doc"]],["set","links",["main.extract_links_v1","body","base_dir","origin","scheme_is_https","max_links"]],["set","body_len",["bytes.len","body"]],0],0],0]],["let","links_len",["main.view_len_v1","links"]],["let","out",["vec_u8.with_capacity",["+",20,"links_len"]]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le",1]]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le","status"]]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le","err_code"]]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le","body_len"]]],["set","out",["vec_u8.extend_bytes","out",["std.codec.write_u32_le","links_len"]]],["set","out",["vec_u8.extend_bytes","out","links"]],["std.vec.as_bytes","out"]],"kind":"defasync","name":"main.fetch_extract_v1","params":[{"name":"url","ty":"bytes"},{"name":"origin","ty":"bytes_view"},{"name":"scheme_is_https","ty":"i32"},{"name":"timeout_s","ty":"i32"},{"name":"max_redirects","ty":"i32"},{"name":"max_body_bytes","ty":"i32"},{"name":"max_links","ty":"i32"}],"result":"bytes"}],"imports":["std.bytes","std.codec","std.fmt","std.net.http.client","std.net.http.spec","std.os.fs","std.os.fs.spec","std.parse","std.set","std.small_set","std.text.ascii","std.text.slices","std.vec"],"kind":"entry","module_id":"main","schema_version":"x07.x07ast@0.2.0","solve":["begin",["let","cfg",["main.parse_config_simple_yaml_v1","input"]],["let","cv",["bytes.view","cfg"]],["let","n",["view.len","cv"]],["if",["<u","n",1],["return",["bytes.lit","ERROR:config_doc_empty"]],0],["if",["=",["view.get_u8","cv",0],0],["return",["bytes.slice","cv",1,["-","n",1]]],0],["let","pos",1],["let","max_depth",["std.codec.read_u32_le","cv","pos"]],["set","pos",["+","pos",4]],["let","max_pages",["std.codec.read_u32_le","cv","pos"]],["set","pos",["+","pos",4]],["let","max_conc",["std.codec.read_u32_le","cv","pos"]],["set","pos",["+","pos",4]],["let","timeout_s",["std.codec.read_u32_le","cv","pos"]],["set","pos",["+","pos",4]],["let","max_redirects",["std.codec.read_u32_le","cv","pos"]],["set","pos",["+","pos",4]],["let","max_body_bytes",["std.codec.read_u32_le","cv","pos"]],["set","pos",["+","pos",4]],["let","max_links",["std.codec.read_u32_le","cv","pos"]],["set","pos",["+","pos",4]],["let","base_len",["std.codec.read_u32_le","cv","pos"]],["set","pos",["+","pos",4]],["let","base_url",["bytes.slice","cv","pos","base_len"]],["set","pos",["+","pos","base_len"]],["let","out_len",["std.codec.read_u32_le","cv","pos"]],["set","pos",["+","pos",4]],["let","out_path",["bytes.slice","cv","pos","out_len"]],["let","origin",["main.url_origin_v1",["bytes.view","base_url"]]],["if",["=",["bytes.len",["bytes.view","origin"]],0],["return",["bytes.lit","ERROR:invalid_base_url"]],0],["let","scheme_is_https",["std.bytes.starts_with",["bytes.view","origin"],["bytes.lit","https://"]]],["let","visited",["std.small_set.insert_bytes",["bytes.alloc",0],["std.bytes.copy",["bytes.view","base_url"]]]],["let","all",["vec_u8.with_capacity",4096]],["set","all",["vec_u8.extend_bytes","all",["bytes.view","base_url"]]],["set","all",["vec_u8.push","all",10]],["let","frontier_v",["vec_u8.with_capacity",1024]],["set","frontier_v",["vec_u8.extend_bytes","frontier_v",["bytes.view","base_url"]]],["set","frontier_v",["vec_u8.push","frontier_v",10]],["let","frontier",["std.vec.as_bytes","frontier_v"]],["let","urls_total",1],["let","pages_fetched",0],["let","pages_ok",0],["let","bytes_downloaded",0],["let","log_limit",50],["let","log_lines",0],["let","logs",["vec_u8.with_capacity",4096]],["let","stop_all",0],["for","depth",0,["+","max_depth",1],["if",["=","stop_all",1],0,["begin",["if",["=",["bytes.len",["bytes.view","frontier"]],0],["set","stop_all",1],0],["if",["=","stop_all",1],0,["begin",["let","sl",["std.text.ascii.split_lines_view",["bytes.view","frontier"]]],["let","slv",["bytes.view","sl"]],["let","count",["std.text.slices.count_v1","slv"]],["let","next_frontier",["vec_u8.with_capacity",4096]],["let","batch_handles",["vec_u8.with_capacity",["*","max_conc",4]]],["let","batch_urls",["vec_u8.with_capacity",4096]],["let","batch_count",0],["for","i",0,"count",["if",["=","stop_all",1],0,["begin",["if",[">=u","urls_total","max_pages"],["set","stop_all",1],0],["if",["=","stop_all",1],0,["begin",["let","url_line",["std.text.slices.view_at_v1",["bytes.view","frontier"],"slv","i"]],["if",["=",["view.len","url_line"],0],0,["begin",["let","url_b",["view.to_bytes","url_line"]],["let","h",["main.fetch_extract_v1","url_b",["bytes.view","origin"],"scheme_is_https","timeout_s","max_redirects","max_body_bytes","max_links"]],["task.spawn","h"],["set","batch_handles",["vec_u8.extend_bytes","batch_handles",["std.codec.write_u32_le","h"]]],["set","batch_urls",["vec_u8.extend_bytes","batch_urls","url_line"]],["set","batch_urls",["vec_u8.push","batch_urls",10]],["set","batch_count",["+","batch_count",1]],0]],0]],["if",["if",[">=u","batch_count","max_conc"],1,["=","i",["-","count",1]]],["begin",["let","handles_b",["std.vec.as_bytes","batch_handles"]],["let","urls_b",["std.vec.as_bytes","batch_urls"]],["let","urls_sl",["std.text.ascii.split_lines_view",["bytes.view","urls_b"]]],["let","urls_slv",["bytes.view","urls_sl"]],["for","j",0,"batch_count",["if",["=","stop_all",1],0,["begin",["let","h",["std.codec.read_u32_le",["bytes.view","handles_b"],["*","j",4]]],["let","res",["await","h"]],["let","rv",["bytes.view","res"]],["let","status",["std.codec.read_u32_le","rv",4]],["let","err_code",["std.codec.read_u32_le","rv",8]],["let","body_len",["std.codec.read_u32_le","rv",12]],["let","links_len",["std.codec.read_u32_le","rv",16]],["set","pages_fetched",["+","pages_fetched",1]],["if",["if",[">=u","status",200],["<u","status",300],0],["set","pages_ok",["+","pages_ok",1]],0],["set","bytes_downloaded",["+","bytes_downloaded","body_len"]],["if",["<","log_lines","log_limit"],["begin",["let","page_url",["std.text.slices.view_at_v1",["bytes.view","urls_b"],"urls_slv","j"]],["set","logs",["main.append_bytes","logs",["bytes.lit","depth="]]],["set","logs",["main.append_u32","logs","depth"]],["set","logs",["main.append_bytes","logs",["bytes.lit","_status="]]],["set","logs",["main.append_u32","logs","status"]],["set","logs",["main.append_bytes","logs",["bytes.lit","_err="]]],["set","logs",["main.append_u32","logs","err_code"]],["set","logs",["main.append_bytes","logs",["bytes.lit","_bytes="]]],["set","logs",["main.append_u32","logs","body_len"]],["set","logs",["main.append_bytes","logs",["bytes.lit","_url="]]],["set","logs",["main.append_bytes","logs","page_url"]],["set","logs",["main.append_newline","logs"]],["set","log_lines",["+","log_lines",1]],0],0],["let","links_v",["view.slice","rv",20,"links_len"]],["if",["=",["view.len","links_v"],0],0,["begin",["let","ls",["std.text.ascii.split_lines_view","links_v"]],["let","lsv",["bytes.view","ls"]],["let","lc",["std.text.slices.count_v1","lsv"]],["for","k",0,"lc",["if",["=","stop_all",1],0,["begin",["if",[">=u","urls_total","max_pages"],["set","stop_all",1],0],["if",["=","stop_all",1],0,["begin",["let","cand",["std.text.slices.view_at_v1","links_v","lsv","k"]],["if",["=",["view.len","cand"],0],0,["begin",["if",["=",["main.small_set_view_contains",["bytes.view","visited"],"cand"],1],0,["begin",["let","cand_b",["view.to_bytes","cand"]],["set","visited",["std.small_set.insert_bytes","visited","cand_b"]],["set","urls_total",["+","urls_total",1]],["set","all",["vec_u8.extend_bytes","all","cand"]],["set","all",["vec_u8.push","all",10]],["set","next_frontier",["vec_u8.extend_bytes","next_frontier","cand"]],["set","next_frontier",["vec_u8.push","next_frontier",10]],0]],0]],0]],0]]],0]],0]]],["set","batch_handles",["vec_u8.with_capacity",["*","max_conc",4]]],["set","batch_urls",["vec_u8.with_capacity",4096]],["set","batch_count",0],0],0],0]]],["set","frontier",["std.vec.as_bytes","next_frontier"]],0]],0]]],["main.finish_v1","base_url","origin","out_path","max_depth","max_pages","max_conc","timeout_s","max_redirects","max_body_bytes","max_links","log_limit","pages_fetched","pages_ok","bytes_downloaded","urls_total","all","logs"]]}
