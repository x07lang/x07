{"decls":[{"kind":"export","names":["std.os.process_pool.close_v1","std.os.process_pool.map_bytes_v1","std.os.process_pool.new_v1"]},{"body":["begin",["let","n",["view.len","bufs"]],["if",["<","n",4],["return",-1],0],["let","count",["codec.read_u32_le","bufs",0]],["if",["<","count",0],["return",-1],0],["if",["<","idx",0],["return",-1],0],["if",[">=u","idx","count"],["return",-1],0],["let","off",4],["for","i",0,"idx",["begin",["if",[">=u",["+","off",4],["+","n",1]],["return",-1],0],["let","len",["codec.read_u32_le","bufs","off"]],["if",["<","len",0],["return",-1],0],["let","start",["+","off",4]],["let","next",["+","start","len"]],["if",[">=u","next",["+","n",1]],["return",-1],0],["set","off","next"],0]],"off"],"kind":"defn","name":"std.os.process_pool._bufs_entry_off","params":[{"name":"bufs","ty":"bytes_view"},{"name":"idx","ty":"i32"}],"result":"i32"},{"body":["begin",["let","n",["view.len","bufs"]],["let","off",["std.os.process_pool._bufs_entry_off","bufs","idx"]],["if",["<","off",0],["return",["view.slice","bufs",0,0]],0],["if",[">=u",["+","off",4],["+","n",1]],["return",["view.slice","bufs",0,0]],0],["let","len",["codec.read_u32_le","bufs","off"]],["if",["<","len",0],["return",["view.slice","bufs",0,0]],0],["let","start",["+","off",4]],["if",[">=u",["+","start","len"],["+","n",1]],["return",["view.slice","bufs",0,0]],0],["view.slice","bufs","start","len"]],"kind":"defn","name":"std.os.process_pool._bufs_get_view","params":[{"name":"bufs","ty":"bytes_view"},{"name":"idx","ty":"i32"}],"result":"bytes_view"},{"body":["begin",["let","n0",["if",["<","n_workers",0],0,"n_workers"]],["let","v",["std.vec.with_capacity",["+",4,["*","n0",4]]]],["set","v",["std.u32.push_le","v","n0"]],["for","i",0,"n0",["begin",["set","v",["std.u32.push_le","v",0]],0]],["std.vec.as_bytes","v"]],"kind":"defn","name":"std.os.process_pool._bufs_init","params":[{"name":"n_workers","ty":"i32"}],"result":"bytes"},{"body":["begin",["let","n",["bytes.len","bufs"]],["if",["<","n",4],["return","bufs"],0],["let","bufs_v",["bytes.view","bufs"]],["let","count",["codec.read_u32_le","bufs_v",0]],["if",["<","count",0],["return",["view.to_bytes","bufs_v"]],0],["if",["<","idx",0],["return",["view.to_bytes","bufs_v"]],0],["if",[">=u","idx","count"],["return",["view.to_bytes","bufs_v"]],0],["let","new_len",["bytes.len","new_buf"]],["if",["<","new_len",0],["return",["view.to_bytes","bufs_v"]],0],["let","out",["std.vec.with_capacity",["+","n",["+","new_len",4]]]],["set","out",["std.u32.push_le","out","count"]],["let","off",4],["for","i",0,"count",["begin",["if",[">=u",["+","off",4],["+","n",1]],["return",["view.to_bytes","bufs_v"]],0],["let","len",["codec.read_u32_le","bufs_v","off"]],["if",["<","len",0],["return",["view.to_bytes","bufs_v"]],0],["let","start",["+","off",4]],["let","next",["+","start","len"]],["if",[">=u","next",["+","n",1]],["return",["view.to_bytes","bufs_v"]],0],["if",["=","i","idx"],["begin",["set","out",["std.u32.push_le","out","new_len"]],["set","out",["std.vec.extend_bytes","out",["bytes.view","new_buf"]]],0],["begin",["set","out",["std.u32.push_le","out","len"]],["set","out",["vec_u8.extend_bytes_range","out","bufs_v","start","len"]],0]],["set","off","next"],0]],["std.vec.as_bytes","out"]],"kind":"defn","name":"std.os.process_pool._bufs_set","params":[{"name":"bufs","ty":"bytes"},{"name":"idx","ty":"i32"},{"name":"new_buf","ty":"bytes"}],"result":"bytes"},{"body":["begin",["if",["<","count",0],["return",["codec.write_u32_le",0]],0],["let","blob_n",["view.len","blob"]],["let","out",["std.vec.with_capacity",["+",4,["+","blob_n",["*","count",4]]]]],["set","out",["std.u32.push_le","out","count"]],["for","i",0,"count",["begin",["let","id",["+","i",1]],["let","off",["std.btree_map.get_u32_u32_or","offsets","id",-1]],["if",["<","off",0],["return",["codec.write_u32_le",0]],0],["if",[">=u",["+","off",4],["+","blob_n",1]],["return",["codec.write_u32_le",0]],0],["let","len",["codec.read_u32_le","blob","off"]],["if",["<","len",0],["return",["codec.write_u32_le",0]],0],["let","start",["+","off",4]],["if",[">=u",["+","start","len"],["+","blob_n",1]],["return",["codec.write_u32_le",0]],0],["set","out",["std.u32.push_le","out","len"]],["set","out",["vec_u8.extend_bytes_range","out","blob","start","len"]],0]],["std.vec.as_bytes","out"]],"kind":"defn","name":"std.os.process_pool._encode_outputs_v1","params":[{"name":"count","ty":"i32"},{"name":"offsets","ty":"bytes_view"},{"name":"blob","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n",["std.os.process_pool._pool_n_workers","pool"]],["if",["<","idx",0],["return",0],0],["if",[">=u","idx","n"],["return",0],0],["codec.read_u32_le","pool",["+",8,["*","idx",4]]]],"kind":"defn","name":"std.os.process_pool._pool_handle_at","params":[{"name":"pool","ty":"bytes_view"},{"name":"idx","ty":"i32"}],"result":"i32"},{"body":["begin",["let","n",["view.len","pool"]],["if",["<","n",8],["return",0],0],["let","ver",["codec.read_u32_le","pool",0]],["if",["!=","ver",1],["return",0],0],["let","count",["codec.read_u32_le","pool",4]],["if",["<","count",0],["return",0],0],["let","need",["+",8,["*","count",4]]],["if",[">=u","need",["+","n",1]],["return",0],0],"count"],"kind":"defn","name":"std.os.process_pool._pool_n_workers","params":[{"name":"pool","ty":"bytes_view"}],"result":"i32"},{"body":["begin",["let","pool_v",["bytes.view","pool"]],["let","n",["std.os.process_pool._pool_n_workers","pool_v"]],["for","i",0,"n",["begin",["let","h",["std.os.process_pool._pool_handle_at","pool_v","i"]],["std.os.process.kill_v1","h",9],["std.os.process.drop_v1","h"],0]],1],"kind":"defn","name":"std.os.process_pool.close_v1","params":[{"name":"pool","ty":"bytes"}],"result":"i32"},{"body":["begin",["let","pool_n",["std.os.process_pool._pool_n_workers","pool"]],["if",["<u","pool_n",1],["return",["codec.write_u32_le",0]],0],["let","items_n",["view.len","items"]],["if",["<","items_n",4],["return",["codec.write_u32_le",0]],0],["let","count",["codec.read_u32_le","items",0]],["if",["<","count",0],["return",["codec.write_u32_le",0]],0],["if",["=","count",0],["return",["codec.write_u32_le",0]],0],["let","off",4],["for","i",0,"count",["begin",["if",[">=u",["+","off",4],["+","items_n",1]],["return",["codec.write_u32_le",0]],0],["let","len",["codec.read_u32_le","items","off"]],["if",["<","len",0],["return",["codec.write_u32_le",0]],0],["let","start",["+","off",4]],["let","next",["+","start","len"]],["if",[">=u","next",["+","items_n",1]],["return",["codec.write_u32_le",0]],0],["let","id",["+","i",1]],["let","w",["%","i","pool_n"]],["let","h",["std.os.process_pool._pool_handle_at","pool","w"]],["let","frame",["begin",["let","v",["std.vec.with_capacity",["+",8,"len"]]],["set","v",["std.u32.push_le","v","id"]],["set","v",["std.u32.push_le","v","len"]],["set","v",["std.vec.extend_bytes","v",["view.slice","items","start","len"]]],["std.vec.as_bytes","v"]]],["let","ok",["std.os.process.stdin_write_v1","h","frame"]],["if",["=","ok",0],["return",["codec.write_u32_le",0]],0],["set","off","next"],0]],["let","bufs",["std.os.process_pool._bufs_init","pool_n"]],["let","results_blob",["std.vec.with_capacity",["+",16,["view.len","items"]]]],["let","results_map",["std.btree_map.empty_u32_u32"]],["let","got",0],["for","spin",0,2147483647,["begin",["for","w",0,"pool_n",["begin",["let","h",["std.os.process_pool._pool_handle_at","pool","w"]],["let","chunk",["std.os.process.stdout_read_v1","h",65536]],["let","chunk_n",["bytes.len","chunk"]],["if",["=","chunk_n",0],0,["begin",["let","combined",["begin",["let","old_v",["std.os.process_pool._bufs_get_view","bufs","w"]],["std.bytes.concat","old_v",["bytes.view","chunk"]]]],["let","combined_v",["bytes.view","combined"]],["let","cn",["view.len","combined_v"]],["let","p",0],["let","done",0],["for","_",0,["+","cn",1],["if","done",0,["begin",["if",[">=u",["+","p",8],["+","cn",1]],["set","done",1],["begin",["let","id",["codec.read_u32_le","combined_v","p"]],["let","len",["codec.read_u32_le","combined_v",["+","p",4]]],["if",["|",["<","id",1],["<","len",0]],["return",["codec.write_u32_le",0]],0],["if",[">u","id","count"],["return",["codec.write_u32_le",0]],0],["let","next",["+",["+","p",8],"len"]],["if",[">=u","next",["+","cn",1]],["set","done",1],["begin",["if",["std.btree_map.contains_u32_u32","results_map","id"],["return",["codec.write_u32_le",0]],0],["let","off0",["vec_u8.len","results_blob"]],["set","results_blob",["std.u32.push_le","results_blob","len"]],["set","results_blob",["std.vec.extend_bytes","results_blob",["view.slice","combined_v",["+","p",8],"len"]]],["set","results_map",["std.btree_map.put_u32_u32","results_map","id","off0"]],["set","got",["+","got",1]],["set","p","next"],0]]]]]]],["let","left_len",["-","cn","p"]],["let","left",["view.to_bytes",["view.slice","combined_v","p","left_len"]]],["set","bufs",["std.os.process_pool._bufs_set","bufs","w","left"]],0]],0]],["if",["=","got","count"],["begin",["let","blob_bytes",["vec_u8.as_view","results_blob"]],["return",["std.os.process_pool._encode_outputs_v1","count","results_map","blob_bytes"]]],0],0]],["codec.write_u32_le",0]],"kind":"defn","name":"std.os.process_pool.map_bytes_v1","params":[{"name":"pool","ty":"bytes_view"},{"name":"items","ty":"bytes_view"}],"result":"bytes"},{"body":["begin",["let","n0",["if",["<","n_workers",0],0,"n_workers"]],["let","v",["std.vec.with_capacity",["+",8,["*","n0",4]]]],["set","v",["std.u32.push_le","v",1]],["set","v",["std.u32.push_le","v","n0"]],["for","i",0,"n0",["begin",["let","req_i",["std.brand.to_bytes_preserve_if_full_v1",["bytes.view","req"]]],["let","caps_i",["std.brand.to_bytes_preserve_if_full_v1",["bytes.view","caps"]]],["let","h",["std.os.process.spawn_piped_v1","req_i","caps_i"]],["set","v",["std.u32.push_le","v","h"]],0]],["std.vec.as_bytes","v"]],"kind":"defn","name":"std.os.process_pool.new_v1","params":[{"brand":"std.os.process.req_v1","name":"req","ty":"bytes"},{"brand":"std.os.process.caps_v1","name":"caps","ty":"bytes"},{"name":"n_workers","ty":"i32"}],"result":"bytes"}],"imports":["std.btree_map","std.bytes","std.os.process","std.u32","std.vec"],"kind":"module","module_id":"std.os.process_pool","schema_version":"x07.x07ast@0.3.0"}
